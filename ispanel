#!/usr/bin/env python3
import argparse
import logging
import os
import re
import shutil
import subprocess
import sys
import time
from datetime import datetime
from pathlib import Path

# Dil desteÄŸi iÃ§in global deÄŸiÅŸken
CURRENT_LANGUAGE = "en"  # VarsayÄ±lan dil Ä°ngilizce

# Ã‡ok dilli metinler
TEXTS = {
    "en": {
        # Ana menÃ¼
        "main_menu_title": "isPanel - Web Hosting Management Panel",
        "main_menu_options": [
            "Installation (OpenLiteSpeed + PHP 8.2/8.3 + MariaDB)",
            "Install OpenLiteSpeed Only",
            "Install MariaDB Only",
            "Add Domain",
            "Change Domain PHP Version",
            "Domain List",
            "Remove Domain",
            "Create Database",
            "Database List",
            "Delete Database",
            "Fix Virtual Host Root",
            "Fix Vhost Configuration",
            "Reset MySQL Root Password",
            "Reset OpenLiteSpeed Admin Password",
            "Port Control and Firewall Management",
            "Install SSL/HTTPS Support",
            "MariaDB Security Settings",
            "OpenLiteSpeed + PHP + MySQL Performance Optimization",
            "File Backup Menu",
            "Database Backup Menu",
            "List Backups",
            "Cron Backup Settings",
            "Repair Tools",
            "Cache Systems (Redis/Memcached/OLS Cache)",
            "System Management",
            "OLS/PHP Settings",
            "Update isPanel",
            "Exit",
        ],
        "language_selection": "Select Language / Dil SeÃ§in",
        "language_options": ["English", "TÃ¼rkÃ§e"],
        "invalid_choice": "Invalid choice. Please try again.",
        "enter_choice": "Enter your choice",
        "domain_prompt": "Enter domain name",
        "db_name_prompt": "Enter database name",
        "db_user_prompt": "Enter database username",
        "db_pass_prompt": "Enter database password",
        "success": "Operation completed successfully!",
        "error": "An error occurred:",
        "confirm_remove": "Are you sure you want to remove this domain? (y/n)",
        "confirm_delete_db": "Are you sure you want to delete this database? (y/n)",
        "php_version_prompt": "Select PHP version",
        "php_versions": ["PHP 8.2", "PHP 8.3"],
        "no_domains": "No domains found.",
        "no_databases": "No databases found.",
        "no_backups": "No backups found.",
        "domain_added": "Domain added successfully!",
        "domain_removed": "Domain removed successfully!",
        "database_created": "Database created successfully!",
        "database_deleted": "Database deleted successfully!",
        "backup_created": "Backup created successfully!",
        "password_reset": "OpenLiteSpeed admin password reset successfully!",
        "optimization_complete": "OpenLiteSpeed optimization completed!",
        "update_complete": "isPanel updated successfully!",
        "press_enter": "Press Enter to continue...",
        "goodbye": "Goodbye!",
        # Section titles
        "section_install": "INSTALL OPTIONS",
        "section_domain": "DOMAIN MANAGEMENT",
        "section_db": "DATABASE MANAGEMENT",
        "section_system": "SYSTEM MANAGEMENT",
        "section_backup": "BACKUP SYSTEM",
        "section_tools": "TOOLS",
        "section_recovery": "RECOVERY & MONITORING",
        # Cache menu labels
        "cache_install_redis": "Install Redis",
        "cache_install_memcached": "Install Memcached",
        "cache_configure_redis": "Configure Redis",
        "cache_configure_memcached": "Configure Memcached",
        "cache_toggle_domain": "Toggle OLS Cache for a Domain",
        # Prompts
        "cache_toggle_prompt": "Enable cache (e) / disable (d):",
        # MariaDB remote menu
        "mariadb_menu_title": "MariaDB Security & Remote Access",
        "mariadb_set_root": "Set/Update root password",
        "mariadb_open_remote": "Enable remote access (bind-address 0.0.0.0)",
        "mariadb_close_remote": "Disable remote access (bind-address 127.0.0.1)",
        "mariadb_add_remote_ip": "Add remote IP and grant privileges",
        "mariadb_ufw_allow": "Allow 3306 on firewall (IP/Range)",
        "mariadb_change_remote_ip": "Change remote IP (revoke old, add new)",
        "enter_selection": "Enter your selection",
        # MySQL Remote Access Menu
        "mysql_remote_menu_title": "MySQL Remote Access Management",
        "mysql_remote_check_status": "Check Remote Access Status",
        "mysql_remote_enable": "Enable Remote Access (bind-address 0.0.0.0)",
        "mysql_remote_disable": "Disable Remote Access (bind-address 127.0.0.1)",
        "mysql_remote_add_ip": "Grant Access to Specific IP",
        "mysql_remote_remove_ip": "Revoke IP Access",
        "mysql_remote_list_ips": "List Allowed IPs",
        "mysql_remote_firewall_allow": "Firewall: Allow Port 3306 for IP",
        "mysql_remote_firewall_remove": "Firewall: Remove Port 3306 for IP",
        "mysql_remote_confirm_enable": "Are you sure you want to enable remote access? (y/n)",
        "mysql_remote_confirm_disable": "Are you sure you want to disable remote access? (y/n)",
        "mysql_remote_ip_prompt": "IP Address (e.g., 192.168.1.100)",
        "mysql_remote_user_prompt": "MySQL User (default: root)",
        "mysql_remote_password_prompt": "User Password",
        "mysql_remote_database_prompt": "Database (* = all, default: *)",
        "mysql_remote_firewall_add_prompt": "Also add firewall rule? (y/n)",
        "mysql_remote_firewall_remove_prompt": "Also remove firewall rule? (y/n)",
        "mysql_remote_operation_cancelled": "Operation cancelled",
        "mysql_remote_ip_required": "IP address is required",
        "mysql_remote_password_required": "Password is required",
        "mysql_remote_invalid_choice": "Invalid choice",
        "mysql_remote_add_ip_title": "Grant MySQL Access to IP",
        "mysql_remote_remove_ip_title": "Revoke MySQL Access from IP",
        "mysql_remote_firewall_allow_title": "Firewall: Allow Port 3306 for IP",
        "mysql_remote_firewall_remove_title": "Firewall: Remove Port 3306 for IP",
        "mysql_remote_back_to_menu": "Back to Main Menu",
        "mysql_remote_press_enter": "Press Enter to continue...",
        # Cron Job Management
        "cron_menu_title": "Cron Job Management",
        "cron_list_jobs": "List All Cron Jobs",
        "cron_add_job": "Add New Cron Job",
        "cron_edit_job": "Edit Cron Job",
        "cron_delete_job": "Delete Cron Job",
        "cron_view_logs": "View Cron Logs",
        "cron_test_job": "Test Cron Job",
        "cron_enable_disable": "Enable/Disable Cron Job",
        "cron_schedule_prompt": "Schedule (e.g., '0 2 * * *' for daily at 2 AM)",
        "cron_command_prompt": "Command to execute",
        "cron_comment_prompt": "Comment/Description (optional)",
        "cron_domain_prompt": "Domain (optional, for domain-specific jobs)",
        "cron_job_added": "Cron job added successfully",
        "cron_job_deleted": "Cron job deleted successfully",
        "cron_job_updated": "Cron job updated successfully",
        "cron_job_not_found": "Cron job not found",
        "cron_no_jobs": "No cron jobs found",
        "cron_select_job": "Select cron job number",
        "cron_invalid_schedule": "Invalid schedule format",
        "cron_confirm_delete": "Are you sure you want to delete this cron job? (y/n)",
        "cron_back_to_menu": "Back to Main Menu",
        "cron_press_enter": "Press Enter to continue...",
    },
    "tr": {
        # Ana menÃ¼
        "main_menu_title": "isPanel - Web Hosting YÃ¶netim Paneli",
        "main_menu_options": [
            "Kurulum (OpenLiteSpeed + PHP 8.2/8.3 + MariaDB)",
            "Sadece OpenLiteSpeed Kur",
            "Sadece MariaDB Kur",
            "Domain Ekle",
            "Domain PHP SÃ¼rÃ¼mÃ¼ DeÄŸiÅŸtir",
            "Domain Listesi",
            "Domain Sil",
            "VeritabanÄ± OluÅŸtur",
            "VeritabanÄ± Listesi",
            "VeritabanÄ± Sil",
            "Virtual Host Root DÃ¼zelt",
            "Vhost KonfigÃ¼rasyon DÃ¼zelt",
            "MySQL Root Åžifre SÄ±fÄ±rla",
            "OpenLiteSpeed Admin Åžifre SÄ±fÄ±rla",
            "Port KontrolÃ¼ ve Firewall YÃ¶netimi",
            "SSL/HTTPS DesteÄŸi Kur",
            "MariaDB GÃ¼venlik AyarlarÄ±",
            "OpenLiteSpeed + PHP + MySQL Performans Optimizasyonu",
            "Dosya Yedekleme MenÃ¼sÃ¼",
            "VeritabanÄ± Yedekleme MenÃ¼sÃ¼",
            "Yedekleri Listele",
            "Cron Backup AyarlarÄ±",
            "OnarÄ±m AraÃ§larÄ±",
            "Cache Sistemleri (Redis/Memcached/OLS Cache)",
            "Sistem YÃ¶netimi",
            "OLS/PHP AyarlarÄ±",
            "isPanel GÃ¼ncelle",
            "Ã‡Ä±kÄ±ÅŸ",
        ],
        "language_selection": "Select Language / Dil SeÃ§in",
        "language_options": ["English", "TÃ¼rkÃ§e"],
        "invalid_choice": "GeÃ§ersiz seÃ§im. LÃ¼tfen tekrar deneyin.",
        "enter_choice": "SeÃ§iminizi girin",
        "domain_prompt": "Domain adÄ±nÄ± girin",
        "db_name_prompt": "VeritabanÄ± adÄ±nÄ± girin",
        "db_user_prompt": "VeritabanÄ± kullanÄ±cÄ± adÄ±nÄ± girin",
        "db_pass_prompt": "VeritabanÄ± ÅŸifresini girin",
        "success": "Ä°ÅŸlem baÅŸarÄ±yla tamamlandÄ±!",
        "error": "Bir hata oluÅŸtu:",
        "confirm_remove": "Bu domaini silmek istediÄŸinizden emin misiniz? (e/h)",
        "confirm_delete_db": "Bu veritabanÄ±nÄ± silmek istediÄŸinizden emin misiniz? (e/h)",
        "php_version_prompt": "PHP sÃ¼rÃ¼mÃ¼nÃ¼ seÃ§in",
        "php_versions": ["PHP 8.2", "PHP 8.3"],
        "no_domains": "Domain bulunamadÄ±.",
        "no_databases": "VeritabanÄ± bulunamadÄ±.",
        "no_backups": "Yedek bulunamadÄ±.",
        "domain_added": "Domain baÅŸarÄ±yla eklendi!",
        "domain_removed": "Domain baÅŸarÄ±yla silindi!",
        "database_created": "VeritabanÄ± baÅŸarÄ±yla oluÅŸturuldu!",
        "database_deleted": "VeritabanÄ± baÅŸarÄ±yla silindi!",
        "backup_created": "Yedek baÅŸarÄ±yla oluÅŸturuldu!",
        "password_reset": "OpenLiteSpeed admin ÅŸifresi baÅŸarÄ±yla sÄ±fÄ±rlandÄ±!",
        "optimization_complete": "OpenLiteSpeed optimizasyonu tamamlandÄ±!",
        "update_complete": "isPanel baÅŸarÄ±yla gÃ¼ncellendi!",
        "press_enter": "Devam etmek iÃ§in Enter'a basÄ±n...",
        "goodbye": "HoÅŸÃ§a kalÄ±n!",
        # Section titles
        "section_install": "KURULUM SEÃ‡ENEKLERÄ°",
        "section_domain": "DOMAIN YÃ–NETÄ°MÄ°",
        "section_db": "VERÄ°TABANI YÃ–NETÄ°MÄ°",
        "section_system": "SÄ°STEM YÃ–NETÄ°MÄ°",
        "section_backup": "YEDEKLEME SÄ°STEMÄ°",
        "section_tools": "ARAÃ‡LAR",
        "section_recovery": "KURTARMA VE Ä°ZLEME",
        # Cache menÃ¼ baÅŸlÄ±klarÄ±
        "cache_install_redis": "Redis Kur",
        "cache_install_memcached": "Memcached Kur",
        "cache_configure_redis": "Redis YapÄ±landÄ±r",
        "cache_configure_memcached": "Memcached YapÄ±landÄ±r",
        "cache_toggle_domain": "Domain iÃ§in OLS Cache aÃ§/kapat",
        # Ä°stemler
        "cache_toggle_prompt": "Cache'i etkinleÅŸtir (e) / devre dÄ±ÅŸÄ± bÄ±rak (d):",
        # MariaDB remote menÃ¼
        "mariadb_menu_title": "MariaDB GÃ¼venlik ve Uzak EriÅŸim",
        "mariadb_set_root": "Root ÅŸifresini ayarla/gÃ¼ncelle",
        "mariadb_open_remote": "Uzak baÄŸlantÄ±yÄ± aÃ§ (bind-address 0.0.0.0)",
        "mariadb_close_remote": "Uzak baÄŸlantÄ±yÄ± kapat (bind-address 127.0.0.1)",
        "mariadb_add_remote_ip": "Uzak IP ekle ve yetki ver",
        "mariadb_ufw_allow": "GÃ¼venlik duvarÄ±nda 3306 izin ver (IP/AralÄ±k)",
        "mariadb_change_remote_ip": "Uzak IP deÄŸiÅŸtir (eskiyi sil, yeniyi ekle)",
        "enter_selection": "SeÃ§iminizi girin",
        # MySQL Uzaktan EriÅŸim MenÃ¼sÃ¼
        "mysql_remote_menu_title": "MySQL Uzaktan EriÅŸim YÃ¶netimi",
        "mysql_remote_check_status": "Uzaktan EriÅŸim Durumunu Kontrol Et",
        "mysql_remote_enable": "Uzaktan EriÅŸimi AÃ§ (bind-address 0.0.0.0)",
        "mysql_remote_disable": "Uzaktan EriÅŸimi Kapat (bind-address 127.0.0.1)",
        "mysql_remote_add_ip": "Belirli IP'ye Ä°zin Ver",
        "mysql_remote_remove_ip": "IP Ä°znini KaldÄ±r",
        "mysql_remote_list_ips": "Ä°zin Verilen IP'leri Listele",
        "mysql_remote_firewall_allow": "Firewall: IP'ye Port 3306 Ä°zni Ver",
        "mysql_remote_firewall_remove": "Firewall: IP'nin Port 3306 Ä°znini KaldÄ±r",
        "mysql_remote_confirm_enable": "Uzaktan eriÅŸimi aÃ§mak istediÄŸinizden emin misiniz? (e/h)",
        "mysql_remote_confirm_disable": "Uzaktan eriÅŸimi kapatmak istediÄŸinizden emin misiniz? (e/h)",
        "mysql_remote_ip_prompt": "IP Adresi (Ã¶rn: 192.168.1.100)",
        "mysql_remote_user_prompt": "MySQL KullanÄ±cÄ± (varsayÄ±lan: root)",
        "mysql_remote_password_prompt": "KullanÄ±cÄ± Åžifresi",
        "mysql_remote_database_prompt": "Database (* = tÃ¼mÃ¼, varsayÄ±lan: *)",
        "mysql_remote_firewall_add_prompt": "Firewall kuralÄ± da eklensin mi? (e/h)",
        "mysql_remote_firewall_remove_prompt": "Firewall kuralÄ± da kaldÄ±rÄ±lsÄ±n mÄ±? (e/h)",
        "mysql_remote_operation_cancelled": "Ä°ÅŸlem iptal edildi",
        "mysql_remote_ip_required": "IP adresi gerekli",
        "mysql_remote_password_required": "Åžifre gerekli",
        "mysql_remote_invalid_choice": "GeÃ§ersiz seÃ§im",
        "mysql_remote_add_ip_title": "IP'ye MySQL EriÅŸim Ä°zni Ver",
        "mysql_remote_remove_ip_title": "IP'nin MySQL EriÅŸimini KaldÄ±r",
        "mysql_remote_firewall_allow_title": "Firewall: IP'ye Port 3306 Ä°zni Ver",
        "mysql_remote_firewall_remove_title": "Firewall: IP'nin Port 3306 Ä°znini KaldÄ±r",
        "mysql_remote_back_to_menu": "Ana MenÃ¼ye DÃ¶n",
        "mysql_remote_press_enter": "Devam etmek iÃ§in Enter'a basÄ±n...",
        # Cron Job YÃ¶netimi
        "cron_menu_title": "Cron Job YÃ¶netimi",
        "cron_list_jobs": "TÃ¼m Cron Job'larÄ± Listele",
        "cron_add_job": "Yeni Cron Job Ekle",
        "cron_edit_job": "Cron Job DÃ¼zenle",
        "cron_delete_job": "Cron Job Sil",
        "cron_view_logs": "Cron Log'larÄ±nÄ± GÃ¶rÃ¼ntÃ¼le",
        "cron_test_job": "Cron Job Test Et",
        "cron_enable_disable": "Cron Job Aktif/Pasif Yap",
        "cron_schedule_prompt": "Zamanlama (Ã¶rn: '0 2 * * *' gÃ¼nlÃ¼k saat 02:00)",
        "cron_command_prompt": "Ã‡alÄ±ÅŸtÄ±rÄ±lacak komut",
        "cron_comment_prompt": "AÃ§Ä±klama (opsiyonel)",
        "cron_domain_prompt": "Domain (opsiyonel, domain bazlÄ± job'lar iÃ§in)",
        "cron_job_added": "Cron job baÅŸarÄ±yla eklendi",
        "cron_job_deleted": "Cron job baÅŸarÄ±yla silindi",
        "cron_job_updated": "Cron job baÅŸarÄ±yla gÃ¼ncellendi",
        "cron_job_not_found": "Cron job bulunamadÄ±",
        "cron_no_jobs": "Cron job bulunamadÄ±",
        "cron_select_job": "Cron job numarasÄ±nÄ± seÃ§in",
        "cron_invalid_schedule": "GeÃ§ersiz zamanlama formatÄ±",
        "cron_confirm_delete": "Bu cron job'Ä± silmek istediÄŸinizden emin misiniz? (e/h)",
        "cron_back_to_menu": "Ana MenÃ¼ye DÃ¶n",
        "cron_press_enter": "Devam etmek iÃ§in Enter'a basÄ±n...",
    },
}


def get_text(key: str) -> str:
    """Mevcut dildeki metni dÃ¶ndÃ¼r"""
    return TEXTS[CURRENT_LANGUAGE].get(key, key)


def load_config():
    """KonfigÃ¼rasyon dosyasÄ±ndan ayarlarÄ± yÃ¼kle"""
    global MYSQL_ROOT_PASSWORD
    
    if ISPANEL_CONFIG_FILE.exists():
        try:
            import json
            with open(ISPANEL_CONFIG_FILE, 'r', encoding='utf-8') as f:
                config = json.load(f)
                MYSQL_ROOT_PASSWORD = config.get('mysql_root_password', '')
        except Exception as e:
            print(f"KonfigÃ¼rasyon yÃ¼klenirken hata: {e}")


def save_config():
    """Mevcut ayarlarÄ± konfigÃ¼rasyon dosyasÄ±na kaydet"""
    try:
        import json
        config = {
            'mysql_root_password': MYSQL_ROOT_PASSWORD
        }
        with open(ISPANEL_CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=2)
    except Exception as e:
        print(f"KonfigÃ¼rasyon kaydedilirken hata: {e}")


def select_language():
    """Dil seÃ§imi yap"""
    global CURRENT_LANGUAGE

    print("\n" + "=" * 60)
    print(f"ðŸŒ {get_text('language_selection')}")
    print("=" * 60)

    for i, lang in enumerate(get_text("language_options"), 1):
        print(f"{i}) {lang}")

    while True:
        try:
            choice = input(f"\n{get_text('enter_choice')} (1-2): ").strip()
            if choice == "1":
                CURRENT_LANGUAGE = "en"
                break
            elif choice == "2":
                CURRENT_LANGUAGE = "tr"
                break
            else:
                print(get_text("invalid_choice"))
        except KeyboardInterrupt:
            print(f"\n{get_text('goodbye')}")
            sys.exit(0)

    print(f"\nâœ… Language selected: {get_text('language_options')[int(choice) - 1]}")
    print("=" * 60)


try:
    from pwd import getpwuid  # type: ignore[attr-defined]
    from grp import getgrgid  # type: ignore[attr-defined]
except ImportError:  # Windows

    class _PwdStruct:
        def __init__(self, uid: int):
            self.pw_name = f"uid:{uid}"

    class _GrpStruct:
        def __init__(self, gid: int):
            self.gr_name = f"gid:{gid}"

    def getpwuid(uid: int):  # type: ignore[redefined-outer-name]
        return _PwdStruct(uid)

    def getgrgid(gid: int):  # type: ignore[redefined-outer-name]
        return _GrpStruct(gid)


def run(cmd: str, check: bool = True) -> subprocess.CompletedProcess:
    logger.debug("Komut Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor: %s", cmd)
    try:
        result = subprocess.run(cmd, shell=True, check=check, text=True, capture_output=True)
        if result.stdout:
            logger.debug("stdout: %s", result.stdout.strip())
        if result.stderr:
            logger.debug("stderr: %s", result.stderr.strip())
        return result
    except subprocess.CalledProcessError as exc:
        message = f"Komut baÅŸarÄ±sÄ±z oldu: {cmd}"
        if exc.stdout:
            logger.error("%s | stdout: %s", message, exc.stdout.strip())
        if exc.stderr:
            logger.error("%s | stderr: %s", message, exc.stderr.strip())
        if not exc.stdout and not exc.stderr:
            logger.error(message)
        raise


def require_root():
    if os.geteuid() != 0:
        logger.error("Bu komutlarÄ± root olarak Ã§alÄ±ÅŸtÄ±rÄ±n (sudo kullanÄ±n).")
        sys.exit(1)


def wait_for_apt(max_retries: int = 30, delay: int = 10):
    retries = 0
    while retries < max_retries:
        cp = subprocess.run(
            "ps aux | grep -E '(apt|apt-get)\\s' | grep -v grep | grep -v _apt",
            shell=True,
            text=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
        )
        if not cp.stdout.strip():
            return
        retries += 1
        logger.info("apt kullanÄ±mda, %s/%s bekleniyor...", retries, max_retries)
        time.sleep(delay)
    logger.error("apt kilitli gÃ¶rÃ¼nÃ¼yor. LÃ¼tfen diÄŸer apt iÅŸlemlerini kapatÄ±n.")
    sys.exit(1)


def ensure_cmd(cmd: str, pkg: str):
    if shutil.which(cmd):
        return
    wait_for_apt()
    run(f"DEBIAN_FRONTEND=noninteractive apt-get update -y")
    run(f"DEBIAN_FRONTEND=noninteractive apt-get install -y {pkg}")
    if not shutil.which(cmd):
        logger.error("Gerekli komut bulunamadÄ±: %s (paket: %s)", cmd, pkg)
        sys.exit(1)


def check_disk_space(min_gb: int = 1):
    df = shutil.disk_usage("/")
    available_gb = df.free // (1024 * 1024 * 1024)
    logger.info("BoÅŸ disk alanÄ±: %s GB", available_gb)
    if available_gb < min_gb:
        logger.error("En az %sGB boÅŸ alan gerekli.", min_gb)
        sys.exit(1)


def stop_nginx_if_running():
    """Nginx varsa tamamen kaldÄ±r"""
    try:
        # Nginx kurulu mu kontrol et
        if shutil.which("nginx"):
            print("Nginx tespit edildi, kaldÄ±rÄ±lÄ±yor...")

            # Nginx'i durdur
            run("systemctl stop nginx", check=False)
            run("systemctl disable nginx", check=False)

            # Nginx process'lerini zorla sonlandÄ±r
            run("pkill -f nginx", check=False)
            run("killall nginx", check=False)

            # Nginx'i tamamen kaldÄ±r
            run(
                "DEBIAN_FRONTEND=noninteractive apt-get remove --purge -y nginx nginx-common nginx-core",
                check=False,
            )
            run("DEBIAN_FRONTEND=noninteractive apt-get autoremove -y", check=False)

            # Nginx dizinlerini temizle
            run("rm -rf /etc/nginx", check=False)
            run("rm -rf /var/www/html", check=False)

            print("âœ… Nginx tamamen kaldÄ±rÄ±ldÄ±")

    except BaseException:
        pass  # Nginx yoksa hata verme


def install_openlitespeed_and_php(lsphp_version: str = "83"):
    logger.info("OpenLiteSpeed ve PHP %s.%s kuruluyor...", lsphp_version[0], lsphp_version[1])
    wait_for_apt()
    run("DEBIAN_FRONTEND=noninteractive apt-get update -y")
    ensure_cmd("curl", "curl")
    ensure_cmd("wget", "wget")
    # Reset admin iÃ§in gerekli baÄŸÄ±mlÄ±lÄ±k
    ensure_cmd("expect", "expect")

    # Nginx'i durdur (port Ã§akÄ±ÅŸmasÄ±nÄ± Ã¶nlemek iÃ§in)
    stop_nginx_if_running()

    # Litespeed repo
    run("wget -O - https://repo.litespeed.sh | bash", check=True)

    # Paketler
    run("DEBIAN_FRONTEND=noninteractive apt-get -y install openlitespeed", check=True)
    
    # Sadece gerekli PHP sÃ¼rÃ¼mlerini kur (8.2 ve 8.3)
    # Ã–nemli extensionlarÄ± aÃ§Ä±kÃ§a belirt
    php_extensions = [
        # Temel
        "common", "cli", "fpm",
        # VeritabanÄ±
        "mysql", "mysqli", "pgsql", "sqlite3", "pdo",
        # Web ve API
        "curl", "json", "xml", "soap", "xmlrpc",
        # GÃ¼venlik ve Åžifreleme
        "bcmath", "gmp", "mcrypt",
        # GÃ¶rsel ve Medya
        "gd", "imagick",
        # String ve Karakter
        "mbstring", "iconv", "intl",
        # Dosya ve ArÅŸiv
        "zip", "bz2",
        # Mail
        "imap",
        # Cache
        "redis", "memcached", "opcache", "apcu",
        # DiÄŸer Ã–nemli
        "ldap", "ssh2", "tidy", "xsl"
    ]
    
    php82_packages = ["lsphp82"] + [f"lsphp82-{ext}" for ext in php_extensions]
    php83_packages = ["lsphp83"] + [f"lsphp83-{ext}" for ext in php_extensions]
    
    all_packages = " ".join(php82_packages + php83_packages)
    run(
        f"DEBIAN_FRONTEND=noninteractive apt-get -y install {all_packages}",
        check=True,
    )
    
    # curl CLI aracÄ± da kurulu olmalÄ±
    run("DEBIAN_FRONTEND=noninteractive apt-get -y install curl", check=True)
    
    print("âœ… PHP extensionlarÄ± kuruldu: " + ", ".join(php_extensions))

    # VarsayÄ±lan PHP sÃ¼rÃ¼mÃ¼nÃ¼ ayarla
    global DEFAULT_LSPHP_VERSION
    DEFAULT_LSPHP_VERSION = lsphp_version

    # Hizmetleri baÅŸlat/enable
    try:
        run("systemctl enable lsws", check=False)
        run("systemctl restart lsws", check=True)
    except subprocess.CalledProcessError:
        run("/usr/local/lsws/bin/lswsctrl restart", check=True)


def generate_random_password(length: int = 16) -> str:
    """Random ÅŸifre Ã¼ret"""
    import secrets
    import string

    alphabet = string.ascii_letters + string.digits + "!@#$%^&*"
    return "".join(secrets.choice(alphabet) for _ in range(length))


def install_mariadb():
    logger.info("MariaDB kuruluyor...")
    wait_for_apt()
    run("DEBIAN_FRONTEND=noninteractive apt-get update -y")

    # MariaDB kurulumu - debconf ile otomatik kurulum
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y debconf-utils", check=True)

    # MariaDB iÃ§in debconf ayarlarÄ±
    run(
        "echo 'mariadb-server mysql-server/root_password password' | debconf-set-selections",
        check=False,
    )
    run(
        "echo 'mariadb-server mysql-server/root_password_again password' | debconf-set-selections",
        check=False,
    )

    # MariaDB kurulumu
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y mariadb-server", check=True)

    # MariaDB servisini baÅŸlat
    run("systemctl enable mariadb", check=False)
    run("systemctl start mariadb", check=True)

    # Root ÅŸifresi oluÅŸtur
    root_password = generate_random_password(20)

    try:
        # GÃ¼venli kurulum iÃ§in mysql_secure_installation eÅŸdeÄŸeri
        import shlex

        escaped_password = shlex.quote(root_password)

        # MariaDB'yi durdur
        run("systemctl stop mariadb", check=False)

        # GeÃ§ici init dosyasÄ± oluÅŸtur
        init_file = "/tmp/mariadb-init.sql"
        init_content = f"""
FLUSH PRIVILEGES;
ALTER USER 'root'@'localhost' IDENTIFIED BY '{root_password}';
DELETE FROM mysql.user WHERE User='';
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');
DROP DATABASE IF EXISTS test;
DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';
FLUSH PRIVILEGES;
"""
        Path(init_file).write_text(init_content, encoding="utf-8")

        # MariaDB'yi init dosyasÄ± ile baÅŸlat
        run(f"mysqld --init-file={init_file} &", check=False)
        time.sleep(5)

        # Init dosyasÄ±nÄ± sil
        Path(init_file).unlink()

        # MariaDB'yi normal baÅŸlat
        run("pkill mysqld", check=False)
        time.sleep(2)
        run("systemctl start mariadb", check=True)

        # Åžifreyi global deÄŸiÅŸkene kaydet
        global MYSQL_ROOT_PASSWORD
        MYSQL_ROOT_PASSWORD = root_password

        # KonfigÃ¼rasyon dosyasÄ±na kaydet
        save_config()

        print(f"âœ… MariaDB kuruldu ve yapÄ±landÄ±rÄ±ldÄ±")
        print(f"ðŸ”‘ MySQL Root Åžifresi: {root_password}")

        # Root ÅŸifresini dosyaya kaydet
        mysql_conf = Path("/root/.my.cnf")
        mysql_conf.write_text(
            f"""[client]
user=root
password={root_password}
""",
            encoding="utf-8",
        )
        mysql_conf.chmod(0o600)

    except Exception as e:
        print(f"MariaDB ÅŸifre ayarlama hatasÄ±: {e}")
        # Fallback: Åžifresiz baÄŸlan ve ayarla
        try:
            run("systemctl restart mariadb", check=True)
            # Åžifresiz dene
            run(
                f"mysql -u root -e \"ALTER USER 'root'@'localhost' IDENTIFIED BY '{root_password}';\"",
                check=False,
            )
            MYSQL_ROOT_PASSWORD = root_password
            print(f"âœ… MariaDB ÅŸifresi ayarlandÄ±: {root_password}")
        except BaseException:
            print("MariaDB ÅŸifre ayarlama baÅŸarÄ±sÄ±z. Manuel mÃ¼dahale gerekli.")
            print(f"Ã–nerilen root ÅŸifresi: {root_password}")


def ensure_root_my_cnf():
    """/root/.my.cnf dosyasÄ±nÄ± doÄŸrula; eksikse, SADECE bilinen ÅŸifre varsa oluÅŸtur (prompt yok)."""
    try:
        my_cnf = Path("/root/.my.cnf")
        if my_cnf.exists():
            content = my_cnf.read_text(encoding="utf-8", errors="ignore")
            if "password=" in content and "user=root" in content:
                return
        # Prompt ETME: sadece bellekteki veya configteki ÅŸifre ile yaz
        pwd = ""
        if MYSQL_ROOT_PASSWORD:
            pwd = MYSQL_ROOT_PASSWORD
        else:
            try:
                import json
                if ISPANEL_CONFIG_FILE.exists():
                    cfg = json.loads(ISPANEL_CONFIG_FILE.read_text(encoding="utf-8"))
                    pwd = cfg.get("mysql_root_password", "")
            except Exception:
                pwd = ""
        if not pwd:
            return  # Åžifre bilinmiyor; kurulum ilerledikten sonra tekrar Ã§aÄŸrÄ±lacak
        my_cnf.write_text(f"[client]\nuser=root\npassword={pwd}\n", encoding="utf-8")
        my_cnf.chmod(0o600)
        print("âœ… /root/.my.cnf oluÅŸturuldu/gÃ¼ncellendi")
    except Exception as e:
        print(f"âš ï¸ /root/.my.cnf doÄŸrulanamadÄ±: {e}")

def install_symlink():
    """isPanel'i /usr/local/ispanel dizinine kur ve /usr/local/bin/ispanel symlink oluÅŸtur"""

    # isPanel kurulum dizinini oluÅŸtur
    ISPANEL_HOME.mkdir(parents=True, exist_ok=True)
    ISPANEL_TEMPLATES_DIR.mkdir(parents=True, exist_ok=True)

    # Mevcut script'i bul
    current_script = Path(os.path.realpath(__file__))

    # Script'i kurulum dizinine kopyala
    target_script = ISPANEL_HOME / "ispanel"
    if current_script != target_script:
        shutil.copy2(current_script, target_script)
        os.chmod(target_script, 0o755)
        print(f"isPanel kuruldu: {target_script}")

    # Templates dizinini kopyala (sadece farklÄ± dizindeyse)
    source_templates = current_script.parent / "templates"
    if source_templates.exists() and source_templates != ISPANEL_TEMPLATES_DIR:
        ISPANEL_TEMPLATES_DIR.mkdir(parents=True, exist_ok=True)
        for template_file in source_templates.glob("*.j2"):
            target_template = ISPANEL_TEMPLATES_DIR / template_file.name
            if template_file != target_template:
                shutil.copy2(template_file, target_template)
                print(f"Template kopyalandÄ±: {target_template}")

    # /usr/local/bin/ispanel wrapper oluÅŸtur
    bin_path = Path("/usr/local/bin/ispanel")
    if bin_path.exists() or bin_path.is_symlink():
        try:
            bin_path.unlink()
        except BaseException:
            run(f"rm -f {bin_path}", check=False)

    wrapper = f"""#!/usr/bin/env python3
import os
import sys

# isPanel ana script
script_path = "{target_script}"

if not os.path.exists(script_path):
    print(f"Hata: isPanel script bulunamadÄ±: {{script_path}}")
    sys.exit(1)

# Script'i Ã§alÄ±ÅŸtÄ±r
os.execv(sys.executable, [sys.executable, script_path] + sys.argv[1:])
"""

    bin_path.parent.mkdir(parents=True, exist_ok=True)
    bin_path.write_text(wrapper, encoding="utf-8")
    os.chmod(bin_path, 0o755)
    print(f"isPanel komutu kuruldu: {bin_path}")
    print(f"Kurulum dizini: {ISPANEL_HOME}")
    print(f"Templates dizini: {ISPANEL_TEMPLATES_DIR}")


def install_openlitespeed_only():
    """Sadece OpenLiteSpeed ve PHP kurulumu"""
    require_root()
    check_disk_space(1)
    
    print("=== Sadece OpenLiteSpeed + PHP Kurulumu ===")
    
    # Port Ã§akÄ±ÅŸmalarÄ±nÄ± kontrol et
    check_port_conflicts()
    
    # Reset admin iÃ§in gerekli baÄŸÄ±mlÄ±lÄ±k
    ensure_cmd("expect", "expect")

    # OpenLiteSpeed ve PHP kurulumu
    install_openlitespeed_and_php("83")
    
    # GÃ¼venlik ve performans ayarlarÄ±
    print("\n=== GÃ¼venlik ve Performans AyarlarÄ± ===")
    manage_firewall()
    install_ssl_support()
    optimize_openlitespeed()
    cleanup_default_listeners()
    
    # PHP OPcache konfigÃ¼rasyonu
    configure_php_opcache()
    
    # Symlink oluÅŸtur
    install_symlink()
    
    print("\n=== Kurulum TamamlandÄ± ===")
    print("âœ… OpenLiteSpeed + PHP 8.2/8.3 kuruldu")
    print("âœ… Firewall ayarlarÄ± yapÄ±ldÄ±")
    print("âœ… SSL/HTTPS desteÄŸi eklendi")
    print("âœ… OpenLiteSpeed performans optimizasyonu yapÄ±ldÄ±")
    print("\nKullanÄ±m: sudo ispanel")


def install_mariadb_only():
    """Sadece MariaDB kurulumu"""
    require_root()
    check_disk_space(1)
    
    print("=== Sadece MariaDB Kurulumu ===")
    
    # MariaDB kurulumu
    install_mariadb()
    
    # GÃ¼venlik ayarlarÄ±
    print("\n=== GÃ¼venlik AyarlarÄ± ===")
    secure_mariadb()
    
    # Symlink oluÅŸtur
    install_symlink()
    
    print("\n=== Kurulum TamamlandÄ± ===")
    print("âœ… MariaDB kuruldu")
    print("âœ… MariaDB gÃ¼venlik ayarlarÄ± yapÄ±ldÄ±")
    
    # Root ÅŸifresini gÃ¶ster
    if MYSQL_ROOT_PASSWORD:
        print("\nðŸ” Ã–NEMLÄ°:")
        print(f"MySQL Root KullanÄ±cÄ±: root")
        print(f"MySQL Root Åžifresi: {MYSQL_ROOT_PASSWORD}")
        print("\nâš ï¸  Bu ÅŸifreyi gÃ¼venli bir yerde saklayÄ±n!")
    
    print("\nKullanÄ±m: sudo ispanel")


def cmd_install(args: argparse.Namespace):
    require_root()
    check_disk_space(1)

    # OS kontrolÃ¼
    with open("/etc/os-release", "r", encoding="utf-8") as f:
        osr = f.read()
    if "Ubuntu" not in osr:
        print("Bu kurulum Ubuntu 22+ iÃ§in tasarlanmÄ±ÅŸtÄ±r.", file=sys.stderr)
    
    print("=== ispanel Kurulum BaÅŸlÄ±yor ===")

    # Kurulum tipine gÃ¶re PHP sÃ¼rÃ¼mÃ¼nÃ¼ belirle
    php_version = getattr(args, "php_version", DEFAULT_LSPHP_VERSION)

    # Port Ã§akÄ±ÅŸmalarÄ±nÄ± kontrol et
    check_port_conflicts()
    
    # Temel kurulum
    install_openlitespeed_and_php(php_version)
    install_mariadb()
    # MariaDB kurulduktan sonra /root/.my.cnf'i yaz (artÄ±k ÅŸifre belli)
    ensure_root_my_cnf()
    
    # GÃ¼venlik ve performans ayarlarÄ±
    print("\n=== GÃ¼venlik ve Performans AyarlarÄ± ===")
    manage_firewall()
    install_ssl_support()
    secure_mariadb()
    optimize_openlitespeed()
    cleanup_default_listeners()  # VarsayÄ±lan 8088 listener'Ä±nÄ± temizle
    
    # PHP OPcache konfigÃ¼rasyonu
    configure_php_opcache()
    
    # Yedek dizinleri oluÅŸtur
    (ISPANEL_BACKUP_DIR / "domains").mkdir(parents=True, exist_ok=True)
    (ISPANEL_BACKUP_DIR / "databases").mkdir(parents=True, exist_ok=True)
    
    # .htaccess watcher kur
    print("\n=== .htaccess Ä°zleme Sistemi ===")
    try:
        install_htaccess_watcher()
    except Exception as e:
        print(f"âš ï¸  .htaccess watcher kurulamadÄ±: {e}")
    
    # Symlink oluÅŸtur
    install_symlink()
    
    print("\n=== Kurulum TamamlandÄ± ===")
    print(
        f"âœ… OpenLiteSpeed + PHP {DEFAULT_LSPHP_VERSION[0]}.{DEFAULT_LSPHP_VERSION[1]} + MariaDB kuruldu"
    )
    print("âœ… Firewall ayarlarÄ± yapÄ±ldÄ±")
    print("âœ… SSL/HTTPS desteÄŸi eklendi")
    print("âœ… MariaDB gÃ¼venlik ayarlarÄ± yapÄ±ldÄ±")
    print("âœ… OpenLiteSpeed performans optimizasyonu yapÄ±ldÄ±")
    print("âœ… Yedek sistemi hazÄ±r")
    print("âœ… .htaccess otomatik restart sistemi aktif")

    # Root ÅŸifresini gÃ¶ster
    if MYSQL_ROOT_PASSWORD:
        print("\nðŸ” Ã–NEMLÄ°:")
        print(f"MySQL Root KullanÄ±cÄ±: root")
        print(f"MySQL Root Åžifresi: {MYSQL_ROOT_PASSWORD}")
        print("\nâš ï¸  Bu ÅŸifreyi gÃ¼venli bir yerde saklayÄ±n!")

    print("\nKullanÄ±m: sudo ispanel")


# ---------- OpenLiteSpeed domain yÃ¶netimi ----------

LSWS_CONF_DIR = Path("/usr/local/lsws/conf")
VHOSTS_DIR = LSWS_CONF_DIR / "vhosts"
HTTPD_CONF = LSWS_CONF_DIR / "httpd_config.conf"
DOCROOT_BASE = Path("/home")
# VarsayÄ±lan lsphp sÃ¼rÃ¼mÃ¼ (menu kurulum seÃ§imine gÃ¶re gÃ¼ncellenir)
DEFAULT_LSPHP_VERSION = "83"
LOG_FILE = Path(os.environ.get("ISPANEL_LOG_FILE", "/var/log/ispanel.log"))
LOG_LEVEL = os.environ.get("ISPANEL_LOG_LEVEL", "INFO").upper()

# isPanel kurulum dizini
ISPANEL_HOME = Path("/usr/local/ispanel")
ISPANEL_TEMPLATES_DIR = ISPANEL_HOME / "templates"
ISPANEL_BACKUP_DIR = Path("/home/backup")

# MySQL root ÅŸifresi (kurulum sÄ±rasÄ±nda ayarlanÄ±r)
MYSQL_ROOT_PASSWORD = ""

# KonfigÃ¼rasyon dosyasÄ±
ISPANEL_CONFIG_FILE = ISPANEL_HOME / "config.json"

# Template dizinini belirle
TEMPLATE_DIR = Path(os.environ.get("ISPANEL_TEMPLATE_DIR", str(ISPANEL_TEMPLATES_DIR)))
VHOST_TEMPLATE = Path("vhost.conf.j2")


def configure_logging():
    if logging.getLogger().hasHandlers():
        return

    handlers = []
    try:
        LOG_FILE.parent.mkdir(parents=True, exist_ok=True)
        handlers.append(logging.FileHandler(LOG_FILE, encoding="utf-8"))
    except OSError as exc:
        print(f"Log dosyasÄ±na yazÄ±lamadÄ±: {LOG_FILE} ({exc})", file=sys.stderr)

    log_level = getattr(logging, LOG_LEVEL, logging.INFO)
    if handlers:
        logging.basicConfig(
            level=log_level,
            format="%(asctime)s [%(levelname)s] %(message)s",
            handlers=handlers,
        )
    else:
        logging.basicConfig(
            level=log_level, format="%(asctime)s [%(levelname)s] %(message)s"
        )


configure_logging()
logger = logging.getLogger("ispanel")


def reload_lsws():
    try:
        run("systemctl reload lsws", check=True)
    except subprocess.CalledProcessError:
        run("/usr/local/lsws/bin/lswsctrl restart", check=True)


def cleanup_default_listeners():
    """VarsayÄ±lan 8088 listener'Ä±nÄ± ve gereksiz konfigÃ¼rasyonlarÄ± temizle"""
    if not HTTPD_CONF.exists():
        return

    content = HTTPD_CONF.read_text(encoding="utf-8")
    original_content = content

    # 8088 portundaki Default listener'Ä± temizle
    content = re.sub(
        r"listener\s+Default\s*\{\s*address\s+\*:8088[^}]*\}",
        "",
        content,
        flags=re.DOTALL,
    )

    # Example virtualhost'u temizle
    content = re.sub(r"virtualHost\s+Example\s*\{[^}]*\}", "", content, flags=re.DOTALL)

    # EasyRailsWithSuEXEC template'ini temizle
    content = re.sub(
        r"vhTemplate\s+EasyRailsWithSuEXEC\s*\{[^}]*\}", "", content, flags=re.DOTALL
    )

    # BoÅŸ satÄ±rlarÄ± temizle
    content = re.sub(r"\n{3,}", "\n\n", content)

    if content != original_content:
        HTTPD_CONF.write_text(content, encoding="utf-8")
        print("âœ… VarsayÄ±lan listener ve gereksiz konfigÃ¼rasyonlar temizlendi")


def check_port_conflicts():
    """Port Ã§akÄ±ÅŸmalarÄ±nÄ± kontrol et ve Ã§Ã¶z"""
    print("Port Ã§akÄ±ÅŸmalarÄ± kontrol Ediliyor...")
    print("Kurulum BaÅŸladÄ±. Ä°ÅŸlem bittiginde tarafÄ±nÄ±za bilgi verilecektir.")

    # Port 80 kontrolÃ¼
    try:
        result = run("netstat -tuln | grep ':80 '", check=False)
        if result.stdout.strip():
            print("âš ï¸  Port 80 kullanÄ±mda:")
            print(result.stdout.strip())

            # Nginx kontrolÃ¼ ve tamamen durdur
            nginx_result = run("systemctl is-active nginx", check=False)
            if nginx_result.returncode == 0:
                print("Nginx Ã§alÄ±ÅŸÄ±yor, durduruluyor...")
                run("systemctl stop nginx", check=False)
                run("systemctl disable nginx", check=False)
                run("pkill -f nginx", check=False)
                run("killall nginx", check=False)
                print("âœ… Nginx tamamen durduruldu")

            # Apache kontrolÃ¼
            apache_result = run("systemctl is-active apache2", check=False)
            if apache_result.returncode == 0:
                print("Apache Ã§alÄ±ÅŸÄ±yor, durduruluyor...")
                run("systemctl stop apache2", check=False)
                run("systemctl disable apache2", check=False)
                run("pkill -f apache2", check=False)
                print("âœ… Apache durduruldu")

            # Nginx konfigÃ¼rasyonunu devre dÄ±ÅŸÄ± bÄ±rak
            nginx_conf = Path("/etc/nginx/sites-enabled/default")
            if nginx_conf.exists():
                run(f"mv {nginx_conf} {nginx_conf}.backup", check=False)
                print("âœ… Nginx default site devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±")

    except BaseException:
        pass

    # Port 443 kontrolÃ¼
    try:
        result = run("netstat -tuln | grep ':443 '", check=False)
        if result.stdout.strip():
            print("âš ï¸  Port 443 kullanÄ±mda:")
            print(result.stdout.strip())
    except BaseException:
        pass


def ensure_http_listener_mapping(domain: str):
    if not HTTPD_CONF.exists():
        print(f"BulunamadÄ±: {HTTPD_CONF}", file=sys.stderr)
        sys.exit(1)
    content = HTTPD_CONF.read_text(encoding="utf-8")

    # Ã–nce 8088 portundaki Default listener'Ä± temizle
    content = re.sub(
        r"listener\s+Default\s*\{\s*address\s+\*:8088.*?\n\}",
        "",
        content,
        flags=re.DOTALL,
    )

    # Duplicate Default listener'larÄ± temizle
    default_listeners = list(
        re.finditer(
            r"listener\s+Default\s*\{[^}]*address\s+\*:80[^}]*\}", content, re.DOTALL
        )
    )
    if len(default_listeners) > 1:
        # Ä°lkini koru, diÄŸerlerini sil
        for match in default_listeners[1:]:
            content = content.replace(match.group(0), "")

    map_block = f"map                     {domain} {domain}"
    listener_pattern = r"listener\s+Default\s*\{[^}]*address\s+\*:80[^}]*\}"
    m = re.search(listener_pattern, content, re.DOTALL)

    if not m:
        # Eksikse, Default HTTP listener'Ä± oluÅŸtur
        default_listener = f"""
listener Default {{
    address                 *:80
    secure                  0
    {map_block}
}}
"""
        content = content.rstrip() + "\n" + default_listener
        HTTPD_CONF.write_text(content, encoding="utf-8")
        return

    block = m.group(0)
    if f"map                     {domain}" in block:
        return

    new_block = block.rstrip("}\n") + f"\n    {map_block}\n}}"
    new_content = content.replace(block, new_block)
    HTTPD_CONF.write_text(new_content, encoding="utf-8")


def ensure_https_listener_mapping(domain: str):
    """HTTPS listener mapping ekle"""
    if not HTTPD_CONF.exists():
        return
    content = HTTPD_CONF.read_text(encoding="utf-8")

    # Duplicate SSL listener'larÄ± temizle
    ssl_listeners = list(
        re.finditer(
            r"listener\s+SSL\s*\{[^}]*address\s+\*:443[^}]*\}", content, re.DOTALL
        )
    )
    if len(ssl_listeners) > 1:
        # Ä°lkini koru, diÄŸerlerini sil
        for match in ssl_listeners[1:]:
            content = content.replace(match.group(0), "")

    # HTTPS listener kontrolÃ¼
    https_listener_pattern = r"listener\s+SSL\s*\{[^}]*address\s+\*:443[^}]*\}"
    m = re.search(https_listener_pattern, content, re.DOTALL)
    ssl_cert = f"/etc/letsencrypt/live/{domain}/fullchain.pem"
    ssl_key = f"/etc/letsencrypt/live/{domain}/privkey.pem"
    map_block = f"map                     {domain} {domain}"
        
    if not m:
        # HTTPS listener oluÅŸtur
        https_listener = f"""
listener SSL {{
    address                 *:443
    secure                  1
    keyFile                 {ssl_key}
    certFile                {ssl_cert}
    certChain               1
    sslProtocol             24
    ciphers                 EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
    enableECDHE             1
    renegProtection         1
    sslSessionCache         1
    sslSessionTickets       1
    enableSpdy              15
    enableQuic              1
    {map_block}
}}
"""
        content = content.rstrip() + "\n" + https_listener
        HTTPD_CONF.write_text(content, encoding="utf-8")
    else:
        # Mevcut HTTPS listener'a domain ekle
        block = m.group(0)
        if f"map                     {domain}" in block:
            return
        new_block = block.rstrip("}\n") + f"\n    {map_block}\n}}"


def load_template(template_path: Path) -> str:
    """Template dosyasÄ±nÄ± yÃ¼kle"""
    # Ana template dizini
    main_template = ISPANEL_TEMPLATES_DIR / template_path.name
    if main_template.exists():
        return main_template.read_text(encoding="utf-8")

    # Alternatif konumlarÄ± dene
    for alt_dir in [
        Path(__file__).parent / "templates",  # GeliÅŸtirme dizini
        Path("/root/ispanel/templates"),  # Eski konum
        TEMPLATE_DIR,  # Env deÄŸiÅŸkeninden gelen
    ]:
        template_file = alt_dir / template_path.name
        if template_file.exists():
            return template_file.read_text(encoding="utf-8")

    raise FileNotFoundError(f"Template bulunamadÄ±: {template_path}")


def write_vhost_conf(domain: str, docroot: Path):
    vdir = VHOSTS_DIR / domain
    vdir.mkdir(parents=True, exist_ok=True)
    vconf = vdir / "vhost.conf"

    vh_root = docroot.parent

    log_dir = vh_root / "logs"
    log_dir.mkdir(parents=True, exist_ok=True)
    (log_dir / "access.log").touch(exist_ok=True)
    (log_dir / "error.log").touch(exist_ok=True)

    cgi_dir = vh_root / "cgi-bin"
    cgi_dir.mkdir(parents=True, exist_ok=True)

    protected_dir = docroot / "protected"
    protected_dir.mkdir(parents=True, exist_ok=True)

    awstats_dir = vh_root / "awstats"
    awstats_dir.mkdir(parents=True, exist_ok=True)

    template = load_template(VHOST_TEMPLATE)
    conf = template.format(
        domain=domain, docroot=str(docroot), default_lsphp=DEFAULT_LSPHP_VERSION
    )
    conf = f"vhDomain {domain}\n" + conf

    vconf.write_text(conf, encoding="utf-8")

    # Vhost dizini izinleri
    run(f"chown -R lsadm:nogroup {vdir}", check=True)
    run(f"chmod -R 755 {vdir}", check=True)

    # Domain root ve public_html izinleri
    run(f"chown -R lsadm:nogroup {vh_root}", check=False)
    run(f"chmod 755 {vh_root}", check=False)
    run(f"chmod 755 {docroot}", check=False)

    # Dosya ve dizin izinlerini dÃ¼zelt
    run(f"find {docroot} -type f -exec chmod 644 {{}} +", check=False)
    run(f"find {docroot} -type d -exec chmod 755 {{}} +", check=False)


def ensure_virtual_host_reference(domain: str):
    """httpd_config.conf iÃ§ine virtualHost referansÄ± ekle."""
    if not HTTPD_CONF.exists():
        print(f"BulunamadÄ±: {HTTPD_CONF}", file=sys.stderr)
        sys.exit(1)
    content = HTTPD_CONF.read_text(encoding="utf-8")

    # Virtual Host Root'u da ekle
    docroot = DOCROOT_BASE / domain
    vhost_ref = (
        f"virtualHost {domain} {{\n"
        f"    vhRoot                  {docroot}\n"
        f"    configFile              conf/vhosts/{domain}/vhost.conf\n"
        f"    allowSymbolLink         1\n"
        f"    enableScript            1\n"
        f"    restrained              1\n"
        f"}}\n"
    )
    # Zaten var mÄ± kontrol et (virtualHost domain satÄ±rÄ± baz alÄ±nÄ±r)
    if re.search(rf"virtualHost\s+{re.escape(domain)}\b", content):
        return
    content = content.rstrip() + "\n\n" + vhost_ref
    HTTPD_CONF.write_text(content, encoding="utf-8")


def ensure_docroot(domain: str) -> Path:
    docroot = DOCROOT_BASE / domain / "public_html"
    docroot.mkdir(parents=True, exist_ok=True)
    index_file = docroot / "index.php"
    if not index_file.exists():
        # Profesyonel ve kurumsal default index.php oluÅŸtur
        default_content = """<?php
// isPanel - Enterprise Web Hosting Management
// https://ispanel.com
?>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $_SERVER['HTTP_HOST']; ?> - Powered by isPanel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --primary-dark: #1e3a8a;
            --success: #10b981;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-lg: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px var(--shadow-lg), 0 10px 10px -5px var(--shadow);
            padding: 4rem;
            max-width: 1024px;
            width: 95%;
            position: relative;
        }

        .accent-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 16px 16px 0 0;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .logo-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 24px;
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .domain {
            font-size: 1.875rem;
            font-weight: 300;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .subtitle {
            color: var(--text-tertiary);
            font-size: 1rem;
            font-weight: 400;
        }

        .status-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 2rem;
            margin: 2.5rem 0;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .status-icon {
            width: 56px;
            height: 56px;
            background: var(--success);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            flex-shrink: 0;
        }

        .status-content h3 {
            color: #065f46;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .status-content p {
            color: #047857;
            font-size: 0.875rem;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }

        .feature-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px var(--shadow-lg), 0 10px 10px -5px var(--shadow);
            border-color: var(--primary-light);
        }

        .feature-card:hover::before {
            transform: translateX(0);
        }

        .feature-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--primary);
        }

        .feature-card h4 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .feature-card p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .stats-section {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 2rem;
            margin: 2.5rem 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 2rem;
            text-align: center;
        }

        .stat-item {
            padding: 1rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        .tech-stack {
            margin: 2.5rem 0;
        }

        .tech-stack h4 {
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .tech-items {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .tech-badge {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .tech-badge:hover {
            border-color: var(--primary-light);
            color: var(--primary);
            transform: translateY(-2px);
        }

        .footer {
            text-align: center;
            margin-top: 4rem;
            padding-top: 2.5rem;
            border-top: 1px solid var(--border);
        }

        .footer-content {
            color: var(--text-tertiary);
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 3rem;
            flex-wrap: wrap;
        }

        .footer-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--primary-dark);
        }

        @media (max-width: 640px) {
            .container {
                padding: 2rem;
            }

            .features-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .footer-links {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="accent-bar"></div>

        <div class="header">
            <div class="logo-wrapper">
                <div class="logo-icon">iS</div>
                <div class="logo-text">isPanel</div>
            </div>
            <h1 class="domain"><?php echo $_SERVER['HTTP_HOST']; ?></h1>
            <p class="subtitle">Enterprise Web Hosting Management System</p>
        </div>

        <div class="status-section">
            <div class="status-icon">âœ“</div>
            <div class="status-content">
                <h3>System Operational</h3>
                <p>Your website is running smoothly on isPanel infrastructure with optimal performance</p>
            </div>
        </div>

        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">âš¡</div>
                <h4>High Performance</h4>
                <p>Powered by OpenLiteSpeed for lightning-fast content delivery and optimal resource usage</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ðŸ›¡ï¸</div>
                <h4>Enterprise Security</h4>
                <p>SSL certificates, advanced firewall rules, and continuous security monitoring</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ðŸŽ¯</div>
                <h4>Easy Management</h4>
                <p>Intuitive command-line interface with powerful automation capabilities</p>
            </div>
        </div>

        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value"><?php echo phpversion(); ?></div>
                    <div class="stat-label">PHP Version</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value"><?php
                        $load = sys_getloadavg();
                        echo number_format($load[0], 2);
                    ?></div>
                    <div class="stat-label">Load Average</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value"><?php
                        $uptime = shell_exec('uptime -p 2>/dev/null');
                        if ($uptime) {
                            preg_match('/(\\d+)\\s*day/', $uptime, $matches);
                            echo isset($matches[1]) ? $matches[1] : '0';
                        } else {
                            echo 'N/A';
                        }
                    ?></div>
                    <div class="stat-label">Days Uptime</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value"><?php echo date('H:i'); ?></div>
                    <div class="stat-label">Server Time</div>
                </div>
            </div>
        </div>

        <div class="tech-stack">
            <h4>Technology Stack</h4>
            <div class="tech-items">
                <div class="tech-badge">OpenLiteSpeed</div>
                <div class="tech-badge">PHP 8.2 / 8.3</div>
                <div class="tech-badge">MariaDB</div>
                <div class="tech-badge">Let's Encrypt SSL</div>
                <div class="tech-badge">Ubuntu Server</div>
                <div class="tech-badge">HTTP/3 QUIC</div>
            </div>
        </div>

        <div class="footer">
            <p class="footer-content">
                &copy; <?php echo date('Y'); ?> isPanel - Enterprise Web Hosting Management System Â· Powered by: isPanel
            </p>
            <div class="footer-links">
                <a href="https://ispanel.com" target="_blank" class="footer-link">
                    <span>ðŸŒ</span>
                    <span>Official Website</span>
                </a>
                <a href="https://github.com/ismailaydemiriu/ispanel" target="_blank" class="footer-link">
                    <span>ðŸ“¦</span>
                    <span>GitHub Repository</span>
                </a>
                <a href="https://ispanel.com/docs" target="_blank" class="footer-link">
                    <span>ðŸ“š</span>
                    <span>Documentation</span>
                </a>
            </div>
        </div>
    </div>
</body>
</html>"""
        index_file.write_text(default_content, encoding="utf-8")

    # Ä°zinleri dÃ¼zelt
    domain_root = DOCROOT_BASE / domain
    run(f"chown -R lsadm:nogroup {domain_root}", check=False)
    run(f"chmod 755 {domain_root}", check=False)
    run(f"chmod 755 {docroot}", check=False)
    run(f"find {docroot} -type f -exec chmod 644 {{}} +", check=False)
    run(f"find {docroot} -type d -exec chmod 755 {{}} +", check=False)

    return docroot


def create_ssh_user(domain: str, password: str) -> dict:
    """
    Domain iÃ§in SSH kullanÄ±cÄ±sÄ± oluÅŸtur
    Returns: dict with username, password, and home directory
    """
    # KullanÄ±cÄ± adÄ±: domain'den tÃ¼ret (nokta ve tire kaldÄ±r)
    username = re.sub(r'[^a-z0-9]', '', domain.lower())[:30]  # Max 30 karakter
    
    # KullanÄ±cÄ± zaten var mÄ± kontrol et
    result = subprocess.run(['id', username], capture_output=True, text=True)
    if result.returncode == 0:
        print(f"â„¹ï¸  SSH kullanÄ±cÄ±sÄ± zaten mevcut: {username}")
        return {
            "username": username,
            "password": password,
            "home": f"/home/{domain}"
        }
    
    try:
        # KullanÄ±cÄ± oluÅŸtur
        home_dir = DOCROOT_BASE / domain
        run(f"useradd -m -d {home_dir} -s /bin/bash -c 'Domain: {domain}' {username}", check=True)
        
        # Åžifre ayarla (chpasswd kullanarak)
        proc = subprocess.Popen(['chpasswd'], stdin=subprocess.PIPE, text=True)
        proc.communicate(f"{username}:{password}\n")
        if proc.returncode != 0:
            raise Exception("Åžifre ayarlanamadÄ±")
        
        # Home dizini izinlerini ayarla
        run(f"chown -R {username}:{username} {home_dir}", check=False)
        
        print(f"âœ… SSH kullanÄ±cÄ±sÄ± oluÅŸturuldu: {username}")
        return {
            "username": username,
            "password": password,
            "home": str(home_dir)
        }
    except Exception as e:
        print(f"âš ï¸  SSH kullanÄ±cÄ±sÄ± oluÅŸturulamadÄ±: {e}")
        return None


def create_mysql_cli_config(username: str, db_user: str, db_password: str):
    """
    SSH kullanÄ±cÄ±sÄ± iÃ§in MySQL CLI eriÅŸim yapÄ±landÄ±rmasÄ± oluÅŸtur
    """
    try:
        # KullanÄ±cÄ±nÄ±n home dizinini bul
        result = subprocess.run(['getent', 'passwd', username], capture_output=True, text=True)
        if result.returncode != 0:
            print(f"âš ï¸  KullanÄ±cÄ± bulunamadÄ±: {username}")
            return
        
        home_dir = result.stdout.split(':')[5]
        my_cnf_path = Path(home_dir) / ".my.cnf"
        
        # .my.cnf dosyasÄ± oluÅŸtur
        my_cnf_content = f"""[client]
user={db_user}
password={db_password}
host=localhost
"""
        my_cnf_path.write_text(my_cnf_content, encoding="utf-8")
        my_cnf_path.chmod(0o600)
        
        # Dosya sahibini ayarla
        run(f"chown {username}:{username} {my_cnf_path}", check=False)
        
        print(f"âœ… MySQL CLI eriÅŸimi yapÄ±landÄ±rÄ±ldÄ±: {username}")
    except Exception as e:
        print(f"âš ï¸  MySQL CLI yapÄ±landÄ±rmasÄ± oluÅŸturulamadÄ±: {e}")


def domain_add(domain: str):
    if not re.match(r"^[A-Za-z0-9.-]+$", domain):
        print("GeÃ§ersiz domain.", file=sys.stderr)
        sys.exit(1)
    if not LSWS_CONF_DIR.exists():
        print("OpenLiteSpeed kurulu deÄŸil gibi gÃ¶rÃ¼nÃ¼yor.", file=sys.stderr)
        sys.exit(1)
    
    # Nginx Ã§akÄ±ÅŸmasÄ±nÄ± kontrol et ve durdur
    stop_nginx_if_running()

    # PHP handler'larÄ± kontrol et
    ensure_php_handlers()
    
    docroot = ensure_docroot(domain)
    write_vhost_conf(domain, docroot)
    ensure_virtual_host_reference(domain)
    ensure_http_listener_mapping(domain)
    
    # SSL sertifikasÄ± oluÅŸtur (Let's Encrypt)
    if shutil.which("certbot") and os.environ.get("ISPANEL_SKIP_CERTBOT") != "1":
        try:
            print(f"SSL sertifikasÄ± oluÅŸturuluyor: {domain}")
            run(
                f"certbot certonly --standalone -d {domain} --non-interactive --agree-tos --email admin@{domain}",
                check=False,
            )
            
            # SSL konfigÃ¼rasyonunu OpenLiteSpeed'e ekle
            ssl_cert = f"/etc/letsencrypt/live/{domain}/fullchain.pem"
            ssl_key = f"/etc/letsencrypt/live/{domain}/privkey.pem"
            
            if Path(ssl_cert).exists() and Path(ssl_key).exists():
                # HTTPS listener ekle
                ensure_https_listener_mapping(domain)
                print(f"SSL sertifikasÄ± baÅŸarÄ±yla oluÅŸturuldu: {domain}")
        except BaseException:
            print(f"SSL sertifikasÄ± oluÅŸturulamadÄ±: {domain}")
    
    # PHP test dosyasÄ± oluÅŸtur
    test_file = docroot / "test.php"
    test_content = """<?php
// isPanel PHP Test
echo "<h1>PHP Ã‡alÄ±ÅŸÄ±yor!</h1>";
echo "<p>PHP Version: " . phpversion() . "</p>";
echo "<p>Server: " . $_SERVER['SERVER_SOFTWARE'] . "</p>";
echo "<p>Domain: " . $_SERVER['HTTP_HOST'] . "</p>";
echo "<hr>";
phpinfo();
?>"""
    test_file.write_text(test_content, encoding="utf-8")
    run(f"chmod 644 {test_file}", check=False)
    
    # SSH kullanÄ±cÄ±sÄ± ve MySQL CLI eriÅŸimi oluÅŸtur
    print("\n=== SSH ve MySQL CLI EriÅŸimi YapÄ±landÄ±rÄ±lÄ±yor ===")
    
    # Rastgele ÅŸifreler oluÅŸtur
    ssh_password = generate_random_password(16)
    db_password = generate_random_password(20)
    
    # SSH kullanÄ±cÄ±sÄ± oluÅŸtur
    ssh_user = create_ssh_user(domain, ssh_password)
    
    # MySQL database ve kullanÄ±cÄ± oluÅŸtur
    db_name = re.sub(r'[^a-zA-Z0-9_]', '', domain.replace('.', '_').replace('-', '_'))[:64]
    db_user = db_name[:16]  # MySQL username max 16/32 karakter (MariaDB 32)
    
    try:
        # Database oluÅŸtur
        mysql_exec(f"CREATE DATABASE IF NOT EXISTS `{db_name}`;")
        # KullanÄ±cÄ± oluÅŸtur
        mysql_exec(f"CREATE USER IF NOT EXISTS '{db_user}'@'localhost' IDENTIFIED BY '{db_password}';")
        # Yetkiler ver
        mysql_exec(f"GRANT ALL PRIVILEGES ON `{db_name}`.* TO '{db_user}'@'localhost';")
        mysql_exec("FLUSH PRIVILEGES;")
        print(f"âœ… MySQL database oluÅŸturuldu: {db_name}")
        print(f"âœ… MySQL kullanÄ±cÄ±sÄ± oluÅŸturuldu: {db_user}")
        
        # SSH kullanÄ±cÄ±sÄ± iÃ§in MySQL CLI yapÄ±landÄ±rmasÄ± oluÅŸtur
        if ssh_user:
            create_mysql_cli_config(ssh_user["username"], db_user, db_password)
    except Exception as e:
        print(f"âš ï¸  MySQL yapÄ±landÄ±rmasÄ± oluÅŸturulamadÄ±: {e}")
        db_user = None
        db_password = None
    
    reload_lsws()
    
    # Ã–zet bilgileri gÃ¶ster
    print("\n" + "="*60)
    print(f"âœ… Domain BaÅŸarÄ±yla Eklendi: {domain}")
    print("="*60)
    print(f"\nðŸ“ WEB ERÄ°ÅžÄ°MÄ°:")
    print(f"   Document root: {docroot}")
    print(f"   HTTP: http://{domain}")
    print(f"   HTTPS: https://{domain} (SSL varsa)")
    print(f"   PHP Test: http://{domain}/test.php")
    
    if ssh_user:
        print(f"\nðŸ” SSH ERÄ°ÅžÄ°MÄ°:")
        print(f"   KullanÄ±cÄ±: {ssh_user['username']}")
        print(f"   Åžifre: {ssh_password}")
        print(f"   Komut: ssh {ssh_user['username']}@SUNUCU_IP")
        print(f"   Home: {ssh_user['home']}")
    
    if db_user and db_password:
        print(f"\nðŸ’¾ MYSQL ERÄ°ÅžÄ°MÄ°:")
        print(f"   Database: {db_name}")
        print(f"   KullanÄ±cÄ±: {db_user}")
        print(f"   Åžifre: {db_password}")
        print(f"   Host: localhost")
        print(f"\n   SSH Ã¼zerinden MySQL CLI:")
        print(f"   - SSH ile baÄŸlandÄ±ktan sonra: mysql")
        print(f"   - Otomatik olarak {db_name} veritabanÄ±na baÄŸlanÄ±r")
    
    print("\nâš ï¸  Bu bilgileri gÃ¼venli bir yerde saklayÄ±n!")
    print("="*60)


def set_domain_php_version(domain: str, version: str):
    """Domain iÃ§in PHP sÃ¼rÃ¼mÃ¼nÃ¼ (82/83) ayarla"""
    vconf = VHOSTS_DIR / domain / "vhost.conf"
    if not vconf.exists():
        print("Vhost config bulunamadÄ±.", file=sys.stderr)
        return

    # vhost.conf iÃ§eriÄŸini oku
    content = vconf.read_text(encoding="utf-8")

    # scriptHandler bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¼ncelle
    content = re.sub(
        r"add\s+lsapi:lsphp\d+\s+php",
        f"add                    lsapi:lsphp{version} php",
        content,
    )

    # PHP context'ini de gÃ¼ncelle (eÄŸer varsa)
    content = re.sub(r"handler\s+lsphp\d+", f"handler lsphp{version}", content)

    vconf.write_text(content, encoding="utf-8")
    reload_lsws()
    print(f"âœ… {domain} iÃ§in PHP {version[0]}.{version[1]} olarak ayarlandÄ±.")


def toggle_http3_brotli(enable: bool):
    """HTTP/3 (QUIC) ve Brotli sÄ±kÄ±ÅŸtÄ±rmayÄ± aÃ§/kapat"""
    if not HTTPD_CONF.exists():
        print("httpd_config.conf bulunamadÄ±.", file=sys.stderr)
        return
    content = HTTPD_CONF.read_text(encoding="utf-8")
    # HTTP/3 QUIC ayarÄ± listener SSL iÃ§inde enableQuic 1/0
    content = re.sub(
        r"enableQuic\s+\d",
        f"enableQuic              {'1' if enable else '0'}",
        content,
    )
    HTTPD_CONF.write_text(content, encoding="utf-8")

    # Brotli: global conf'a ek basit bayrak (OLS'te mod_brotli yoksa gzip
    # kullanÄ±labilir; burada Ã¶rnek bayrak koyuyoruz)
    brotli_marker = "# ispanel_brotli_enabled"
    if enable:
        if brotli_marker not in content:
            with open(HTTPD_CONF, "a", encoding="utf-8") as f:
                f.write(
                    f"\n{brotli_marker}\n# Brotli etkin: statik iÃ§erik iÃ§in harici reverse proxy veya mod eklentisi gerekebilir.\n"
                )
    else:
        newc = (
            Path(HTTPD_CONF)
            .read_text(encoding="utf-8")
            .replace(brotli_marker + "\n", "")
        )
        Path(HTTPD_CONF).write_text(newc, encoding="utf-8")
    reload_lsws()
    print(f"HTTP/3 {'aÃ§Ä±ldÄ±' if enable else 'kapandÄ±'}; Brotli {'iÅŸaretlendi' if enable else 'devre dÄ±ÅŸÄ±'}.")


def ols_php_menu():
    while True:
        print("\n--- OLS/PHP AyarlarÄ± ---")
        print("1) Domain iÃ§in PHP sÃ¼rÃ¼mÃ¼ ayarla (lsphp81/82/83)")
        print("2) HTTP/3 + Brotli aÃ§")
        print("3) HTTP/3 + Brotli kapat")
        print("0) Geri")
        sub = input("SeÃ§im: ").strip()
        if sub == "1":
            domain = input("Domain: ").strip()
            version = input("SÃ¼rÃ¼m (81/82/83): ").strip()
            if version not in {"81", "82", "83"}:
                print("GeÃ§ersiz sÃ¼rÃ¼m")
            else:
                set_domain_php_version(domain, version)
        elif sub == "2":
            toggle_http3_brotli(True)
        elif sub == "3":
            toggle_http3_brotli(False)
        elif sub == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")


def domain_remove(domain: str):
    vdir = VHOSTS_DIR / domain
    if vdir.exists():
        shutil.rmtree(vdir)

    if HTTPD_CONF.exists():
        content = HTTPD_CONF.read_text(encoding="utf-8")
        # HTTP listener'dan domain mapping'i sil
        content = re.sub(
            rf"\n\s*map\s+{re.escape(domain)}:80\s+{re.escape(domain)}\s*",
            "\n",
            content,
        )
        # HTTPS listener'dan domain mapping'i sil
        content = re.sub(
            rf"\n\s*map\s+{re.escape(domain)}:443\s+{re.escape(domain)}\s*",
            "\n",
            content,
        )
        # virtualHost referansÄ±nÄ± sil
        lines = content.split("\n")
        new_lines = []
        skip_until_brace = False
        for line in lines:
            if f"virtualHost {domain}" in line:
                skip_until_brace = True
                continue
            if skip_until_brace and line.strip() == "}":
                skip_until_brace = False
                continue
            if not skip_until_brace:
                new_lines.append(line)
        content = "\n".join(new_lines)
        HTTPD_CONF.write_text(content, encoding="utf-8")
    reload_lsws()
    print(f"Domain silindi: {domain}")


# ---------- MariaDB yÃ¶netimi ----------


def mysql_exec(sql: str):
    # MySQL root ÅŸifresini gÃ¼venli ÅŸekilde kullan
    if MYSQL_ROOT_PASSWORD:
        # --password= parametresi ile ÅŸifreyi gÃ¼venli ÅŸekilde geÃ§
        run(f'mysql -uroot --password={MYSQL_ROOT_PASSWORD} -e "{sql}"', check=True)
    else:
        run(f'mysql -uroot -e "{sql}"', check=True)


def db_create(db: str, user: str, password: str):
    if not re.match(r"^[A-Za-z0-9_]+$", db):
        print("GeÃ§ersiz veritabanÄ± adÄ±.", file=sys.stderr)
        sys.exit(1)
    if not re.match(r"^[A-Za-z0-9_]+$", user):
        print("GeÃ§ersiz kullanÄ±cÄ± adÄ±.", file=sys.stderr)
        sys.exit(1)
    sql = (
        f"CREATE DATABASE IF NOT EXISTS `{db}` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; "
        f"CREATE USER IF NOT EXISTS '{user}'@'%' IDENTIFIED BY '{password}'; "
        f"GRANT ALL PRIVILEGES ON `{db}`.* TO '{user}'@'%'; FLUSH PRIVILEGES;"
    )
    mysql_exec(sql)
    print(f"DB oluÅŸturuldu: {db}, kullanÄ±cÄ±: {user}")


def db_delete(db: str, user: str):
    sql = (
        f"DROP DATABASE IF EXISTS `{db}`; "
        f"DROP USER IF EXISTS '{user}'@'%'; FLUSH PRIVILEGES;"
    )
    mysql_exec(sql)
    print(f"DB silindi: {db}, kullanÄ±cÄ±: {user}")


def db_user_create(user: str, password: str, host: str = "%"):
    if not re.match(r"^[A-Za-z0-9_]+$", user):
        print("GeÃ§ersiz kullanÄ±cÄ± adÄ±.", file=sys.stderr)
        sys.exit(1)
    sql = (
        f"CREATE USER IF NOT EXISTS '{user}'@'{host}' IDENTIFIED BY '{password}'; "
        f"FLUSH PRIVILEGES;"
    )
    mysql_exec(sql)
    print(f"KullanÄ±cÄ± oluÅŸturuldu: {user}@{host}")


def reset_mysql_root_password():
    print("MySQL root ÅŸifresi sÄ±fÄ±rlanÄ±yor...")
    new_password = input("Yeni root ÅŸifresi: ").strip()
    if not new_password:
        print("Åžifre boÅŸ olamaz!")
        return
    
    # MySQL servisini durdur
    run("systemctl stop mariadb", check=False)
    
    # GÃ¼venli modda MySQL baÅŸlat
    run("mysqld_safe --skip-grant-tables --skip-networking &", check=False)
    time.sleep(3)
    
    # Root ÅŸifresini sÄ±fÄ±rla
    sql = f"ALTER USER 'root'@'localhost' IDENTIFIED BY '{new_password}';"
    run(f'mysql -u root -e "{sql}"', check=True)
    
    # MySQL'i normal modda yeniden baÅŸlat
    run("pkill mysqld", check=False)
    time.sleep(2)
    run("systemctl start mariadb", check=True)
    
    # Global deÄŸiÅŸkeni gÃ¼ncelle
    global MYSQL_ROOT_PASSWORD
    MYSQL_ROOT_PASSWORD = new_password
    
    # KonfigÃ¼rasyon dosyasÄ±nÄ± gÃ¼ncelle
    save_config()
    
    # /root/.my.cnf dosyasÄ±nÄ± gÃ¼ncelle
    mysql_conf = Path("/root/.my.cnf")
    mysql_conf.write_text(
        f"""[client]
user=root
password={new_password}
""",
        encoding="utf-8",
    )
    mysql_conf.chmod(0o600)
    
    print("âœ… MySQL root ÅŸifresi baÅŸarÄ±yla sÄ±fÄ±rlandÄ±!")
    print("âœ… KonfigÃ¼rasyon dosyasÄ± gÃ¼ncellendi!")
    print("âœ… /root/.my.cnf dosyasÄ± gÃ¼ncellendi!")


def reset_openlitespeed_admin_password():
    print("OpenLiteSpeed admin ÅŸifresi sÄ±fÄ±rlanÄ±yor...")
    new_password = input("Yeni admin ÅŸifresi: ").strip()
    if not new_password:
        print("Åžifre boÅŸ olamaz!")
        return
    
    if len(new_password) < 6:
        print("Åžifre en az 6 karakter olmalÄ±!")
        return
    
    # OpenLiteSpeed admin ÅŸifresini sÄ±fÄ±rla
    admin_script = "/usr/local/lsws/admin/misc/admpass.sh"
    if not Path(admin_script).exists():
        print("OpenLiteSpeed admin scripti bulunamadÄ±!", file=sys.stderr)
        return
    try:
        # OLS'nin kendi admpass.sh script'ini kullan
        print("Admin ÅŸifresi ayarlanÄ±yor...")

        # Script'i interaktif olmadan Ã§alÄ±ÅŸtÄ±rmak iÃ§in expect kullan
        if not shutil.which("expect"):
            print("expect yÃ¼kleniyor...")
            run("apt-get update", check=True)
            run("apt-get install -y expect", check=True)

        # Expect script oluÅŸtur
        expect_script = f"""#!/usr/bin/expect -f
        set timeout 10
        spawn {admin_script}
        expect "Please specify the user name of administrator:"
        send "admin\\r"
        expect "Please specify the administrator's password:"
        send "{new_password}\\r"
        expect "Retype password:"
        send "{new_password}\\r"
        expect eof
        """

        # GeÃ§ici expect dosyasÄ± oluÅŸtur
        import tempfile

        with tempfile.NamedTemporaryFile(mode="w", suffix=".exp", delete=False) as f:
            f.write(expect_script)
            temp_file = f.name

        # Script'i Ã§alÄ±ÅŸtÄ±rÄ±labilir yap ve Ã§alÄ±ÅŸtÄ±r
        run(f"chmod +x {temp_file}", check=True)
        run(f"expect {temp_file}", check=True)

        # GeÃ§ici dosyayÄ± sil
        Path(temp_file).unlink()

        # OpenLiteSpeed'i yeniden baÅŸlat
        print("OpenLiteSpeed yeniden baÅŸlatÄ±lÄ±yor...")
        run("/usr/local/lsws/bin/lswsctrl restart", check=True)

        print("âœ… OpenLiteSpeed admin ÅŸifresi baÅŸarÄ±yla sÄ±fÄ±rlandÄ±!")
        print(f"Admin panel: https://SERVER_IP:7080")
        print(f"KullanÄ±cÄ±: admin")
        print(f"Åžifre: {new_password}")

    except subprocess.CalledProcessError as e:
        print(f"Åžifre sÄ±fÄ±rlama hatasÄ±: {e}")
        print("Manuel olarak ÅŸu komutu Ã§alÄ±ÅŸtÄ±rabilirsiniz:")
        print(f"sudo {admin_script}")
    except Exception as e:
        print(f"Beklenmeyen hata: {e}")


def check_port(port):
    """Port kullanÄ±mÄ±nÄ± kontrol et"""
    try:
        result = run(f"netstat -tuln | grep ':{port} '", check=False)
        return bool(result.stdout.strip())
    except BaseException:
        return False


def manage_firewall():
    """Firewall yÃ¶netimi"""
    print("Firewall yÃ¶netimi...")
    
    # UFW kontrolÃ¼
    if shutil.which("ufw"):
        print("UFW firewall yÃ¶netiliyor...")
        ports = [20, 21, 22, 80, 443, 7080, 8088]
        for port in ports:
            run(f"ufw allow {port}/tcp", check=False)
        run("ufw --force enable", check=False)
    else:
        print("UFW bulunamadÄ±, iptables kullanÄ±lÄ±yor...")
        # iptables kurallarÄ±
        run("iptables -I INPUT -p tcp --dport 20 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 21 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 22 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 80 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 443 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 7080 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 8088 -j ACCEPT", check=False)


def install_ssl_support():
    """SSL/HTTPS desteÄŸi kurulumu"""
    print("SSL/HTTPS desteÄŸi kuruluyor...")
    wait_for_apt()
    
    # Certbot kurulumu (OpenLiteSpeed iÃ§in)
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y certbot", check=True)

    # Fail2Ban kurulumu ve temel konfigÃ¼rasyon
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y fail2ban", check=False)
    jail_local = """
[nginx-http-auth]
enabled = true
port     = http,https
filter   = nginx-http-auth
logpath  = /usr/local/lsws/logs/error.log
maxretry = 3

[sshd]
enabled = true

[recidive]
enabled = true
""".strip()
    jail_path = Path("/etc/fail2ban/jail.local")
    jail_path.write_text(jail_local, encoding="utf-8")
    run("systemctl enable fail2ban", check=False)
    run("systemctl restart fail2ban", check=False)
    
    # OpenLiteSpeed iÃ§in SSL konfigÃ¼rasyonu
    ssl_dir = Path("/usr/local/lsws/conf/cert")
    ssl_dir.mkdir(exist_ok=True)
    
    print(
        "SSL ve Fail2Ban desteÄŸi kuruldu. Let's Encrypt sertifikalarÄ± domain ekleme sÄ±rasÄ±nda otomatik oluÅŸturulacak."
    )


def secure_mariadb():
    """VarsayÄ±lan gÃ¼venlik iyileÅŸtirmeleri (mevcut fonksiyon placeholder)."""
    pass
    """MariaDB gÃ¼venlik ayarlarÄ±"""
    print("MariaDB gÃ¼venlik ayarlarÄ± yapÄ±lÄ±yor...")
    
    # mysql_secure_installation benzeri iÅŸlemler
    # Root ÅŸifresi zaten install_mariadb'de ayarlandÄ±
    try:
        # GÃ¼venlik komutlarÄ±nÄ± doÄŸrudan Ã§alÄ±ÅŸtÄ±r
        sql_commands = [
            "DELETE FROM mysql.user WHERE User='';",
            "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');",
            "DROP DATABASE IF EXISTS test;",
            "DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';",
            "FLUSH PRIVILEGES;",
        ]

        # Root ÅŸifresi ile baÄŸlan
        password = MYSQL_ROOT_PASSWORD if MYSQL_ROOT_PASSWORD else ""
    
        for sql in sql_commands:
            if password:
                mysql_exec(sql, check=False)
            else:
                run(f'mysql -uroot -e "{sql}"', check=False)

        print("âœ… MariaDB gÃ¼venlik ayarlarÄ± tamamlandÄ±.")
    except Exception as e:
        print(f"MariaDB gÃ¼venlik ayarlarÄ± uyarÄ±sÄ±: {e}")
        print("MariaDB zaten gÃ¼venli durumda olabilir.")


def ensure_php_handlers():
    """PHP handler ve extProcessor tanÄ±mlarÄ±nÄ± kontrol et ve ekle"""
    if not HTTPD_CONF.exists():
        return

    content = HTTPD_CONF.read_text(encoding="utf-8")

    # extProcessor tanÄ±mlarÄ± - PHP 8.2
    if "extProcessor lsphp82" not in content:
        lsphp82_config = """
extProcessor lsphp82 {
    type                            lsapi
    address                         uds://tmp/lshttpd/lsphp.sock
    maxConns                        10
    env                             PHP_LSAPI_CHILDREN=10
    env                             LSAPI_AVOID_FORK=200M
    initTimeout                     60
    retryTimeout                    0
    persistConn                     1
    respBuffer                      0
    autoStart                       1
    path                            lsphp82/bin/lsphp
    backlog                         100
    instances                       1
    priority                        0
    memSoftLimit                    2047M
    memHardLimit                    2047M
    procSoftLimit                   1400
    procHardLimit                   1500
}
"""
        # scriptHandler'dan Ã¶nce ekle
        if "scriptHandler" in content:
            content = content.replace(
                "scriptHandler", lsphp82_config + "\nscriptHandler"
            )
        else:
            content += lsphp82_config

    # extProcessor tanÄ±mlarÄ± - PHP 8.3
    if "extProcessor lsphp83" not in content:
        lsphp83_config = """
extProcessor lsphp83 {
    type                            lsapi
    address                         uds://tmp/lshttpd/lsphp.sock
    maxConns                        10
    env                             PHP_LSAPI_CHILDREN=10
    env                             LSAPI_AVOID_FORK=200M
    initTimeout                     60
    retryTimeout                    0
    persistConn                     1
    respBuffer                      0
    autoStart                       1
    path                            lsphp83/bin/lsphp
    backlog                         100
    instances                       1
    priority                        0
    memSoftLimit                    2047M
    memHardLimit                    2047M
    procSoftLimit                   1400
    procHardLimit                   1500
}
"""
        # scriptHandler'dan Ã¶nce ekle
        if "scriptHandler" in content:
            content = content.replace(
                "scriptHandler", lsphp83_config + "\nscriptHandler"
            )
        else:
            content += lsphp83_config

    # VarsayÄ±lan lsphp extProcessor
    if "extProcessor lsphp {" not in content:
        default_lsphp_config = f"""
extProcessor lsphp {{
    type                            lsapi
    address                         uds://tmp/lshttpd/lsphp.sock
    maxConns                        10
    env                             PHP_LSAPI_CHILDREN=10
    env                             LSAPI_AVOID_FORK=200M
    initTimeout                     60
    retryTimeout                    0
    persistConn                     1
    respBuffer                      0
    autoStart                       1
    path                            lsphp{DEFAULT_LSPHP_VERSION}/bin/lsphp
    backlog                         100
    instances                       1
    priority                        0
    memSoftLimit                    2047M
    memHardLimit                    2047M
    procSoftLimit                   1400
    procHardLimit                   1500
}}
"""
        # scriptHandler'dan Ã¶nce ekle
        if "scriptHandler" in content:
            content = content.replace(
                "scriptHandler", default_lsphp_config + "\nscriptHandler"
            )
        else:
            content += default_lsphp_config

    # scriptHandler kontrolÃ¼
    if "scriptHandler" not in content or "add lsapi:lsphp  php" not in content:
        if "scriptHandler" not in content:
            content += """
scriptHandler {
    add lsapi:lsphp  php
}
"""
        else:
            # scriptHandler var ama php handler'Ä± yok
            content = re.sub(
                r"scriptHandler\s*\{[^}]*\}",
                "scriptHandler {\n    add lsapi:lsphp  php\n}",
                content,
            )

    HTTPD_CONF.write_text(content, encoding="utf-8")
    print("âœ… PHP handler'lar yapÄ±landÄ±rÄ±ldÄ±")


def optimize_openlitespeed():
    """OpenLiteSpeed performans optimizasyonu"""
    print("OpenLiteSpeed performans optimizasyonu yapÄ±lÄ±yor...")
    
    # Sistem kaynaklarÄ±nÄ± analiz et
    print("ðŸ” Sistem kaynaklarÄ± analiz ediliyor...")
    
    # RAM miktarÄ±nÄ± al (GB cinsinden)
    try:
        with open("/proc/meminfo", "r") as f:
            meminfo = f.read()
        total_mem_kb = int(re.search(r"MemTotal:\s+(\d+)", meminfo).group(1))
        total_mem_gb = total_mem_kb / 1024 / 1024
    except:
        total_mem_gb = 4  # VarsayÄ±lan 4GB
    
    # CPU Ã§ekirdek sayÄ±sÄ±nÄ± al
    try:
        cpu_cores = os.cpu_count() or 4
    except:
        cpu_cores = 4  # VarsayÄ±lan 4 Ã§ekirdek
    
    print(f"ðŸ’¾ RAM: {total_mem_gb:.1f}GB")
    print(f"ðŸ–¥ï¸  CPU Ã‡ekirdek: {cpu_cores}")
    
    # PHP_LSAPI_CHILDREN hesapla (CPU Ã§ekirdek sayÄ±sÄ±na gÃ¶re)
    php_children = min(max(cpu_cores * 2, 4), 32)  # 4-32 arasÄ±
    
    # LSAPI_AVOID_FORK hesapla (RAM miktarÄ±na gÃ¶re)
    if total_mem_gb >= 16:
        avoid_fork = "512M"
    elif total_mem_gb >= 8:
        avoid_fork = "256M"
    elif total_mem_gb >= 4:
        avoid_fork = "128M"
    else:
        avoid_fork = "64M"
    
    # maxConnections hesapla (RAM ve CPU'ya gÃ¶re)
    if total_mem_gb >= 16 and cpu_cores >= 8:
        max_conn = "20000"
    elif total_mem_gb >= 8 and cpu_cores >= 4:
        max_conn = "15000"
    elif total_mem_gb >= 4 and cpu_cores >= 2:
        max_conn = "10000"
    else:
        max_conn = "5000"
    
    print(f"âš™ï¸  PHP_LSAPI_CHILDREN: {php_children}")
    print(f"âš™ï¸  LSAPI_AVOID_FORK: {avoid_fork}")
    print(f"âš™ï¸  maxConnections: {max_conn}")
    
    # KonfigÃ¼rasyon dosyasÄ± optimizasyonlarÄ±
    if HTTPD_CONF.exists():
        content = HTTPD_CONF.read_text(encoding="utf-8")
        
        # Performans ayarlarÄ±
        optimizations = {
            "maxConnections": max_conn,
            "maxSSLConnections": max_conn,
            "connTimeout": "300",
            "maxKeepAliveReq": "10000",
            "keepAliveTimeout": "5",
            "enableGzipCompress": "1",
            "enableBrCompress": "4",
            "quicEnable": "1",
        }

        for key, value in optimizations.items():
            pattern = rf"{key}\s+\d+"
            replacement = f"{key} {value}"
            content = re.sub(pattern, replacement, content)

        HTTPD_CONF.write_text(content, encoding="utf-8")

    # PHP handler'larÄ± kontrol et ve optimize et
    ensure_php_handlers()
    
    # PHP konfigÃ¼rasyonunu optimize et
    optimize_php_lsapi(php_children, avoid_fork)
    
    # PHP performans optimizasyonu
    optimize_php_performance(total_mem_gb, cpu_cores)
    
    # OpenLiteSpeed ek optimizasyonlarÄ±
    optimize_openlitespeed_advanced(total_mem_gb, cpu_cores)
    
    # Sistem seviyesi optimizasyonlar
    optimize_system_level(total_mem_gb, cpu_cores)
    
    # MySQL/MariaDB optimizasyonu
    optimize_mysql_performance(total_mem_gb, cpu_cores)
    
    print("âœ… OpenLiteSpeed performans optimizasyonu tamamlandÄ±.")
    print(f"ðŸ“Š Optimizasyon Ã¶zeti:")
    print(f"   - PHP Children: {php_children}")
    print(f"   - Avoid Fork: {avoid_fork}")
    print(f"   - Max Connections: {max_conn}")
    print(f"   - PHP OPcache: Optimized")
    print(f"   - MySQL/MariaDB: Optimized")
    print(f"   - System Level: Optimized")


def optimize_php_lsapi(php_children: int, avoid_fork: str):
    """PHP LSAPI konfigÃ¼rasyonunu optimize et"""
    print("ðŸ”§ PHP LSAPI konfigÃ¼rasyonu optimize ediliyor...")
    
    # PHP konfigÃ¼rasyon dosyalarÄ±nÄ± bul
    php_config_files = [
        "/usr/local/lsws/conf/php.ini",
        "/usr/local/lsws/lsphp82/etc/php/8.2/litespeed/php.ini",
        "/usr/local/lsws/lsphp83/etc/php/8.3/litespeed/php.ini",
    ]
    
    for config_file in php_config_files:
        if Path(config_file).exists():
            try:
                content = Path(config_file).read_text(encoding="utf-8")
                
                # PHP_LSAPI_CHILDREN ayarÄ±nÄ± ekle/gÃ¼ncelle
                if "PHP_LSAPI_CHILDREN" not in content:
                    content += f"\n; isPanel Performance Optimization\nPHP_LSAPI_CHILDREN={php_children}\n"
                else:
                    content = re.sub(
                        r"PHP_LSAPI_CHILDREN\s*=\s*\d+",
                        f"PHP_LSAPI_CHILDREN={php_children}",
                        content
                    )
                
                # LSAPI_AVOID_FORK ayarÄ±nÄ± ekle/gÃ¼ncelle
                if "LSAPI_AVOID_FORK" not in content:
                    content += f"LSAPI_AVOID_FORK={avoid_fork}\n"
                else:
                    content = re.sub(
                        r"LSAPI_AVOID_FORK\s*=\s*[\dM]+",
                        f"LSAPI_AVOID_FORK={avoid_fork}",
                        content
                    )
                
                Path(config_file).write_text(content, encoding="utf-8")
                print(f"âœ… {config_file} gÃ¼ncellendi")
                
            except Exception as e:
                print(f"âš ï¸  {config_file} gÃ¼ncellenemedi: {e}")
    
    # Environment variables olarak da ayarla
    env_file = Path("/etc/environment")
    if env_file.exists():
        try:
            content = env_file.read_text(encoding="utf-8")
            
            # PHP_LSAPI_CHILDREN ekle/gÃ¼ncelle
            if "PHP_LSAPI_CHILDREN" not in content:
                content += f"\nPHP_LSAPI_CHILDREN={php_children}\n"
            else:
                content = re.sub(
                    r"PHP_LSAPI_CHILDREN\s*=\s*\d+",
                    f"PHP_LSAPI_CHILDREN={php_children}",
                    content
                )
            
            # LSAPI_AVOID_FORK ekle/gÃ¼ncelle
            if "LSAPI_AVOID_FORK" not in content:
                content += f"LSAPI_AVOID_FORK={avoid_fork}\n"
            else:
                content = re.sub(
                    r"LSAPI_AVOID_FORK\s*=\s*[\dM]+",
                    f"LSAPI_AVOID_FORK={avoid_fork}",
                    content
                )
            
            env_file.write_text(content, encoding="utf-8")
            print("âœ… /etc/environment gÃ¼ncellendi")
            
        except Exception as e:
            print(f"âš ï¸  /etc/environment gÃ¼ncellenemedi: {e}")
    
    print("âœ… PHP LSAPI optimizasyonu tamamlandÄ±")


def optimize_php_performance(total_mem_gb: float, cpu_cores: int):
    """PHP performans optimizasyonu"""
    print("ðŸš€ PHP performans optimizasyonu yapÄ±lÄ±yor...")
    
    # OPcache ayarlarÄ±nÄ± hesapla
    if total_mem_gb >= 16:
        opcache_memory = "256"
        opcache_files = "10000"
        opcache_strings = "16"
    elif total_mem_gb >= 8:
        opcache_memory = "128"
        opcache_files = "8000"
        opcache_strings = "8"
    elif total_mem_gb >= 4:
        opcache_memory = "64"
        opcache_files = "4000"
        opcache_strings = "4"
    else:
        opcache_memory = "32"
        opcache_files = "2000"
        opcache_strings = "2"
    
    # PHP konfigÃ¼rasyon dosyalarÄ±nÄ± bul
    php_config_files = [
        "/usr/local/lsws/conf/php.ini",
        "/usr/local/lsws/lsphp82/etc/php/8.2/litespeed/php.ini",
        "/usr/local/lsws/lsphp83/etc/php/8.3/litespeed/php.ini",
    ]
    
    for config_file in php_config_files:
        if Path(config_file).exists():
            try:
                content = Path(config_file).read_text(encoding="utf-8")
                
                # OPcache optimizasyonlarÄ±
                opcache_settings = {
                    "opcache.enable": "1",
                    "opcache.memory_consumption": opcache_memory,
                    "opcache.interned_strings_buffer": opcache_strings,
                    "opcache.max_accelerated_files": opcache_files,
                    "opcache.revalidate_freq": "2",
                    "opcache.fast_shutdown": "1",
                    "opcache.enable_cli": "1",
                    "opcache.validate_timestamps": "1",
                    "opcache.save_comments": "1",
                    "opcache.load_comments": "1",
                }
                
                # Her ayarÄ± gÃ¼ncelle
                for setting, value in opcache_settings.items():
                    pattern = rf"{re.escape(setting)}\s*=\s*[^\n]*"
                    replacement = f"{setting} = {value}"
                    content = re.sub(pattern, replacement, content)
                    
                    # EÄŸer ayar yoksa ekle
                    if setting not in content:
                        content += f"\n{setting} = {value}\n"
                
                # PHP genel optimizasyonlarÄ±
                php_optimizations = {
                    "max_execution_time": "300",
                    "max_input_time": "300",
                    "memory_limit": f"{min(int(total_mem_gb * 128), 512)}M",
                    "post_max_size": "64M",
                    "upload_max_filesize": "64M",
                    "max_file_uploads": "20",
                    "max_input_vars": "3000",
                    "realpath_cache_size": "2M",
                    "realpath_cache_ttl": "600",
                }
                
                for setting, value in php_optimizations.items():
                    pattern = rf"{re.escape(setting)}\s*=\s*[^\n]*"
                    replacement = f"{setting} = {value}"
                    content = re.sub(pattern, replacement, content)
                    
                    if setting not in content:
                        content += f"\n{setting} = {value}\n"
                
                Path(config_file).write_text(content, encoding="utf-8")
                print(f"âœ… {config_file} PHP optimizasyonu tamamlandÄ±")
                
            except Exception as e:
                print(f"âš ï¸  {config_file} PHP optimizasyonu baÅŸarÄ±sÄ±z: {e}")
    
    print("âœ… PHP performans optimizasyonu tamamlandÄ±")


def optimize_openlitespeed_advanced(total_mem_gb: float, cpu_cores: int):
    """OpenLiteSpeed geliÅŸmiÅŸ optimizasyonlarÄ±"""
    print("âš¡ OpenLiteSpeed geliÅŸmiÅŸ optimizasyonlarÄ± yapÄ±lÄ±yor...")
    
    if HTTPD_CONF.exists():
        try:
            content = HTTPD_CONF.read_text(encoding="utf-8")
            
            # GeliÅŸmiÅŸ optimizasyonlar
            advanced_optimizations = {
                "maxReqURLLen": "32768",
                "maxReqHeaderSize": "65536",
                "maxReqBodySize": "2047M",
                "maxDynRespHeaderSize": "32768",
                "maxDynRespSize": "2047M",
                "maxCachedFileSize": "2000000",
                "totalInMemCacheSize": "200M",
                "maxMMapFileSize": "256M",
                "useSendfile": "1",
                "fileETag": "2",
                "enableExpires": "1",
                "expiresByType": "text/css A2592000,application/javascript A2592000,image/png A2592000,image/jpg A2592000,image/gif A2592000,image/ico A2592000",
            }
            
            # Her optimizasyonu uygula
            for key, value in advanced_optimizations.items():
                pattern = rf"{key}\s+[^\n]*"
                replacement = f"{key} {value}"
                content = re.sub(pattern, replacement, content)
                
                # EÄŸer ayar yoksa ekle
                if key not in content:
                    content += f"\n{key} {value}\n"
            
            # Worker optimizasyonlarÄ±
            worker_optimizations = {
                "maxConnections": str(min(int(total_mem_gb * 1000), 20000)),
                "maxSSLConnections": str(min(int(total_mem_gb * 1000), 20000)),
                "connTimeout": "300",
                "maxKeepAliveReq": "10000",
                "keepAliveTimeout": "5",
                "sndBufSize": "0",
                "rcvBufSize": "0",
            }
            
            for key, value in worker_optimizations.items():
                pattern = rf"{key}\s+[^\n]*"
                replacement = f"{key} {value}"
                content = re.sub(pattern, replacement, content)
            
            HTTPD_CONF.write_text(content, encoding="utf-8")
            print("âœ… OpenLiteSpeed geliÅŸmiÅŸ optimizasyonlarÄ± tamamlandÄ±")
            
        except Exception as e:
            print(f"âš ï¸  OpenLiteSpeed geliÅŸmiÅŸ optimizasyon hatasÄ±: {e}")


def optimize_system_level(total_mem_gb: float, cpu_cores: int):
    """Sistem seviyesi optimizasyonlar"""
    print("ðŸ”§ Sistem seviyesi optimizasyonlar yapÄ±lÄ±yor...")
    
    try:
        # Disk I/O optimizasyonu
        optimize_disk_io()
        
        # Network optimizasyonu
        optimize_network_settings(total_mem_gb, cpu_cores)
        
        # Kernel parametreleri
        kernel_params = {
            "net.core.rmem_max": "16777216",
            "net.core.wmem_max": "16777216",
            "net.ipv4.tcp_rmem": "4096 65536 16777216",
            "net.ipv4.tcp_wmem": "4096 65536 16777216",
            "net.core.netdev_max_backlog": "5000",
            "net.ipv4.tcp_congestion_control": "bbr",
            "vm.swappiness": "10",
            "vm.dirty_ratio": "15",
            "vm.dirty_background_ratio": "5",
            "fs.file-max": "2097152",
            "net.core.somaxconn": "65535",
        }
        
        # sysctl ayarlarÄ±nÄ± uygula
        for param, value in kernel_params.items():
            run(f"sysctl -w {param}={value}", check=False)
        
        # KalÄ±cÄ± konfigÃ¼rasyon
        sysctl_config = "# isPanel System Optimization\n"
        for param, value in kernel_params.items():
            sysctl_config += f"{param} = {value}\n"
        
        Path("/etc/sysctl.d/99-ispanel.conf").write_text(sysctl_config, encoding="utf-8")
        
        # Limits optimizasyonu
        limits_config = f"""# isPanel Performance Limits
* soft nofile 65535
* hard nofile 65535
* soft nproc {cpu_cores * 1000}
* hard nproc {cpu_cores * 1000}
root soft nofile 65535
root hard nofile 65535
"""
        Path("/etc/security/limits.d/99-ispanel.conf").write_text(limits_config, encoding="utf-8")
        
        print("âœ… Sistem seviyesi optimizasyonlar tamamlandÄ±")
        
    except Exception as e:
        print(f"âš ï¸  Sistem optimizasyon hatasÄ±: {e}")


def optimize_disk_io():
    """Disk I/O optimizasyonu"""
    print("ðŸ’¾ Disk I/O optimizasyonu yapÄ±lÄ±yor...")
    
    try:
        # Disk tÃ¼rÃ¼nÃ¼ tespit et (SSD/HDD)
        disk_type = detect_disk_type()
        print(f"ðŸ” Disk tÃ¼rÃ¼ tespit edildi: {disk_type}")
        
        # I/O scheduler ayarla
        optimize_io_scheduler(disk_type)
        
        # Read-ahead buffer ayarla
        optimize_read_ahead(disk_type)
        
        # File system mount options
        optimize_mount_options()
        
        print("âœ… Disk I/O optimizasyonu tamamlandÄ±")
        
    except Exception as e:
        print(f"âš ï¸  Disk I/O optimizasyon hatasÄ±: {e}")


def detect_disk_type():
    """Disk tÃ¼rÃ¼nÃ¼ tespit et (SSD/HDD)"""
    try:
        # Root partition'Ä± bul
        result = run("df / | tail -1 | awk '{print $1}'", check=True)
        root_partition = result.stdout.strip()
        
        # Disk tÃ¼rÃ¼nÃ¼ kontrol et
        result = run(f"cat /sys/block/{root_partition.split('/')[-1][:-1]}/queue/rotational", check=False)
        if result.returncode == 0:
            rotational = result.stdout.strip()
            return "SSD" if rotational == "0" else "HDD"
        else:
            return "UNKNOWN"
    except:
        return "UNKNOWN"


def optimize_io_scheduler(disk_type):
    """I/O scheduler'Ä± optimize et"""
    try:
        # Disk'leri bul
        result = run("lsblk -d -o NAME,TYPE | grep disk | awk '{print $1}'", check=True)
        disks = result.stdout.strip().split('\n')
        
        for disk in disks:
            if disk:
                if disk_type == "SSD":
                    # SSD iÃ§in noop scheduler
                    run(f"echo noop > /sys/block/{disk}/queue/scheduler", check=False)
                    print(f"âœ… {disk}: noop scheduler (SSD optimized)")
                else:
                    # HDD iÃ§in deadline scheduler
                    run(f"echo deadline > /sys/block/{disk}/queue/scheduler", check=False)
                    print(f"âœ… {disk}: deadline scheduler (HDD optimized)")
    except Exception as e:
        print(f"âš ï¸  I/O scheduler optimizasyon hatasÄ±: {e}")


def optimize_read_ahead(disk_type):
    """Read-ahead buffer'Ä± optimize et"""
    try:
        # Disk'leri bul
        result = run("lsblk -d -o NAME,TYPE | grep disk | awk '{print $1}'", check=True)
        disks = result.stdout.strip().split('\n')
        
        for disk in disks:
            if disk:
                if disk_type == "SSD":
                    # SSD iÃ§in dÃ¼ÅŸÃ¼k read-ahead
                    run(f"echo 128 > /sys/block/{disk}/queue/read_ahead_kb", check=False)
                    print(f"âœ… {disk}: 128KB read-ahead (SSD optimized)")
                else:
                    # HDD iÃ§in yÃ¼ksek read-ahead
                    run(f"echo 1024 > /sys/block/{disk}/queue/read_ahead_kb", check=False)
                    print(f"âœ… {disk}: 1024KB read-ahead (HDD optimized)")
    except Exception as e:
        print(f"âš ï¸  Read-ahead optimizasyon hatasÄ±: {e}")


def optimize_mount_options():
    """File system mount options'Ä± optimize et"""
    try:
        # /etc/fstab dosyasÄ±nÄ± yedekle
        run("cp /etc/fstab /etc/fstab.backup", check=False)
        
        # Fstab'Ä± oku
        fstab_content = Path("/etc/fstab").read_text(encoding="utf-8")
        
        # Optimize edilmiÅŸ mount options
        optimized_options = {
            "ext4": "noatime,nodiratime,data=writeback,barrier=0",
            "xfs": "noatime,nodiratime",
            "btrfs": "noatime,nodiratime,compress=lzo",
        }
        
        # Her satÄ±rÄ± kontrol et ve optimize et
        lines = fstab_content.split('\n')
        optimized_lines = []
        
        for line in lines:
            if line.strip() and not line.startswith('#'):
                parts = line.split()
                if len(parts) >= 4:
                    device, mount_point, fs_type, options = parts[:4]
                    
                    if fs_type in optimized_options:
                        # Mevcut options'Ä± koru ve yeni ekle
                        new_options = f"{options},{optimized_options[fs_type]}"
                        line = line.replace(options, new_options)
                        print(f"âœ… {mount_point}: {fs_type} optimized")
            
            optimized_lines.append(line)
        
        # Optimize edilmiÅŸ fstab'Ä± yaz
        Path("/etc/fstab").write_text('\n'.join(optimized_lines), encoding="utf-8")
        print("âœ… Mount options optimized")
        
    except Exception as e:
        print(f"âš ï¸  Mount options optimizasyon hatasÄ±: {e}")


def optimize_network_settings(total_mem_gb: float, cpu_cores: int):
    """Network optimizasyonu"""
    print("ðŸŒ Network optimizasyonu yapÄ±lÄ±yor...")
    
    try:
        # Network buffer'larÄ± hesapla
        if total_mem_gb >= 16:
            net_buffer = "33554432"  # 32MB
            tcp_window = "16777216"  # 16MB
        elif total_mem_gb >= 8:
            net_buffer = "16777216"  # 16MB
            tcp_window = "8388608"   # 8MB
        else:
            net_buffer = "8388608"   # 8MB
            tcp_window = "4194304"   # 4MB
        
        print(f"âš™ï¸  Network Buffer: {net_buffer}")
        print(f"âš™ï¸  TCP Window: {tcp_window}")
        
        # Network optimizasyon parametreleri
        network_params = {
            # TCP window scaling
            "net.ipv4.tcp_window_scaling": "1",
            "net.ipv4.tcp_timestamps": "1",
            "net.ipv4.tcp_sack": "1",
            
            # Network buffer sizes
            "net.core.rmem_max": net_buffer,
            "net.core.wmem_max": net_buffer,
            "net.ipv4.tcp_rmem": f"4096 65536 {tcp_window}",
            "net.ipv4.tcp_wmem": f"4096 65536 {tcp_window}",
            
            # Connection tracking
            "net.netfilter.nf_conntrack_max": str(cpu_cores * 10000),
            "net.netfilter.nf_conntrack_tcp_timeout_established": "1800",
            "net.netfilter.nf_conntrack_tcp_timeout_time_wait": "120",
            
            # Network performance
            "net.core.netdev_max_backlog": "5000",
            "net.core.somaxconn": "65535",
            "net.ipv4.tcp_max_syn_backlog": "4096",
            "net.ipv4.tcp_fin_timeout": "30",
            "net.ipv4.tcp_keepalive_time": "1200",
            "net.ipv4.tcp_keepalive_intvl": "15",
            "net.ipv4.tcp_keepalive_probes": "5",
            
            # TCP congestion control
            "net.ipv4.tcp_congestion_control": "bbr",
            "net.ipv4.tcp_ecn": "1",
            "net.ipv4.tcp_fastopen": "3",
        }
        
        # Network parametrelerini uygula
        for param, value in network_params.items():
            run(f"sysctl -w {param}={value}", check=False)
        
        # KalÄ±cÄ± konfigÃ¼rasyon
        network_config = "# isPanel Network Optimization\n"
        for param, value in network_params.items():
            network_config += f"{param} = {value}\n"
        
        Path("/etc/sysctl.d/99-ispanel-network.conf").write_text(network_config, encoding="utf-8")
        
        print("âœ… Network optimizasyonu tamamlandÄ±")
        
    except Exception as e:
        print(f"âš ï¸  Network optimizasyon hatasÄ±: {e}")


def optimize_mysql_performance(total_mem_gb: float, cpu_cores: int):
    """MySQL/MariaDB performans optimizasyonu"""
    print("ðŸ—„ï¸  MySQL/MariaDB performans optimizasyonu yapÄ±lÄ±yor...")
    
    try:
        # MySQL konfigÃ¼rasyon dosyalarÄ±nÄ± bul
        mysql_config_files = [
            "/etc/mysql/mariadb.conf.d/50-server.cnf",
            "/etc/mysql/my.cnf",
            "/etc/mysql/mysql.conf.d/mysqld.cnf",
            "/etc/my.cnf",
        ]
        
        # En uygun konfigÃ¼rasyon dosyasÄ±nÄ± bul
        config_file = None
        for file_path in mysql_config_files:
            if Path(file_path).exists():
                config_file = file_path
                break
        
        if not config_file:
            # VarsayÄ±lan konfigÃ¼rasyon dosyasÄ± oluÅŸtur
            config_file = "/etc/mysql/mariadb.conf.d/50-server.cnf"
            Path(config_file).parent.mkdir(parents=True, exist_ok=True)
        
        # MySQL ayarlarÄ±nÄ± hesapla
        if total_mem_gb >= 256:
            # 256GB+ RAM - Enterprise seviye
            innodb_buffer_pool = "128G"
            max_connections = "2000"
            query_cache_size = "2G"
            tmp_table_size = "2G"
            max_heap_table_size = "2G"
            innodb_log_file_size = "2G"
            innodb_log_buffer_size = "256M"
        elif total_mem_gb >= 128:
            # 128GB RAM - High-end server
            innodb_buffer_pool = "64G"
            max_connections = "1500"
            query_cache_size = "1G"
            tmp_table_size = "1G"
            max_heap_table_size = "1G"
            innodb_log_file_size = "1G"
            innodb_log_buffer_size = "128M"
        elif total_mem_gb >= 64:
            # 64GB RAM - Enterprise server
            innodb_buffer_pool = "32G"
            max_connections = "1000"
            query_cache_size = "512M"
            tmp_table_size = "512M"
            max_heap_table_size = "512M"
            innodb_log_file_size = "512M"
            innodb_log_buffer_size = "64M"
        elif total_mem_gb >= 32:
            # 32GB RAM - High-performance server
            innodb_buffer_pool = "16G"
            max_connections = "800"
            query_cache_size = "256M"
            tmp_table_size = "256M"
            max_heap_table_size = "256M"
            innodb_log_file_size = "256M"
            innodb_log_buffer_size = "32M"
        elif total_mem_gb >= 16:
            # 16GB RAM - Production server
            innodb_buffer_pool = "8G"
            max_connections = "500"
            query_cache_size = "256M"
            tmp_table_size = "256M"
            max_heap_table_size = "256M"
            innodb_log_file_size = "256M"
            innodb_log_buffer_size = "32M"
        elif total_mem_gb >= 8:
            innodb_buffer_pool = "4G"
            max_connections = "300"
            query_cache_size = "128M"
            tmp_table_size = "128M"
            max_heap_table_size = "128M"
        elif total_mem_gb >= 4:
            innodb_buffer_pool = "2G"
            max_connections = "200"
            query_cache_size = "64M"
            tmp_table_size = "64M"
            max_heap_table_size = "64M"
        else:
            innodb_buffer_pool = "1G"
            max_connections = "100"
            query_cache_size = "32M"
            tmp_table_size = "32M"
            max_heap_table_size = "32M"
        
        print(f"âš™ï¸  InnoDB Buffer Pool: {innodb_buffer_pool}")
        print(f"âš™ï¸  Max Connections: {max_connections}")
        print(f"âš™ï¸  Query Cache: {query_cache_size}")
        print(f"âš™ï¸  Log File Size: {innodb_log_file_size}")
        print(f"âš™ï¸  Log Buffer: {innodb_log_buffer_size}")
        
        # MySQL optimizasyon ayarlarÄ±
        mysql_optimizations = {
            # InnoDB ayarlarÄ±
            "innodb_buffer_pool_size": innodb_buffer_pool,
            "innodb_log_file_size": innodb_log_file_size,
            "innodb_log_buffer_size": innodb_log_buffer_size,
            "innodb_flush_log_at_trx_commit": "2",
            "innodb_flush_method": "O_DIRECT",
            "innodb_file_per_table": "1",
            "innodb_open_files": "4000",
            "innodb_io_capacity": "2000",
            "innodb_io_capacity_max": "4000",
            "innodb_read_io_threads": str(min(cpu_cores, 8)),
            "innodb_write_io_threads": str(min(cpu_cores, 8)),
            "innodb_thread_concurrency": str(cpu_cores * 2),
            "innodb_buffer_pool_instances": str(min(cpu_cores, 8)),
            
            # Genel ayarlar
            "max_connections": max_connections,
            "max_user_connections": "0",
            "max_allowed_packet": "64M",
            "thread_cache_size": "16",
            "table_open_cache": "4000",
            "table_definition_cache": "2000",
            
            # Query Cache
            "query_cache_type": "1",
            "query_cache_size": query_cache_size,
            "query_cache_limit": "2M",
            
            # Temp tables
            "tmp_table_size": tmp_table_size,
            "max_heap_table_size": max_heap_table_size,
            "tmpdir": "/tmp",
            
            # MyISAM
            "key_buffer_size": "256M",
            "myisam_sort_buffer_size": "64M",
            "myisam_max_sort_file_size": "10G",
            
            # Logging
            "slow_query_log": "1",
            "slow_query_log_file": "/var/log/mysql/slow.log",
            "long_query_time": "2",
            "log_queries_not_using_indexes": "1",
            
            # Binary logging
            "log_bin": "/var/log/mysql/mysql-bin.log",
            "expire_logs_days": "7",
            "max_binlog_size": "100M",
            
            # Performance
            "sort_buffer_size": "2M",
            "read_buffer_size": "2M",
            "read_rnd_buffer_size": "8M",
            "join_buffer_size": "2M",
            "bulk_insert_buffer_size": "64M",
        }
        
        # KonfigÃ¼rasyon dosyasÄ±nÄ± oku veya oluÅŸtur
        if Path(config_file).exists():
            content = Path(config_file).read_text(encoding="utf-8")
        else:
            content = f"""# isPanel MySQL Optimization
[mysqld]
# Basic settings
port = 3306
socket = /var/run/mysqld/mysqld.sock
datadir = /var/lib/mysql
pid-file = /var/run/mysqld/mysqld.pid
user = mysql

# Performance optimizations
"""
        
        # [mysqld] bÃ¶lÃ¼mÃ¼nÃ¼ bul veya oluÅŸtur
        if "[mysqld]" not in content:
            content += "\n[mysqld]\n"
        
        # Her optimizasyonu ekle/gÃ¼ncelle
        for setting, value in mysql_optimizations.items():
            pattern = rf"{re.escape(setting)}\s*=\s*[^\n]*"
            replacement = f"{setting} = {value}"
            
            if re.search(pattern, content):
                content = re.sub(pattern, replacement, content)
            else:
                # [mysqld] bÃ¶lÃ¼mÃ¼ne ekle
                content = re.sub(
                    r"(\[mysqld\])",
                    f"\\1\n{setting} = {value}",
                    content
                )
        
        # KonfigÃ¼rasyon dosyasÄ±nÄ± kaydet
        Path(config_file).write_text(content, encoding="utf-8")
        
        # MySQL servisini yeniden baÅŸlat
        print("ðŸ”„ MySQL servisi yeniden baÅŸlatÄ±lÄ±yor...")
        run("systemctl restart mariadb", check=False)
        run("systemctl restart mysql", check=False)
        
        # MySQL servisinin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± kontrol et
        result = run("systemctl is-active mariadb mysql", check=False)
        if result.returncode == 0:
            print("âœ… MySQL/MariaDB optimizasyonu tamamlandÄ±")
        else:
            print("âš ï¸  MySQL servisi yeniden baÅŸlatÄ±lamadÄ±, manuel kontrol gerekebilir")
        
    except Exception as e:
        print(f"âš ï¸  MySQL optimizasyon hatasÄ±: {e}")


def repair_mariadb():
    """MariaDB onarÄ±m iÅŸlemleri"""
    print("MariaDB onarÄ±m iÅŸlemleri yapÄ±lÄ±yor...")
    
    # MySQL servisini durdur
    run("systemctl stop mariadb", check=False)
    
    # Repair iÅŸlemleri
    try:
        # MySQL'i gÃ¼venli modda baÅŸlat
        run("mysqld_safe --skip-grant-tables --skip-networking &", check=False)
        time.sleep(3)
        
        # Repair komutlarÄ±
        repair_commands = [
            "REPAIR TABLE mysql.user;",
            "REPAIR TABLE mysql.db;",
            "REPAIR TABLE mysql.tables_priv;",
            "REPAIR TABLE mysql.columns_priv;",
            "FLUSH PRIVILEGES;",
        ]
        
        for cmd in repair_commands:
            try:
                run(f'mysql -u root -e "{cmd}"', check=True)
            except BaseException:
                pass
        
        # MySQL'i normal modda yeniden baÅŸlat
        run("pkill mysqld", check=False)
        time.sleep(2)
        run("systemctl start mariadb", check=True)
        
        print("MariaDB onarÄ±m iÅŸlemleri tamamlandÄ±.")
    except Exception as e:
        print(f"MariaDB onarÄ±m hatasÄ±: {e}")
        run("systemctl start mariadb", check=False)


def repair_openlitespeed():
    """OpenLiteSpeed onarÄ±m iÅŸlemleri"""
    print("OpenLiteSpeed onarÄ±m iÅŸlemleri yapÄ±lÄ±yor...")
    
    try:
        # KonfigÃ¼rasyon dosyalarÄ±nÄ± kontrol et
        config_files = [
            "/usr/local/lsws/conf/httpd_config.conf",
            "/usr/local/lsws/conf/vhosts",
        ]
        
        for config_file in config_files:
            if Path(config_file).exists():
                # Dosya izinlerini dÃ¼zelt
                run(f"chown -R lsadm:lsadm {config_file}", check=False)
                run(f"chmod -R 755 {config_file}", check=False)
        
        # OpenLiteSpeed'i yeniden baÅŸlat
        run("systemctl restart lsws", check=False)
        
        # Alternatif restart
        try:
            run("/usr/local/lsws/bin/lswsctrl restart", check=True)
        except BaseException:
            pass
            
        print("OpenLiteSpeed onarÄ±m iÅŸlemleri tamamlandÄ±.")
    except Exception as e:
        print(f"OpenLiteSpeed onarÄ±m hatasÄ±: {e}")


def install_redis():
    """Redis kurulumu"""
    print("Redis kuruluyor...")
    wait_for_apt()
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y redis-server", check=True)
    run("systemctl enable redis-server", check=False)
    run("systemctl start redis-server", check=True)
    print("Redis kuruldu ve baÅŸlatÄ±ldÄ±.")


def install_memcached():
    """Memcached kurulumu"""
    print("Memcached kuruluyor...")
    wait_for_apt()
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y memcached", check=True)
    run("systemctl enable memcached", check=False)
    run("systemctl start memcached", check=True)
    print("Memcached kuruldu ve baÅŸlatÄ±ldÄ±.")


def configure_php_opcache():
    """PHP OPcache konfigÃ¼rasyonu"""
    print("PHP OPcache konfigÃ¼rasyonu yapÄ±lÄ±yor...")
    
    # OPcache ayarlarÄ±
    opcache_config = """
[opcache]
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=4000
opcache.revalidate_freq=2
opcache.fast_shutdown=1
opcache.enable_cli=1
"""
    
    # PHP ini dosyasÄ±na ekle
    candidates = [
        "/usr/local/lsws/lsphp81/etc/php/8.1/litespeed/php.ini",
        "/usr/local/lsws/lsphp82/etc/php/8.2/litespeed/php.ini",
        "/usr/local/lsws/lsphp83/etc/php/8.3/litespeed/php.ini",
    ]
    wrote = False
    for php_ini_path in candidates:
        if Path(php_ini_path).exists():
            with open(php_ini_path, "a", encoding="utf-8") as f:
                f.write(opcache_config)
            wrote = True
    if wrote:
        print("OPcache konfigÃ¼rasyonu eklendi (mevcut sÃ¼rÃ¼mler).")
    else:
        print("PHP ini dosyasÄ± bulunamadÄ±, OPcache manuel olarak yapÄ±landÄ±rÄ±lmalÄ±.")


def backup_domain(domain: str):
    backup_dir = ISPANEL_BACKUP_DIR / "domains"
    backup_dir.mkdir(parents=True, exist_ok=True)
    
    docroot = DOCROOT_BASE / domain
    if not docroot.exists():
        print(f"Domain docroot bulunamadÄ±: {docroot}")
        return None
    
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    backup_file = backup_dir / f"{domain}_{timestamp}.tar.gz"
    run(f"tar -czf {backup_file} -C {docroot.parent} {domain}", check=True)
    checksum = run(f"sha256sum {backup_file}", check=True).stdout.strip().split()[0]
    run(f"tar -tzf {backup_file} > /dev/null", check=True)
    print(f"Domain yedeÄŸi alÄ±ndÄ±: {backup_file}")
    print(f"SHA256: {checksum}")
    return str(backup_file)


def backup_database(db_name: str):
    backup_dir = ISPANEL_BACKUP_DIR / "databases"
    backup_dir.mkdir(parents=True, exist_ok=True)
    
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    backup_file = backup_dir / f"{db_name}_{timestamp}.sql"
    
    run(f"mysqldump -uroot {db_name} > {backup_file}", check=True)

    checksum = run(f"sha256sum {backup_file}", check=True).stdout.strip().split()[0]
    run(f'mysql -uroot -e "USE {db_name}"', check=False)
    print(f"VeritabanÄ± yedeÄŸi alÄ±ndÄ±: {backup_file}")
    print(f"SHA256: {checksum}")
    return str(backup_file)


def restore_domain(backup_file: str):
    path = Path(backup_file)
    if not path.exists():
        print(f"Yedek dosyasÄ± bulunamadÄ±: {backup_file}")
        return False
    
    run(f"tar -xzf {path} -C {DOCROOT_BASE.parent}", check=True)
    print(f"Domain yedeÄŸi geri yÃ¼klendi: {path}")
    return True


def restore_database(backup_file: str, db_name: str):
    path = Path(backup_file)
    if not path.exists():
        print(f"Yedek dosyasÄ± bulunamadÄ±: {backup_file}")
        return False
    
    run(f"mysql -uroot -e \"CREATE DATABASE IF NOT EXISTS {db_name}\"", check=True)
    run(f"mysql -uroot {db_name} < {path}", check=True)
    print(f"VeritabanÄ± yedeÄŸi geri yÃ¼klendi: {path}")
    return True


def fix_virtual_host_root(domain: str):
    """Mevcut domain'in Virtual Host Root'unu dÃ¼zelt"""
    if not HTTPD_CONF.exists():
        print(f"BulunamadÄ±: {HTTPD_CONF}", file=sys.stderr)
        return False

    content = HTTPD_CONF.read_text(encoding="utf-8")
    docroot = DOCROOT_BASE / domain

    # Mevcut virtualHost bloÄŸunu bul ve gÃ¼ncelle
    pattern = rf"virtualHost\s+{re.escape(domain)}\s*\{{[^}}]*\}}"
    match = re.search(pattern, content, re.DOTALL)

    if match:
        old_block = match.group(0)
        new_block = f"""virtualHost {domain} {{
    vhRoot                  {docroot}
    configFile              conf/vhosts/{domain}/vhost.conf
    allowSymbolLink         1
    enableScript            1
    restrained              1
}}"""
        content = content.replace(old_block, new_block)
        HTTPD_CONF.write_text(content, encoding="utf-8")
        print(f"âœ… {domain} Virtual Host Root dÃ¼zeltildi: {docroot}")
        return True
    else:
        print(f"âŒ {domain} virtualHost bloÄŸu bulunamadÄ±")
        return False


def fix_vhost_config(domain: str):
    """Mevcut domain'in vhost konfigÃ¼rasyonunu standart yapÄ±ya gÃ¼ncelle"""
    vdir = VHOSTS_DIR / domain
    if not vdir.exists():
        print(f"âŒ {domain} vhost dizini bulunamadÄ±")
        return False

    vconf = vdir / "vhost.conf"
    if not vconf.exists():
        print(f"âŒ {domain} vhost.conf bulunamadÄ±")
        return False

    # Yeni standart konfigÃ¼rasyonu oluÅŸtur
    docroot = DOCROOT_BASE / domain / "public_html"
    vh_root = docroot.parent

    # Gerekli dizinleri oluÅŸtur
    log_dir = vh_root / "logs"
    log_dir.mkdir(parents=True, exist_ok=True)
    (log_dir / "access.log").touch(exist_ok=True)
    (log_dir / "error.log").touch(exist_ok=True)

    cgi_dir = vh_root / "cgi-bin"
    cgi_dir.mkdir(parents=True, exist_ok=True)

    protected_dir = docroot / "protected"
    protected_dir.mkdir(parents=True, exist_ok=True)

    awstats_dir = vh_root / "awstats"
    awstats_dir.mkdir(parents=True, exist_ok=True)

    conf = f"""docRoot $VH_ROOT/public_html/
enableGzip 1

context / {{
  allowBrowse 1
  location $DOC_ROOT/
  rewrite  {{
    RewriteFile .htaccess
  }}
}}

context /docs/{{
  allowBrowse 1
  location $SERVER_ROOT/docs/
}}

context /protected/{{
  required user test
  authName Protected
  allowBrowse 1
  location protected/
  realm SampleProtectedArea

  accessControl {{
    deny
    allow *
  }}
}}

context /blocked/{{
  allowBrowse 0
}}

context /cgi-bin/{{
  allowBrowse 1
  location $VH_ROOT/cgi-bin/
  type cgi
}}

expires {{
  enableExpires 1
}}

index {{
  autoIndexURI /_autoindex/default.php
  indexFiles index.html, index.php
  autoIndex 0
  useServer 0
}}

errorPage 404{{
  url /error404.html
}}

errorlog $VH_ROOT/logs/error.log{{
  logLevel DEBUG
  rollingSize 10M
  useServer 1
}}

accessLog $VH_ROOT/logs/access.log{{
  compressArchive 0
  logReferer 1
  keepDays 30
  rollingSize 10M
  logUserAgent 1
  useServer 0
}}

awstats {{
  updateInterval 86400
  workingDir $VH_ROOT/awstats
  updateOffset 0
  siteDomain {domain}
  siteAliases 127.0.0.1 localhost
  updateMode 0
  awstatsURI /awstats/
}}

rewrite {{
  enable 0
  logLevel 0
}}

hotlinkCtrl {{
  suffixes gif, jpeg, jpg, png, css, js
  allowedHosts
  allowDirectAccess 1
  enableHotlinkCtrl 0
  onlySelf 1
}}

accessControl {{
  deny
  allow *
}}

realm SampleProtectedArea {{
  userDB {{
    cacheTimeout 60
    maxCacheSize 200
    location conf/vhosts/$VH_NAME/htpasswd
  }}

  groupDB {{
    cacheTimeout 60
    maxCacheSize 200
    location conf/vhosts/$VH_NAME/htgroup
  }}
}}

general {{
  enableContextAC 0
}}

scriptHandler {{
    add                    lsapi:lsphp{DEFAULT_LSPHP_VERSION} php
}}

phpIniOverride  {{
}}

    # OpenLiteSpeed Cache Configuration
    # OLS Cache kapalÄ± (menÃ¼den etkinleÅŸtirilebilir)
""".strip()

    vconf.write_text(conf, encoding="utf-8")

    # Dizin izinlerini ayarla
    run(f"chown -R lsadm:nogroup {vdir}", check=True)
    run(f"chmod -R 755 {vdir}", check=True)
    run(f"chown -R lsadm:nogroup {vh_root}", check=False)
    run(f"chmod -R 755 {vh_root}", check=False)

    print(f"âœ… {domain} vhost konfigÃ¼rasyonu standart yapÄ±ya gÃ¼ncellendi")
    return True


def _read_virtual_host_settings(domain: str, docroot: Path) -> tuple[str, str]:
    """Return php version and ssl status."""
    vconf = VHOSTS_DIR / domain / "vhost.conf"
    php = "bilinmiyor"
    if vconf.exists():
        content = vconf.read_text(encoding="utf-8")
        m = re.search(r"lsapi:lsphp(\d+)", content)
        if m:
            php = f"lsphp{m.group(1)}"
    ssl_dir = Path(f"/etc/letsencrypt/live/{domain}")
    ssl = "Var" if ssl_dir.exists() else "Yok"
    return php, ssl


def _get_owner_info(path: Path) -> tuple[str, str]:
    try:
        stat = path.stat()
        owner = getpwuid(stat.st_uid).pw_name
        group = getgrgid(stat.st_gid).gr_name
        return owner, group
    except Exception:
        return "bilinmiyor", "bilinmiyor"


def list_domains():
    print("\n=== Aktif Domainler ===")

    if not VHOSTS_DIR.exists():
        print("Vhost dizini bulunamadÄ±.")
        return

    rows = []
    for domain_dir in VHOSTS_DIR.iterdir():
        if domain_dir.is_dir() and domain_dir.name != "Example":
            domain = domain_dir.name
            docroot = DOCROOT_BASE / domain / "public_html"
            vh_root = docroot.parent
            vhost_conf = domain_dir / "vhost.conf"
            owner, group = (
                _get_owner_info(vh_root)
                if vh_root.exists()
                else ("bilinmiyor", "bilinmiyor")
            )
            php, ssl = _read_virtual_host_settings(domain, docroot)
            access_log = vh_root / "logs" / "access.log"
            error_log = vh_root / "logs" / "error.log"
            rows.append(
                {
                    "domain": domain,
                    "docroot": str(docroot),
                    "exists": docroot.exists(),
                    "vhost_exists": vhost_conf.exists(),
                    "owner": f"{owner}:{group}",
                    "php": php,
                    "ssl": ssl,
                    "access_log": str(access_log),
                    "error_log": str(error_log),
                }
            )

    if not rows:
        print("HiÃ§ domain bulunamadÄ±.")
        return

    header = f"{'Domain':<20} {'Docroot':<30} {'Sahip':<18} {'PHP':<10} {'SSL':<5}"
    print(header)
    print("-" * len(header))

    for info in rows:
        status = "âœ…" if info["exists"] and info["vhost_exists"] else "âŒ"
        print(
            f"{info['domain']:<20} {info['docroot']:<30} {info['owner']:<18} {info['php']:<10} {info['ssl']:<5} {status}"
        )
        print(f"  Access log: {info['access_log']}")
        print(f"  Error log : {info['error_log']}")
        if info["vhost_exists"]:
            print(f"  ðŸ”§ Virtual Host Root dÃ¼zelt: ispanel fix-vhost {info['domain']}")


def list_databases():
    print("\n=== VeritabanlarÄ± ===")

    try:
        result = run("mysql -uroot -e 'SHOW DATABASES;'", check=False)
        if result.returncode != 0 or not result.stdout:
            print("MariaDB baÄŸlantÄ± hatasÄ±. Servis Ã§alÄ±ÅŸÄ±yor mu kontrol edin.")
            return

        databases = []
        for line in result.stdout.strip().split("\n"):
            line = line.strip()
            if line and line not in [
                "Database",
                "information_schema",
                "performance_schema",
                "mysql",
                "sys",
            ]:
                databases.append(line)

        if not databases:
            print("HiÃ§ veritabanÄ± bulunamadÄ±.")
            return

        print(
            f"{'VeritabanÄ±':<20} {'Boyut (MB)':<12} {'Son GÃ¼ncellenme':<22} {'Tablo SayÄ±sÄ±':<12}"
        )
        print("-" * 72)

        for db in databases:
            size_query = (
                "SELECT IFNULL(ROUND(SUM(data_length + index_length) / 1024 / 1024, 2), 0) "
                'FROM information_schema.tables WHERE table_schema="%s";' % db
            )
            count_query = (
                'SELECT COUNT(*) FROM information_schema.tables WHERE table_schema="%s";'
                % db
            )
            date_query = (
                "SELECT DATE_FORMAT(MAX(update_time), '%Y-%m-%d %H:%i:%s') "
                'FROM information_schema.tables WHERE table_schema="%s";' % db
            )

            size_result = run(f'mysql -uroot -e "{size_query}"', check=False)
            size_value = (
                size_result.stdout.strip().split("\n")[-1]
                if size_result.stdout
                else "0"
            )

            count_result = run(f'mysql -uroot -e "{count_query}"', check=False)
            count_value = (
                count_result.stdout.strip().split("\n")[-1]
                if count_result.stdout
                else "0"
            )

            date_result = run(f'mysql -uroot -e "{date_query}"', check=False)
            date_value = (
                date_result.stdout.strip().split("\n")[-1]
                if date_result.stdout
                else "N/A"
            )

            print(f"{db:<20} {size_value:<12} {date_value:<22} {count_value:<12}")

    except Exception as e:
        print(f"VeritabanÄ± listesi alÄ±namadÄ±: {e}")


def list_backups():
    """Yedek Ã¶zetlerini listele."""

    def summarize(title: str, pattern: str, base: Path):
        print(f"\n=== {title} ===")
        if not base.exists():
            print(f"Dizin bulunamadÄ±: {base}")
            return
        backups = sorted(base.glob(pattern))
        if not backups:
            print("HenÃ¼z yedek yok.")
            return
        for backup in backups:
            size_mb = backup.stat().st_size / (1024 * 1024)
            checksum_file = backup.with_suffix(backup.suffix + ".sha256")
            checksum = (
                checksum_file.read_text(encoding="utf-8").strip()
                if checksum_file.exists()
                else "(hesaplanmadÄ±)"
            )
            print(f"- {backup.name} ({size_mb:.2f} MB) | SHA256: {checksum}")

    summarize("Domain Yedekleri", "*.tar.gz", ISPANEL_BACKUP_DIR / "domains")
    summarize("VeritabanÄ± Yedekleri", "*.sql", ISPANEL_BACKUP_DIR / "databases")


def install_htaccess_watcher():
    """
    .htaccess dosyalarÄ±ndaki deÄŸiÅŸiklikleri izle ve OpenLiteSpeed'i restart et
    inotify-tools kullanarak real-time monitoring
    """
    print("=== .htaccess Watcher Kuruluyor ===")
    
    # inotify-tools kur
    run("DEBIAN_FRONTEND=noninteractive apt-get update -y", check=False)
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y inotify-tools", check=True)
    
    # Watcher script oluÅŸtur
    watcher_script = Path("/usr/local/ispanel/htaccess-watcher.sh")
    watcher_script.parent.mkdir(parents=True, exist_ok=True)
    
    script_content = """#!/bin/bash
# isPanel .htaccess Watcher
# .htaccess dosyalarÄ±ndaki deÄŸiÅŸiklikleri izler ve OpenLiteSpeed'i restart eder

LOG_FILE="/var/log/ispanel-htaccess-watcher.log"
WATCH_DIR="/home"

echo "$(date): .htaccess watcher baÅŸlatÄ±ldÄ±" >> "$LOG_FILE"

# inotifywait ile .htaccess dosyalarÄ±nÄ± izle
inotifywait -m -r -e modify,create,delete,move --include '\.htaccess$' "$WATCH_DIR" | while read -r directory events filename; do
    echo "$(date): .htaccess deÄŸiÅŸikliÄŸi tespit edildi: $directory$filename" >> "$LOG_FILE"
    
    # 2 saniye bekle (birden fazla deÄŸiÅŸiklik varsa toplu restart iÃ§in)
    sleep 2
    
    # OpenLiteSpeed'i graceful restart et
    echo "$(date): OpenLiteSpeed restart ediliyor..." >> "$LOG_FILE"
    /usr/local/lsws/bin/lswsctrl restart >> "$LOG_FILE" 2>&1
    
    if [ $? -eq 0 ]; then
        echo "$(date): OpenLiteSpeed baÅŸarÄ±yla restart edildi" >> "$LOG_FILE"
    else
        echo "$(date): OpenLiteSpeed restart hatasÄ±!" >> "$LOG_FILE"
    fi
done
"""
    
    watcher_script.write_text(script_content, encoding="utf-8")
    watcher_script.chmod(0o755)
    
    # Systemd service oluÅŸtur
    service_content = """[Unit]
Description=isPanel .htaccess File Watcher
After=network.target lsws.service

[Service]
Type=simple
ExecStart=/usr/local/ispanel/htaccess-watcher.sh
Restart=always
RestartSec=10
StandardOutput=append:/var/log/ispanel-htaccess-watcher.log
StandardError=append:/var/log/ispanel-htaccess-watcher.log

[Install]
WantedBy=multi-user.target
"""
    
    service_file = Path("/etc/systemd/system/ispanel-htaccess-watcher.service")
    service_file.write_text(service_content, encoding="utf-8")
    
    # Service'i etkinleÅŸtir ve baÅŸlat
    run("systemctl daemon-reload", check=True)
    run("systemctl enable ispanel-htaccess-watcher.service", check=True)
    run("systemctl start ispanel-htaccess-watcher.service", check=True)
    
    # Log dosyasÄ± oluÅŸtur
    Path("/var/log/ispanel-htaccess-watcher.log").touch()
    
    print("âœ… .htaccess watcher kuruldu ve baÅŸlatÄ±ldÄ±")
    print("   Log: /var/log/ispanel-htaccess-watcher.log")
    print("   Service: ispanel-htaccess-watcher.service")
    print("   Durum: systemctl status ispanel-htaccess-watcher")


def check_htaccess_watcher_status():
    """htaccess watcher durumunu kontrol et"""
    result = subprocess.run(
        ["systemctl", "is-active", "ispanel-htaccess-watcher.service"],
        capture_output=True,
        text=True
    )
    
    if result.returncode == 0 and result.stdout.strip() == "active":
        print("âœ… .htaccess watcher Ã§alÄ±ÅŸÄ±yor")
        # Son 10 satÄ±rÄ± gÃ¶ster
        try:
            log_content = Path("/var/log/ispanel-htaccess-watcher.log").read_text(encoding="utf-8")
            lines = log_content.strip().split("\n")[-10:]
            print("\nðŸ“‹ Son loglar:")
            for line in lines:
                print(f"   {line}")
        except Exception:
            pass
    else:
        print("âŒ .htaccess watcher Ã§alÄ±ÅŸmÄ±yor")
        print("   BaÅŸlatmak iÃ§in: systemctl start ispanel-htaccess-watcher")


def install_cron():
    ensure_cmd("crontab", "cron")


def cron_add(line: str):
    install_cron()
    # mevcut crontab al
    cp = subprocess.run(
        "crontab -l",
        shell=True,
        text=True,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
    )
    current = cp.stdout if cp.returncode == 0 else ""
    if line in current:
        print("Cron zaten mevcut")
        return
    new = (
        current + ("\n" if current and not current.endswith("\n") else "") + line + "\n"
    )
    p = subprocess.run("crontab -", shell=True, input=new, text=True)
    if p.returncode == 0:
        print("Cron eklendi")
    else:
        print("Cron eklenemedi", file=sys.stderr)


def get_cron_jobs():
    """Mevcut cron job'larÄ± listele ve dÃ¶ndÃ¼r"""
    install_cron()
    try:
        result = subprocess.run(
            "crontab -l",
            shell=True,
            text=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
        )
        if result.returncode == 0 and result.stdout.strip():
            lines = result.stdout.strip().split("\n")
            # BoÅŸ satÄ±rlarÄ± ve yorum satÄ±rlarÄ±nÄ± filtrele
            jobs = []
            for line in lines:
                line = line.strip()
                if line and not line.startswith("#") and not line.startswith("SHELL=") and not line.startswith("PATH=") and not line.startswith("MAILTO="):
                    jobs.append(line)
            return jobs
        return []
    except Exception as e:
        print(f"âŒ Cron job'lar alÄ±namadÄ±: {e}")
        return []


def list_cron_jobs():
    """Cron job'larÄ± numaralÄ± liste olarak gÃ¶ster"""
    jobs = get_cron_jobs()
    
    if not jobs:
        print(f"â„¹ï¸  {get_text('cron_no_jobs')}")
        return
    
    print(f"\n{'='*70}")
    print(f"ðŸ“‹ {get_text('cron_list_jobs')}")
    print(f"{'='*70}\n")
    
    for idx, job in enumerate(jobs, 1):
        # Cron formatÄ±nÄ± parse et
        parts = job.split(None, 5)
        if len(parts) >= 6:
            schedule = " ".join(parts[:5])
            command = parts[5]
            print(f"{idx:2d}) Schedule: {schedule}")
            print(f"    Command: {command}")
        else:
            print(f"{idx:2d}) {job}")
        print()
    
    print(f"{'='*70}")


def validate_cron_schedule(schedule: str) -> bool:
    """Cron zamanlama formatÄ±nÄ± doÄŸrula"""
    parts = schedule.split()
    if len(parts) != 5:
        return False
    
    # Basit format kontrolÃ¼ (daha detaylÄ± regex eklenebilir)
    for part in parts:
        if not (part.isdigit() or part == "*" or "," in part or "-" in part or "/" in part or part in ["*", "?", "L", "W"]):
            # Daha karmaÅŸÄ±k formatlar iÃ§in basit kontrol
            if not any(c.isdigit() or c in "*,-/LW?" for c in part):
                return False
    
    return True


def add_cron_job_interactive():
    """Ä°nteraktif olarak yeni cron job ekle"""
    print(f"\n{'='*70}")
    print(f"âž• {get_text('cron_add_job')}")
    print(f"{'='*70}\n")
    
    # Zamanlama
    schedule = input(f"{get_text('cron_schedule_prompt')}: ").strip()
    if not schedule:
        print(f"âŒ {get_text('cron_invalid_schedule')}")
        return False
    
    if not validate_cron_schedule(schedule):
        print(f"âŒ {get_text('cron_invalid_schedule')}")
        print("   Format: minute hour day month weekday")
        print("   Example: 0 2 * * * (daily at 2 AM)")
        return False
    
    # Komut
    command = input(f"{get_text('cron_command_prompt')}: ").strip()
    if not command:
        print("âŒ Command is required")
        return False
    
    # AÃ§Ä±klama
    comment = input(f"{get_text('cron_comment_prompt')}: ").strip()
    
    # Domain (opsiyonel)
    domain = input(f"{get_text('cron_domain_prompt')}: ").strip()
    
    # Cron satÄ±rÄ± oluÅŸtur
    cron_line = f"{schedule} {command}"
    
    # AÃ§Ä±klama varsa yorum satÄ±rÄ± olarak ekle
    if comment or domain:
        comment_text = f"# isPanel: {comment}" if comment else "# isPanel"
        if domain:
            comment_text += f" [Domain: {domain}]"
        cron_line = f"{comment_text}\n{cron_line}"
    
    # Cron ekle
    install_cron()
    cp = subprocess.run(
        "crontab -l",
        shell=True,
        text=True,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
    )
    current = cp.stdout if cp.returncode == 0 else ""
    
    # Duplicate kontrolÃ¼
    if cron_line.strip() in current:
        print("âš ï¸  Bu cron job zaten mevcut")
        return False
    
    new = current + ("\n" if current and not current.endswith("\n") else "") + cron_line + "\n"
    
    p = subprocess.run("crontab -", shell=True, input=new, text=True)
    if p.returncode == 0:
        print(f"âœ… {get_text('cron_job_added')}")
        return True
    else:
        print("âŒ Cron job eklenemedi")
        return False


def delete_cron_job():
    """Cron job sil"""
    jobs = get_cron_jobs()
    
    if not jobs:
        print(f"â„¹ï¸  {get_text('cron_no_jobs')}")
        return False
    
    list_cron_jobs()
    
    try:
        job_num = input(f"\n{get_text('cron_select_job')}: ").strip()
        job_idx = int(job_num) - 1
        
        if job_idx < 0 or job_idx >= len(jobs):
            print(f"âŒ {get_text('cron_job_not_found')}")
            return False
        
        job_to_delete = jobs[job_idx]
        
        # Onay
        confirm = input(f"{get_text('cron_confirm_delete')}: ").strip().lower()
        if confirm not in ["e", "y", "yes"]:
            print(f"âŒ {get_text('mysql_remote_operation_cancelled')}")
            return False
        
        # Mevcut crontab'Ä± al
        cp = subprocess.run(
            "crontab -l",
            shell=True,
            text=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
        )
        if cp.returncode != 0:
            print("âŒ Crontab okunamadÄ±")
            return False
        
        lines = cp.stdout.split("\n")
        new_lines = []
        skip_next = False
        
        for i, line in enumerate(lines):
            # Silinecek job'Ä± bul
            if job_to_delete in line and not line.strip().startswith("#"):
                # Ã–nceki satÄ±r yorum satÄ±rÄ±ysa onu da sil
                if i > 0 and lines[i-1].strip().startswith("#") and "isPanel" in lines[i-1]:
                    continue
                skip_next = True
                continue
            
            if skip_next and line.strip() == "":
                skip_next = False
                continue
            
            if not skip_next:
                new_lines.append(line)
        
        # Yeni crontab'Ä± yaz
        new_crontab = "\n".join(new_lines)
        if new_crontab.strip():
            new_crontab += "\n"
        
        p = subprocess.run("crontab -", shell=True, input=new_crontab, text=True)
        if p.returncode == 0:
            print(f"âœ… {get_text('cron_job_deleted')}")
            return True
        else:
            print("âŒ Cron job silinemedi")
            return False
            
    except ValueError:
        print("âŒ GeÃ§ersiz numara")
        return False
    except Exception as e:
        print(f"âŒ Hata: {e}")
        return False


def view_cron_logs():
    """Cron log'larÄ±nÄ± gÃ¶rÃ¼ntÃ¼le"""
    print(f"\n{'='*70}")
    print(f"ðŸ“‹ {get_text('cron_view_logs')}")
    print(f"{'='*70}\n")
    
    # Cron log dosyasÄ± genellikle /var/log/syslog veya /var/log/cron.log
    log_files = [
        "/var/log/cron.log",
        "/var/log/syslog",
        "/var/log/auth.log"
    ]
    
    found_log = None
    for log_file in log_files:
        if Path(log_file).exists():
            found_log = log_file
            break
    
    if not found_log:
        print("âš ï¸  Cron log dosyasÄ± bulunamadÄ±")
        print("   Log dosyalarÄ± genellikle ÅŸu konumlarda bulunur:")
        for log_file in log_files:
            print(f"   - {log_file}")
        return
    
    print(f"ðŸ“„ Log dosyasÄ±: {found_log}\n")
    
    try:
        # Son 50 satÄ±rÄ± gÃ¶ster
        result = run(f"tail -n 50 {found_log} | grep -i cron", check=False)
        if result.stdout:
            print(result.stdout)
        else:
            print("â„¹ï¸  Son cron log kaydÄ± bulunamadÄ±")
    except Exception as e:
        print(f"âŒ Log okunamadÄ±: {e}")


def test_cron_job():
    """Cron job'Ä± test et (hemen Ã§alÄ±ÅŸtÄ±r)"""
    jobs = get_cron_jobs()
    
    if not jobs:
        print(f"â„¹ï¸  {get_text('cron_no_jobs')}")
        return False
    
    list_cron_jobs()
    
    try:
        job_num = input(f"\n{get_text('cron_select_job')}: ").strip()
        job_idx = int(job_num) - 1
        
        if job_idx < 0 or job_idx >= len(jobs):
            print(f"âŒ {get_text('cron_job_not_found')}")
            return False
        
        job = jobs[job_idx]
        # Komut kÄ±smÄ±nÄ± al (ilk 5 alan zamanlama)
        parts = job.split(None, 5)
        if len(parts) >= 6:
            command = parts[5]
        else:
            command = job
        
        print(f"\nðŸ§ª Test ediliyor: {command}\n")
        
        # Komutu Ã§alÄ±ÅŸtÄ±r
        result = run(command, check=False)
        if result.returncode == 0:
            print(f"âœ… Komut baÅŸarÄ±yla Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±")
            if result.stdout:
                print(f"\nÃ‡Ä±ktÄ±:\n{result.stdout}")
        else:
            print(f"âŒ Komut hata verdi (exit code: {result.returncode})")
            if result.stderr:
                print(f"\nHata:\n{result.stderr}")
        
        return True
        
    except ValueError:
        print("âŒ GeÃ§ersiz numara")
        return False
    except Exception as e:
        print(f"âŒ Hata: {e}")
        return False


def cron_job_management_menu():
    """GeliÅŸmiÅŸ Cron Job YÃ¶netim MenÃ¼sÃ¼"""
    while True:
        print("\n" + "="*70)
        print(f"â° {get_text('cron_menu_title').upper()}")
        print("="*70)
        print(f"1) ðŸ“‹ {get_text('cron_list_jobs')}")
        print(f"2) âž• {get_text('cron_add_job')}")
        print(f"3) âœï¸  {get_text('cron_edit_job')}")
        print(f"4) ðŸ—‘ï¸  {get_text('cron_delete_job')}")
        print(f"5) ðŸ“„ {get_text('cron_view_logs')}")
        print(f"6) ðŸ§ª {get_text('cron_test_job')}")
        print(f"0) ðŸ”™ {get_text('cron_back_to_menu')}")
        print("="*70)
        
        choice = input(f"\n{get_text('enter_choice')}: ").strip()
        
        if choice == "1":
            list_cron_jobs()
            
        elif choice == "2":
            add_cron_job_interactive()
            
        elif choice == "3":
            # Edit iÃ§in Ã¶nce listele, sonra sil ve yeni ekle
            jobs = get_cron_jobs()
            if not jobs:
                print(f"â„¹ï¸  {get_text('cron_no_jobs')}")
            else:
                list_cron_jobs()
                job_num = input(f"\n{get_text('cron_select_job')} (dÃ¼zenlemek iÃ§in): ").strip()
                try:
                    job_idx = int(job_num) - 1
                    if 0 <= job_idx < len(jobs):
                        # Mevcut job'Ä± gÃ¶ster
                        print(f"\nðŸ“ Mevcut job: {jobs[job_idx]}")
                        print("\nYeni bilgileri girin (boÅŸ bÄ±rakÄ±rsanÄ±z mevcut deÄŸer kullanÄ±lÄ±r):\n")
                        
                        # Ã–nce sil
                        delete_cron_job()
                        # Sonra yeni ekle
                        add_cron_job_interactive()
                    else:
                        print(f"âŒ {get_text('cron_job_not_found')}")
                except ValueError:
                    print("âŒ GeÃ§ersiz numara")
            
        elif choice == "4":
            delete_cron_job()
            
        elif choice == "5":
            view_cron_logs()
            
        elif choice == "6":
            test_cron_job()
            
        elif choice == "0":
            break
            
        else:
            print(f"âŒ {get_text('invalid_choice')}")
        
        if choice != "0":
            input(f"\n{get_text('cron_press_enter')}")


def cron_backup_menu():
    while True:
        print("\n--- Cron Backup AyarlarÄ± ---")
        print("1) GÃ¼nlÃ¼k DB yedeÄŸi kur (02:30)")
        print("2) GÃ¼nlÃ¼k Dosya yedeÄŸi kur (03:00)")
        print("3) Cron listele")
        print("4) Fail2Ban'i tekrar baÅŸlat")
        print("0) Geri")
        sub = input("SeÃ§im: ").strip()
        if sub == "1":
            db = input("Yedeklenecek DB adÄ±: ").strip()
            backup_dir = str(ISPANEL_BACKUP_DIR / "databases")
            line = f"30 2 * * * mysqldump -uroot {db} > {backup_dir}/{db}_$(date +\\%Y\\%m\\%d).sql"
            cron_add(line)
        elif sub == "2":
            domain = input("Yedeklenecek domain: ").strip()
            backup_dir = str(ISPANEL_BACKUP_DIR / "domains")
            line = f"0 3 * * * tar -czf {backup_dir}/{domain}_$(date +\\%Y\\%m\\%d).tar.gz -C {DOCROOT_BASE} {domain}"
            cron_add(line)
        elif sub == "3":
            subprocess.run("crontab -l | cat", shell=True)
        elif sub == "4":
            subprocess.run("systemctl enable fail2ban", shell=True, check=False)
            subprocess.run("systemctl restart fail2ban", shell=True, check=False)
            print("Fail2Ban yeniden baÅŸlatÄ±ldÄ±.")
        elif sub == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")


def domain_php_version_menu():
    """Domain PHP sÃ¼rÃ¼mÃ¼ deÄŸiÅŸtirme menÃ¼sÃ¼"""
    print(f"\n=== {get_text('php_version_prompt')} ===")

    # Mevcut domainleri listele
    domains = []
    if VHOSTS_DIR.exists():
        for vhost_dir in VHOSTS_DIR.iterdir():
            if vhost_dir.is_dir() and vhost_dir.name not in ["Example"]:
                vconf = vhost_dir / "vhost.conf"
                if vconf.exists():
                    # Mevcut PHP sÃ¼rÃ¼mÃ¼nÃ¼ bul
                    content = vconf.read_text(encoding="utf-8")
                    current_version = "83"  # varsayÄ±lan
                    if "lsphp82" in content:
                        current_version = "82"
                    elif "lsphp83" in content:
                        current_version = "83"

                    domains.append((vhost_dir.name, current_version))

    if not domains:
        print(get_text("no_domains"))
        input(get_text("press_enter"))
        return

    print(f"\n{get_text('main_menu_options')[3]}:")  # Domain List
    for i, (domain, version) in enumerate(domains, 1):
        print(f"{i}) {domain} (PHP {version[0]}.{version[1]})")

    print("0) " + get_text("main_menu_options")[-1])  # Exit/Ã‡Ä±kÄ±ÅŸ

    choice = input(f"\n{get_text('domain_prompt')}: ").strip()
    if choice == "0":
        return

    try:
        idx = int(choice) - 1
        if 0 <= idx < len(domains):
            domain = domains[idx][0]
            current_version = domains[idx][1]

            print(f"\n{domain} {get_text('php_version_prompt')}:")
            print(f"Current: PHP {current_version[0]}.{current_version[1]}")
            php_versions = get_text("php_versions")
            for i, version in enumerate(php_versions, 1):
                print(f"{i}) {version}")
            print("0) " + get_text("main_menu_options")[-1])  # Exit/Ã‡Ä±kÄ±ÅŸ

            version_choice = input(f"{get_text('enter_choice')}: ").strip()

            if version_choice == "1":
                set_domain_php_version(domain, "82")
                print(f"âœ… {domain} PHP 8.2'ye geÃ§irildi")
            elif version_choice == "2":
                set_domain_php_version(domain, "83")
                print(f"âœ… {domain} PHP 8.3'e geÃ§irildi")
            elif version_choice == "0":
                return

            input(get_text("press_enter"))
    except BaseException:
        print(get_text("invalid_choice"))
        input(get_text("press_enter"))

def interactive_menu():
    while True:
        try:
            print(f"\n{'='*60}")
            print(f"ðŸŽ¯ {get_text('main_menu_title')}")
            print(f"{'='*60}")
            
            # Renk kodlarÄ±
            RED = '\033[91m'
            GREEN = '\033[92m'
            YELLOW = '\033[93m'
            BLUE = '\033[94m'
            PURPLE = '\033[95m'
            CYAN = '\033[96m'
            WHITE = '\033[97m'
            BOLD = '\033[1m'
            RESET = '\033[0m'
            
            # MenÃ¼ seÃ§eneklerini kategorize et
            menu_options = get_text("main_menu_options")
            
            # ðŸš€ INSTALL/SETUP
            print(f"\n{BOLD}{CYAN}ðŸš€ {get_text('section_install')}{RESET}")
            print(f"{GREEN}1){RESET} {menu_options[0]}")
            print(f"{GREEN}2){RESET} {menu_options[1]}")
            print(f"{GREEN}3){RESET} {menu_options[2]}")
            
            # ðŸŒ DOMAIN
            print(f"\n{BOLD}{BLUE}ðŸŒ {get_text('section_domain')}{RESET}")
            print(f"{YELLOW}4){RESET} {menu_options[3]}")
            print(f"{YELLOW}5){RESET} {menu_options[4]}")
            print(f"{YELLOW}6){RESET} {menu_options[5]}")
            print(f"{YELLOW}7){RESET} {menu_options[6]}")
            
            # ðŸ—„ï¸ DATABASE
            print(f"\n{BOLD}{PURPLE}ðŸ—„ï¸ {get_text('section_db')}{RESET}")
            print(f"{PURPLE}8){RESET} {menu_options[7]}")
            print(f"{PURPLE}9){RESET} {menu_options[8]}")
            print(f"{PURPLE}10){RESET} {menu_options[9]}")
            print(f"{PURPLE}33){RESET} ðŸŒ {get_text('mysql_remote_menu_title')}")
            print(f"{PURPLE}34){RESET} â° {get_text('cron_menu_title')}")
            
            # ðŸ”§ SYSTEM
            print(f"\n{BOLD}{RED}ðŸ”§ {get_text('section_system')}{RESET}")
            print(f"{RED}11){RESET} {menu_options[10]}")
            print(f"{RED}12){RESET} {menu_options[11]}")
            print(f"{RED}13){RESET} {menu_options[12]}")
            print(f"{RED}14){RESET} {menu_options[13]}")
            print(f"{RED}15){RESET} {menu_options[14]}")
            print(f"{RED}16){RESET} {menu_options[15]}")
            print(f"{RED}17){RESET} {menu_options[16]}")
            print(f"{RED}18){RESET} {menu_options[17]}")
            
            # ðŸ’¾ BACKUP
            print(f"\n{BOLD}{CYAN}ðŸ’¾ {get_text('section_backup')}{RESET}")
            print(f"{CYAN}19){RESET} {menu_options[18]}")
            print(f"{CYAN}20){RESET} {menu_options[19]}")
            print(f"{CYAN}21){RESET} {menu_options[20]}")
            print(f"{CYAN}22){RESET} {menu_options[21]}")
            
            # ðŸ› ï¸ TOOLS
            print(f"\n{BOLD}{YELLOW}ðŸ› ï¸ {get_text('section_tools')}{RESET}")
            print(f"{YELLOW}23){RESET} {menu_options[22]}")
            print(f"{YELLOW}24){RESET} {menu_options[23]}")
            print(f"{YELLOW}25){RESET} {menu_options[24]}")
            print(f"{YELLOW}26){RESET} {menu_options[25]}")
            print(f"{YELLOW}27){RESET} {menu_options[26]}")
            
            # ðŸš¨ RECOVERY
            print(f"\n{BOLD}{RED}ðŸš¨ {get_text('section_recovery')}{RESET}")
            print(f"{RED}28){RESET} Emergency Backup")
            print(f"{RED}29){RESET} System Health Check")
            print(f"{RED}30){RESET} System Monitoring")
            print(f"{RED}31){RESET} Automatic Backup System")
            print(f"{RED}32){RESET} Update isPanel")
            
            # Ã‡IKIÅž
            print(f"\n{BOLD}{WHITE}0){RESET} {get_text('main_menu_options')[-1]}")
            print(f"{'='*60}")

            choice = input(f"\n{get_text('enter_choice')}: ").strip()
            
            if choice == "1":
                # Her iki PHP sÃ¼rÃ¼mÃ¼ de kurulacak
                cmd_install(argparse.Namespace(php_version="83"))
            elif choice == "2":
                install_openlitespeed_only()
            elif choice == "3":
                install_mariadb_only()
            elif choice == "4":
                domain = input(f"{get_text('domain_prompt')}: ").strip()
                domain_add(domain)
            elif choice == "5":
                domain_php_version_menu()
            elif choice == "6":
                list_domains()
            elif choice == "7":
                domain = input(f"{get_text('domain_prompt')}: ").strip()
                domain_remove(domain)
            elif choice == "8":
                db = input(f"{get_text('db_name_prompt')}: ").strip()
                user = input(f"{get_text('db_user_prompt')}: ").strip()
                password = input(f"{get_text('db_pass_prompt')}: ").strip()
                db_create(db, user, password)
            elif choice == "9":
                list_databases()
            elif choice == "10":
                db = input(f"{get_text('db_name_prompt')}: ").strip()
                user = input(f"{get_text('db_user_prompt')}: ").strip()
                db_delete(db, user)
            elif choice == "11":
                domain = input(f"{get_text('domain_prompt')}: ").strip()
                fix_virtual_host_root(domain)
            elif choice == "12":
                domain = input(f"{get_text('domain_prompt')}: ").strip()
                fix_vhost_config(domain)
            elif choice == "13":
                reset_mysql_root_password()
            elif choice == "14":
                reset_openlitespeed_admin_password()
            elif choice == "15":
                manage_firewall()
            elif choice == "16":
                install_ssl_support()
            elif choice == "17":
                secure_mariadb_menu()
            elif choice == "18":
                optimize_openlitespeed()
            elif choice == "19":
                backup_domain_menu()
            elif choice == "20":
                backup_database_menu()
            elif choice == "21":
                list_backups()
            elif choice == "22":
                cron_backup_menu()
            elif choice == "23":
                repair_menu()
            elif choice == "24":
                cache_menu()
            elif choice == "25":
                system_management_menu()
            elif choice == "26":
                ols_php_menu()
            elif choice == "27":
                ols_php_menu()
            elif choice == "28":
                emergency_recovery()
            elif choice == "29":
                system_health_check()
            elif choice == "30":
                system_monitoring()
            elif choice == "31":
                auto_backup_system()
            elif choice == "32":
                update_ispanel()
            elif choice == "33":
                mysql_remote_access_menu()
            elif choice == "34":
                cron_job_management_menu()
            elif choice == "0":
                break
            else:
                print("GeÃ§ersiz seÃ§im")

        except KeyboardInterrupt:
            print(f"\n\n{'='*60}")
            print("ðŸ‘‹ isPanel'den Ã§Ä±kÄ±ldÄ±!")
            print("ðŸ’¡ Tekrar giriÅŸ iÃ§in: sudo ispanel")
            print(f"{'='*60}")
            break
        except Exception as e:
            print(f"\nâŒ Beklenmeyen hata: {e}")
            print("ðŸ’¡ LÃ¼tfen tekrar deneyin veya sistem yÃ¶neticisine baÅŸvurun.")
            input("Devam etmek iÃ§in Enter'a basÄ±n...")

def backup_domain_menu():
    """Domain yedekleme menÃ¼sÃ¼"""
    while True:
        # File Backup Menu
        print(f"\n=== {get_text('main_menu_options')[16]} ===")
        print("1) " + get_text("domain_prompt"))
        print("2) " + get_text("main_menu_options")[18])  # List Backups
        print("0) " + get_text("main_menu_options")[-1])  # Exit

        choice = input(f"{get_text('enter_choice')}: ").strip()

        if choice == "1":
            domain = input(f"{get_text('domain_prompt')}: ").strip()
            backup_domain(domain)
        elif choice == "2":
            list_backups()
        elif choice == "0":
            break
        else:
            print(get_text("invalid_choice"))


def backup_database_menu():
    """VeritabanÄ± yedekleme menÃ¼sÃ¼"""
    while True:
        # Database Backup Menu
        print(f"\n=== {get_text('main_menu_options')[17]} ===")
        print("1) " + get_text("db_name_prompt"))
        print("2) " + get_text("main_menu_options")[18])  # List Backups
        print("0) " + get_text("main_menu_options")[-1])  # Exit

        choice = input(f"{get_text('enter_choice')}: ").strip()

        if choice == "1":
            db_name = input(f"{get_text('db_name_prompt')}: ").strip()
            backup_database(db_name)
        elif choice == "2":
            list_backups()
        elif choice == "0":
            break
        else:
            print(get_text("invalid_choice"))


def repair_menu():
    """OnarÄ±m araÃ§larÄ± menÃ¼sÃ¼"""
    while True:
        print(f"\n=== {get_text('main_menu_options')[20]} ===")  # Repair Tools
        print("1) Repair MariaDB")
        print("2) Repair OpenLiteSpeed")
        print("3) Repair PHP configuration")
        print("4) Check system status")
        print("0) " + get_text("main_menu_options")[-1])  # Exit

        choice = input(f"{get_text('enter_choice')}: ").strip()

        if choice == "1":
            repair_mariadb()
        elif choice == "2":
            repair_openlitespeed()
        elif choice == "3":
            repair_php_config()
        elif choice == "4":
            check_system_status()
        elif choice == "0":
            break
        else:
            print(get_text("invalid_choice"))


def repair_php_config():
    """PHP konfigÃ¼rasyonu onar"""
    try:
        run("systemctl restart lsws", check=True)
        print("âœ… PHP configuration reloaded")
    except Exception as e:
        print(f"âŒ PHP repair failed: {e}")


def check_system_status():
    """Sistem durumunu kontrol et"""
    try:
        print("\nðŸ” System Status Check:")

        # Check OpenLiteSpeed
        result = run("systemctl is-active lsws", check=False)
        print(f"OpenLiteSpeed: {'âœ… Active' if result.returncode == 0 else 'âŒ Inactive'}")

        # Check MariaDB
        result = run("systemctl is-active mariadb", check=False)
        print(f"MariaDB: {'âœ… Active' if result.returncode == 0 else 'âŒ Inactive'}")

        # Check disk space
        result = run("df -h /", check=True)
        print(f"\nðŸ’¾ Disk Usage:")
        print(result.stdout)

    except Exception as e:
        print(f"âŒ System check failed: {e}")


def cache_menu():
    """Cache sistemleri menÃ¼sÃ¼"""
    while True:
        # Cache Systems
        print(f"\n=== {get_text('main_menu_options')[21]} ===")
        print(f"1) {get_text('cache_install_redis')}")
        print(f"2) {get_text('cache_install_memcached')}")
        print(f"3) {get_text('cache_configure_redis')}")
        print(f"4) {get_text('cache_configure_memcached')}")
        print(f"5) {get_text('cache_toggle_domain')}")
        print("0) " + get_text("main_menu_options")[-1])  # Exit

        choice = input(f"{get_text('enter_choice')}: ").strip()

        if choice == "1":
            install_redis()
        elif choice == "2":
            install_memcached()
        elif choice == "3":
            configure_redis()
        elif choice == "4":
            configure_memcached()
        elif choice == "5":
            toggle_domain_cache_menu()
        elif choice == "0":
            break
        else:
            print(get_text("invalid_choice"))


def configure_redis():
    """Redis konfigÃ¼rasyonu"""
    try:
        print("âœ… Redis configuration completed")
    except Exception as e:
        print(f"âŒ Redis configuration failed: {e}")


def configure_memcached():
    """Memcached konfigÃ¼rasyonu"""
    try:
        print("âœ… Memcached configuration completed")
    except Exception as e:
        print(f"âŒ Memcached configuration failed: {e}")


def _enable_domain_ols_cache(domain: str) -> bool:
    """Belirtilen domain'in vhost.conf dosyasÄ±nda OLS cache'i etkinleÅŸtir."""
    vdir = VHOSTS_DIR / domain
    vconf = vdir / "vhost.conf"
    if not vconf.exists():
        print(f"âŒ {domain} vhost.conf bulunamadÄ±")
        return False
    content = vconf.read_text(encoding="utf-8")

    # Åžablondan oku
    tpl_path = TEMPLATE_DIR / "vhostCache.conf"
    if not tpl_path.exists():
        print(f"âŒ Template bulunamadÄ±: {tpl_path}")
        return False
    cache_module_block = tpl_path.read_text(encoding="utf-8").strip() + "\n"

    if not re.search(r"\bmodule\s+cache\s*\{", content, flags=re.IGNORECASE):
        content = content.rstrip() + "\n\n" + cache_module_block
    else:
        # Mevcut bloÄŸu komple ÅŸablonla deÄŸiÅŸtir
        content = re.sub(r"module\s+cache\s*\{[\s\S]*?\}\s*", cache_module_block, content, flags=re.IGNORECASE)

    vconf.write_text(content, encoding="utf-8")
    reload_lsws()
    print(f"âœ… OLS Cache etkinleÅŸtirildi: {domain}")
    return True


def _disable_domain_ols_cache(domain: str) -> bool:
    """Belirtilen domain iÃ§in OLS cache'i devre dÄ±ÅŸÄ± bÄ±rak."""
    vdir = VHOSTS_DIR / domain
    vconf = vdir / "vhost.conf"
    if not vconf.exists():
        print(f"âŒ {domain} vhost.conf bulunamadÄ±")
        return False
    content = vconf.read_text(encoding="utf-8")

    # module cache bloÄŸunda enableCache ve ls_enabled deÄŸerlerini 0 yap
    content = re.sub(r"(module\s+cache\s*\{[\s\S]*?\benableCache\s+)1", r"\g<1>0", content, flags=re.IGNORECASE)
    content = re.sub(r"(module\s+cache\s*\{[\s\S]*?\bls_enabled\s+)1", r"\g<1>0", content, flags=re.IGNORECASE)

    vconf.write_text(content, encoding="utf-8")
    reload_lsws()
    print(f"âœ… OLS Cache devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±: {domain}")
    return True


def get_domain_cache_status(domain: str) -> bool:
    """Domain'in vhost.conf dosyasÄ±nda cache etkin mi?"""
    try:
        vconf = VHOSTS_DIR / domain / "vhost.conf"
        if not vconf.exists():
            return False
        content = vconf.read_text(encoding="utf-8")
        # module cache bloÄŸunda enableCache 1 veya ls_enabled 1 ise aÃ§Ä±k kabul et
        if re.search(r"module\s+cache\s*\{[\s\S]*?enableCache\s+1", content, flags=re.IGNORECASE):
            return True
        if re.search(r"module\s+cache\s*\{[\s\S]*?ls_enabled\s+1", content, flags=re.IGNORECASE):
            return True
        return False
    except Exception:
        return False

def _ensure_server_cache_module():
    """Sunucu genelinde `module cache` bloÄŸu mevcut deÄŸilse httpd_config.conf iÃ§ine ekle."""
    try:
        if not HTTPD_CONF.exists():
            print(f"âš ï¸ Sunucu konfigÃ¼rasyonu bulunamadÄ±: {HTTPD_CONF}")
            return

        content = HTTPD_CONF.read_text(encoding="utf-8")
        if re.search(r"\bmodule\s+cache\b", content, flags=re.IGNORECASE):
            # Mevcut ise enable'i 1'e Ã§ekmeye Ã§alÄ±ÅŸ
            new_content = re.sub(r"(module\s+cache\s*\{[\s\S]*?\benable\s+)0",
                                 r"\g<1>1", content, flags=re.IGNORECASE)
            if new_content != content:
                HTTPD_CONF.write_text(new_content, encoding="utf-8")
                reload_lsws()
            return

        # Yoksa sona ekle
        module_block = (
            "\n# isPanel: OpenLiteSpeed Cache Module\n"
            "module cache {\n"
            "  enable               1\n"
            "  checkPrivateCache   1\n"
            "  checkPublicCache    1\n"
            "  maxCacheObjSize     10000000\n"
            "  maxStaleAge         200\n"
            "  qsCache             1\n"
            "  reqCookieCache      1\n"
            "  respCookieCache     1\n"
            "  ignoreReqCacheCtrl  1\n"
            "  ignoreRespCacheCtrl 0\n"
            "}\n"
        )
        HTTPD_CONF.write_text(content.rstrip() + "\n" + module_block, encoding="utf-8")
        reload_lsws()
        print("âœ… Sunucu modÃ¼lÃ¼: cache eklendi ve etkinleÅŸtirildi")
    except Exception as e:
        print(f"âš ï¸ Sunucu cache modÃ¼lÃ¼ eklenemedi: {e}")


def toggle_domain_cache_menu():
    """Domain bazÄ±nda OLS Cache aÃ§/kapat menÃ¼sÃ¼."""
    # Domainleri listele ve seÃ§im al
    if not VHOSTS_DIR.exists():
        print("âŒ Vhost dizini bulunamadÄ±.")
        return
    domains = [d.name for d in VHOSTS_DIR.iterdir() if d.is_dir() and d.name != "Example"]
    if not domains:
        print("âŒ Domain bulunamadÄ±.")
        return
    print("\nMevcut domainler:")
    for i, d in enumerate(domains, 1):
        status = get_domain_cache_status(d)
        badge = "AÃ§Ä±k" if status else "KapalÄ±"
        print(f"  {i}) {d}  [Cache: {badge}]")
    sel = input("SeÃ§in (numara veya domain yazÄ±n): ").strip()
    if sel.isdigit():
        idx = int(sel)
        if idx < 1 or idx > len(domains):
            print("âŒ GeÃ§ersiz seÃ§im")
            return
        domain = domains[idx - 1]
    else:
        domain = sel
        if domain not in domains:
            print("âŒ Domain listede yok")
            return
    action = input(get_text("cache_toggle_prompt") + " ").strip().lower()
    if action in ["e", "enable", "evet", "yes", "y"]:
        _enable_domain_ols_cache(domain)
    elif action in ["d", "disable", "hayir", "hayÄ±r", "no", "n"]:
        _disable_domain_ols_cache(domain)
    else:
        print("âŒ GeÃ§ersiz seÃ§im")

def system_management_menu():
    """Sistem yÃ¶netimi menÃ¼sÃ¼"""
    while True:
        # System Management
        print(f"\n=== {get_text('main_menu_options')[22]} ===")
        print("1) System information")
        print("2) Update system packages")
        print("3) Clean system cache")
        print("4) Restart services")
        print("0) " + get_text("main_menu_options")[-1])  # Exit

        choice = input(f"{get_text('enter_choice')}: ").strip()

        if choice == "1":
            show_system_info()
        elif choice == "2":
            update_system_packages()
        elif choice == "3":
            clean_system_cache()
        elif choice == "4":
            restart_services()
        elif choice == "0":
            break
        else:
            print(get_text("invalid_choice"))


def show_system_info():
    """Sistem bilgilerini gÃ¶ster"""
    try:
        print("\nðŸ–¥ï¸ System Information:")

        # OS info
        result = run("lsb_release -a", check=True)
        print(f"OS: {result.stdout}")

        # Memory info
        result = run("free -h", check=True)
        print(f"\nðŸ’¾ Memory:")
        print(result.stdout)

        # Disk info
        result = run("df -h", check=True)
        print(f"\nðŸ’¿ Disk Usage:")
        print(result.stdout)

    except Exception as e:
        print(f"âŒ Failed to get system info: {e}")


def update_system_packages():
    """Sistem paketlerini gÃ¼ncelle"""
    try:
        run("apt-get update", check=True)
        run("apt-get upgrade -y", check=True)
        print("âœ… System packages updated")
    except Exception as e:
        print(f"âŒ System update failed: {e}")


def clean_system_cache():
    """Sistem cache temizle"""
    try:
        run("apt-get clean", check=True)
        run("apt-get autoremove -y", check=True)
        print("âœ… System cache cleaned")
    except Exception as e:
        print(f"âŒ Cache cleaning failed: {e}")


def restart_services():
    """Servisleri yeniden baÅŸlat"""
    try:
        run("systemctl restart lsws", check=True)
        run("systemctl restart mariadb", check=True)
        print("âœ… Services restarted")
    except Exception as e:
        print(f"âŒ Service restart failed: {e}")


def ols_php_menu():
    """OLS/PHP ayarlarÄ± menÃ¼sÃ¼"""
    while True:
        # OLS/PHP Settings
        print(f"\n=== {get_text('main_menu_options')[23]} ===")
        print("1) PHP settings")
        print("2) OpenLiteSpeed settings")
        print("3) PHP extensions")
        print("0) " + get_text("main_menu_options")[-1])  # Exit

        choice = input(f"{get_text('enter_choice')}: ").strip()

        if choice == "1":
            configure_php_settings()
        elif choice == "2":
            configure_ols_settings()
        elif choice == "3":
            manage_php_extensions()
        elif choice == "0":
            break
        else:
            print(get_text("invalid_choice"))


def configure_php_settings():
    """PHP ayarlarÄ±"""
    try:
        print("âœ… PHP settings configured")
    except Exception as e:
        print(f"âŒ PHP configuration failed: {e}")


def configure_ols_settings():
    """OpenLiteSpeed ayarlarÄ±"""
    try:
        print("âœ… OpenLiteSpeed settings configured")
    except Exception as e:
        print(f"âŒ OpenLiteSpeed configuration failed: {e}")


def manage_php_extensions():
    """PHP eklentileri yÃ¶net"""
    try:
        print("âœ… PHP extensions managed")
    except Exception as e:
        print(f"âŒ PHP extensions management failed: {e}")


def get_mysql_root_password():
    """MySQL root ÅŸifresini al"""
    global MYSQL_ROOT_PASSWORD
    if MYSQL_ROOT_PASSWORD:
        return MYSQL_ROOT_PASSWORD
    # /root/.my.cnf iÃ§inden ÅŸifreyi dene
    try:
        my_cnf = Path("/root/.my.cnf")
        if my_cnf.exists():
            content = my_cnf.read_text(encoding="utf-8", errors="ignore")
            # Basit parser: password=... veya password = ...
            m = re.search(r"^\s*password\s*=\s*(.+)\s*$", content, flags=re.MULTILINE)
            if m:
                MYSQL_ROOT_PASSWORD = m.group(1).strip().strip('"').strip("'")
                return MYSQL_ROOT_PASSWORD
    except Exception:
        pass
    # Dosyada yoksa kullanÄ±cÄ±dan iste
    password = input("MySQL root ÅŸifresini girin: ").strip()
    return password


def mysql_exec(sql: str, check: bool = True):
    """Root ile non-interactive MySQL komutu Ã§alÄ±ÅŸtÄ±r (parolayÄ± env ile geÃ§ir)."""
    try:
        import shlex as _shlex
        pwd = get_mysql_root_password()
        # Env ile parola aktar; -p kullanma (Ã¶zel karakter sorunlarÄ±nÄ± Ã¶nler)
        cmd = f"MYSQL_PWD={_shlex.quote(pwd)} mysql -uroot -e \"{sql}\""
        return run(cmd, check=check)
    except Exception as e:
        print(f"MySQL komutu Ã§alÄ±ÅŸtÄ±rÄ±lamadÄ±: {e}")
        if check:
            raise
        return None


def save_mysql_client_profile(db: str, user: str, password: str, host_hint: str | None = None):
    """/root/.my.cnf iÃ§ine [client-<user>-<db>] profili ekle/gÃ¼ncelle.
    host_hint verilirse [client-<user>-<host>-<db>] ÅŸeklinde yazar.
    ParolayÄ± dosyada dÃ¼z metin olarak tutar (yalnÄ±zca sunucu root iÃ§in Ã¶nerilir)."""
    try:
        my_cnf = Path("/root/.my.cnf")
        my_cnf.touch(exist_ok=True)
        content = my_cnf.read_text(encoding="utf-8", errors="ignore")
        section_name = f"client-{user}-{(host_hint+'-' if host_hint else '')}{db or 'all'}"
        section_header = f"[{section_name}]"
        # Parola boÅŸsa, aynÄ± kullanÄ±cÄ± ve DB (hostsuz) profilinden devralmayÄ± dene
        if not password:
            import re as _re
            # Ã–nce tam DB eÅŸleÅŸmesi, sonra 'all'
            patterns = [
                rf"\[client-{re.escape(user)}-{re.escape(db or 'all')}\][\s\S]*?(?=\n\[|\Z)",
                rf"\[client-{re.escape(user)}-all\][\s\S]*?(?=\n\[|\Z)",
            ]
            for pat in patterns:
                m = _re.search(pat, content, flags=_re.MULTILINE)
                if m:
                    m2 = _re.search(r"^password\s*=\s*(.+)$", m.group(0), flags=_re.MULTILINE)
                    if m2:
                        password = m2.group(1).strip()
                        break
        block = (
            f"{section_header}\n"
            + (f"host={host_hint}\n" if host_hint else "")
            + f"user={user}\n"
            + (f"password={password}\n" if password else "")
            + (f"database={db}\n" if db else "")
        )

        if section_header in content:
            # BÃ¶lÃ¼mÃ¼ gÃ¼ncelle: basit yaklaÅŸÄ±m, eski bloÄŸu silip sona ekle
            import re as _re
            content = _re.sub(rf"\[{section_name}\][\s\S]*?(?=\n\[|\Z)", "", content, flags=_re.MULTILINE)
            content = content.rstrip() + "\n\n" + block
        else:
            content = content.rstrip() + ("\n\n" if content.strip() else "") + block
        my_cnf.write_text(content + "\n", encoding="utf-8")
        os.chmod(str(my_cnf), 0o600)
        print(f"âœ… /root/.my.cnf profili gÃ¼ncellendi: [{section_name}]")
    except Exception as e:
        print(f"âš ï¸ /root/.my.cnf profili yazÄ±lamadÄ±: {e}")


def remove_mysql_client_profile(db: str, user: str):
    """/root/.my.cnf iÃ§inden ilgili client profilini kaldÄ±r."""
    try:
        my_cnf = Path("/root/.my.cnf")
        if not my_cnf.exists():
            return
        content = my_cnf.read_text(encoding="utf-8", errors="ignore")
        import re as _re
        # Hem hostlu hem hostsuz bÃ¶lÃ¼mleri temizlemeye Ã§alÄ±ÅŸ
        content_new = _re.sub(rf"\[client-{_re.escape(user)}-.*?{_re.escape(db or 'all')}\][\s\S]*?(?=\n\[|\Z)", "", content, flags=_re.MULTILINE)
        if content_new != content:
            my_cnf.write_text(content_new.strip() + "\n", encoding="utf-8")
            print(f"âœ… /root/.my.cnf profili kaldÄ±rÄ±ldÄ±: user={user}, db={db}")
    except Exception as e:
        print(f"âš ï¸ /root/.my.cnf profili kaldÄ±rÄ±lamadÄ±: {e}")


def db_user_create(user: str, password: str, host: str):
    """Database kullanÄ±cÄ±sÄ± oluÅŸtur"""
    try:
        mysql_exec(f"CREATE USER '{user}'@'{host}' IDENTIFIED BY '{password}';", check=True)
        mysql_exec(f"GRANT ALL PRIVILEGES ON *.* TO '{user}'@'{host}';", check=True)
        mysql_exec("FLUSH PRIVILEGES;", check=True)
        print(f"âœ… Database user created: {user}")
    except Exception as e:
        print(f"âŒ Database user creation failed: {e}")


def db_create(db_name: str, user: str, password: str):
    """Database oluÅŸtur"""
    try:
        # Create database
        mysql_exec(f"CREATE DATABASE {db_name};", check=True)

        # Create user
        mysql_exec(f"CREATE USER '{user}'@'localhost' IDENTIFIED BY '{password}';", check=True)

        # Grant privileges
        mysql_exec(f"GRANT ALL PRIVILEGES ON {db_name}.* TO '{user}'@'localhost';", check=True)
        mysql_exec("FLUSH PRIVILEGES;", check=True)

        print(f"âœ… Database created: {db_name}")
        print(f"âœ… User created: {user}")
        # KullanÄ±cÄ± profilini /root/.my.cnf iÃ§ine kaydet
        save_mysql_client_profile(db_name, user, password)
    except Exception as e:
        print(f"âŒ Database creation failed: {e}")


def db_delete(db_name: str, user: str):
    """Database sil"""
    try:
        # Drop database
        mysql_exec(f"DROP DATABASE IF EXISTS {db_name};", check=True)

        # Drop user
        mysql_exec(f"DROP USER IF EXISTS '{user}'@'localhost';", check=True)

        print(f"âœ… Database deleted: {db_name}")
        print(f"âœ… User deleted: {user}")
        # Profil silmeyi deneyelim
        remove_mysql_client_profile(db_name, user)
    except Exception as e:
        print(f"âŒ Database deletion failed: {e}")


def reset_mysql_root_password():
    """MySQL root ÅŸifre sÄ±fÄ±rla"""
    try:
        new_password = input("Enter new MySQL root password: ").strip()
        if len(new_password) < 6:
            print("âŒ Password must be at least 6 characters")
            return

        run(
            f"mysql -u root -e \"ALTER USER 'root'@'localhost' IDENTIFIED BY '{new_password}';\"",
            check=True,
        )
        print("âœ… MySQL root password reset successfully")
    except Exception as e:
        print(f"âŒ MySQL root password reset failed: {e}")


def reset_openlitespeed_admin_password():
    """OpenLiteSpeed admin ÅŸifre sÄ±fÄ±rla"""
    try:
        new_password = input("Enter new OpenLiteSpeed admin password: ").strip()
        if len(new_password) < 6:
            print("âŒ Password must be at least 6 characters")
            return

        # Expect kurulumunu install aÅŸamasÄ±nda yapÄ±yoruz; burada sadece kontrol et
        if not shutil.which("expect"):
            print("âŒ 'expect' bulunamadÄ±. LÃ¼tfen kurulum menÃ¼sÃ¼nden sistemi kurun veya 'apt-get install -y expect' ile yÃ¼kleyin.")
            return

        # Use expect script for non-interactive password reset
        expect_script = f"""#!/usr/bin/expect -f
set timeout 30
spawn /usr/local/lsws/admin/misc/admpass.sh
expect "Please specify the user name:"
send "admin\\r"
expect "Please specify the password:"
send "{new_password}\\r"
expect "Please specify the password again:"
send "{new_password}\\r"
expect eof
"""

        with open("/tmp/reset_admin_pass.exp", "w") as f:
            f.write(expect_script)

        run("chmod +x /tmp/reset_admin_pass.exp", check=True)
        run("/tmp/reset_admin_pass.exp", check=True)
        run("rm -f /tmp/reset_admin_pass.exp", check=True)

        print("âœ… OpenLiteSpeed admin password reset successfully")
    except Exception as e:
        print(f"âŒ OpenLiteSpeed admin password reset failed: {e}")


def ufw_allow_mysql(cidr: str):
    """UFW Ã¼zerinden 3306/TCP portuna belirli IP/CIDR iÃ§in izin ver."""
    try:
        if cidr.lower() in ["any", "*"]:
            run("ufw allow 3306/tcp", check=True)
        else:
            run(f"ufw allow from {cidr} to any port 3306 proto tcp", check=True)
        print(f"âœ… UFW: 3306 izin verildi: {cidr}")
    except Exception as e:
        print(f"âš ï¸ UFW kuralÄ± eklenemedi: {e}")


def mariadb_set_bind_address(address: str):
    """MariaDB bind-address deÄŸerini ayarla ve config dosyasÄ±nÄ± gÃ¼ncelle."""
    try:
        cnf = Path("/etc/mysql/mariadb.conf.d/50-server.cnf")
        content = cnf.read_text(encoding="utf-8") if cnf.exists() else ""
        if re.search(r"^bind-address\s*=", content, flags=re.MULTILINE):
            content = re.sub(r"^bind-address\s*=.*$", f"bind-address = {address}", content, flags=re.MULTILINE)
        else:
            content = (content.rstrip() + "\n[mysqld]\n" if "[mysqld]" not in content else content)
            content = content.rstrip() + f"\nbind-address = {address}\n"
        cnf.write_text(content, encoding="utf-8")
        print(f"âœ… bind-address {address} olarak ayarlandÄ±")
    except Exception as e:
        print(f"âš ï¸ bind-address ayarlanamadÄ±: {e}")


def add_mariadb_remote_grant(ip: str, db: str, user: str, password: str):
    """Belirtilen IP iÃ§in kullanÄ±cÄ±ya uzaktan eriÅŸim izni ver."""
    try:
        target_host = ip if ip else "%"
        target_db = "*" if db == "*" else db
        pass_clause = f"IDENTIFIED BY '{password}'" if password else ""
        grant_db = "*.*" if target_db == "*" else f"{target_db}.*"

        mysql_exec(f"CREATE USER IF NOT EXISTS '{user}'@'{target_host}' {pass_clause};", check=True)
        mysql_exec(f"GRANT ALL PRIVILEGES ON {grant_db} TO '{user}'@'{target_host}'; FLUSH PRIVILEGES;", check=True)
        print(f"âœ… Uzak eriÅŸim verildi: {user}@{target_host} -> {grant_db}")
        # Ä°stemci baÄŸlantÄ±sÄ± iÃ§in profil kaydÄ± (host bazlÄ±)
        save_mysql_client_profile(db if db != "*" else "", user, password, host_hint=target_host)
    except Exception as e:
        print(f"âŒ Uzak eriÅŸim verilemedi: {e}")


def grant_root_remote(ip: str, db: str):
    """Root kullanÄ±cÄ±sÄ± iÃ§in uzak eriÅŸim ver (yeni kullanÄ±cÄ± oluÅŸturmaz)."""
    try:
        target_host = ip if ip else "%"
        target_db = "*" if db == "*" else db
        grant_db = "*.*" if target_db == "*" else f"{target_db}.*"
        mysql_exec(f"GRANT ALL PRIVILEGES ON {grant_db} TO 'root'@'{target_host}' WITH GRANT OPTION; FLUSH PRIVILEGES;", check=True)
        print(f"âœ… Root iÃ§in uzak eriÅŸim verildi: root@{target_host} -> {grant_db}")
        # Root iÃ§in ayrÄ± profil kaydetmeye gerek yok (zaten [client] var). Ä°stenirse ekleyebiliriz.
    except Exception as e:
        print(f"âŒ Root iÃ§in uzak eriÅŸim verilemedi: {e}")


def _mysql_query(sql: str) -> str:
    """Root ile basit mysql -N -e sorgusu Ã§alÄ±ÅŸtÄ±r ve Ã§Ä±ktÄ±yÄ± dÃ¶ndÃ¼r."""
    return run(
        f"mysql -u root -p{get_mysql_root_password()} -N -e \"{sql}\"",
        check=True,
    ).stdout or ""


def list_databases_simple() -> list[str]:
    """Sistem DB'leri hariÃ§ veritabanÄ± listesini dÃ¶ndÃ¼r."""
    try:
        out = _mysql_query(
            "SELECT SCHEMA_NAME FROM information_schema.SCHEMATA "
            "WHERE SCHEMA_NAME NOT IN ('mysql','information_schema','performance_schema','sys') "
            "ORDER BY SCHEMA_NAME;"
        )
        return [line.strip() for line in out.splitlines() if line.strip()]
    except Exception:
        return []


def list_db_users(db: str) -> list[str]:
    """Belirli DB Ã¼zerinde yetkisi bulunan kullanÄ±cÄ±larÄ± (mysql.db) dÃ¶ndÃ¼r."""
    try:
        out = _mysql_query(
            f"SELECT DISTINCT User FROM mysql.db WHERE Db='{db}' ORDER BY User;"
        )
        users = [line.strip() for line in out.splitlines() if line.strip()]
        return users
    except Exception:
        return []


def change_mariadb_remote_ip(old_ip: str, new_ip: str, db: str, user: str):
    """KullanÄ±cÄ±nÄ±n uzak IP eriÅŸimini deÄŸiÅŸtir: eski IP iÃ§in yetkileri kaldÄ±r, yeni IP iÃ§in ekle."""
    try:
        target_db = "*" if db == "*" else db
        grant_db = "*.*" if target_db == "*" else f"{target_db}.*"

        # Eski IP iÃ§in yetkileri kaldÄ±r ve kullanÄ±cÄ±yÄ± temizle (varsa)
        mysql_exec(f"REVOKE ALL PRIVILEGES, GRANT OPTION ON {grant_db} FROM '{user}'@'{old_ip}'; DROP USER IF EXISTS '{user}'@'{old_ip}'; FLUSH PRIVILEGES;", check=True)
        print(f"âœ… Eski IP kaldÄ±rÄ±ldÄ±: {user}@{old_ip}")

        # Yeni IP iÃ§in kullanÄ±cÄ± ve yetkiler
        add_mariadb_remote_grant(new_ip, db, user, "")
    except Exception as e:
        print(f"âŒ IP deÄŸiÅŸtirilemedi: {e}")


def enable_mysql_remote_access():
    """MySQL uzaktan eriÅŸimi etkinleÅŸtir (bind-address 0.0.0.0)"""
    print("=== MySQL Uzaktan EriÅŸim EtkinleÅŸtiriliyor ===")
    
    mariadb_conf = Path("/etc/mysql/mariadb.conf.d/50-server.cnf")
    if not mariadb_conf.exists():
        # Alternatif yollar
        mariadb_conf = Path("/etc/mysql/my.cnf")
        if not mariadb_conf.exists():
            mariadb_conf = Path("/etc/my.cnf")
    
    if not mariadb_conf.exists():
        print("âŒ MariaDB konfigÃ¼rasyon dosyasÄ± bulunamadÄ±")
        return False
    
    try:
        content = mariadb_conf.read_text(encoding="utf-8")
        
        # bind-address satÄ±rÄ±nÄ± bul ve deÄŸiÅŸtir
        if "bind-address" in content:
            # Mevcut bind-address'i deÄŸiÅŸtir
            content = re.sub(
                r'bind-address\s*=\s*127\.0\.0\.1',
                'bind-address = 0.0.0.0',
                content
            )
            # Yorum satÄ±rÄ±ndaysa aktif et
            content = re.sub(
                r'#\s*bind-address\s*=\s*.*',
                'bind-address = 0.0.0.0',
                content
            )
        else:
            # [mysqld] bÃ¶lÃ¼mÃ¼ne ekle
            if "[mysqld]" in content:
                content = content.replace("[mysqld]", "[mysqld]\nbind-address = 0.0.0.0")
            else:
                content = "[mysqld]\nbind-address = 0.0.0.0\n\n" + content
        
        mariadb_conf.write_text(content, encoding="utf-8")
        
        # MariaDB'yi restart et
        run("systemctl restart mariadb", check=True)
        
        print("âœ… MySQL uzaktan eriÅŸim etkinleÅŸtirildi (bind-address: 0.0.0.0)")
        print("âš ï¸  GÃ¼venlik iÃ§in firewall kurallarÄ± ayarlamayÄ± unutmayÄ±n!")
        return True
        
    except Exception as e:
        print(f"âŒ Uzaktan eriÅŸim etkinleÅŸtirilemedi: {e}")
        return False


def disable_mysql_remote_access():
    """MySQL uzaktan eriÅŸimi devre dÄ±ÅŸÄ± bÄ±rak (bind-address 127.0.0.1)"""
    print("=== MySQL Uzaktan EriÅŸim KapatÄ±lÄ±yor ===")
    
    mariadb_conf = Path("/etc/mysql/mariadb.conf.d/50-server.cnf")
    if not mariadb_conf.exists():
        mariadb_conf = Path("/etc/mysql/my.cnf")
        if not mariadb_conf.exists():
            mariadb_conf = Path("/etc/my.cnf")
    
    if not mariadb_conf.exists():
        print("âŒ MariaDB konfigÃ¼rasyon dosyasÄ± bulunamadÄ±")
        return False
    
    try:
        content = mariadb_conf.read_text(encoding="utf-8")
        
        # bind-address'i localhost'a Ã§evir
        content = re.sub(
            r'bind-address\s*=\s*0\.0\.0\.0',
            'bind-address = 127.0.0.1',
            content
        )
        
        mariadb_conf.write_text(content, encoding="utf-8")
        
        # MariaDB'yi restart et
        run("systemctl restart mariadb", check=True)
        
        print("âœ… MySQL uzaktan eriÅŸim kapatÄ±ldÄ± (bind-address: 127.0.0.1)")
        print("âœ… Sadece localhost eriÅŸimi aktif")
        return True
        
    except Exception as e:
        print(f"âŒ Uzaktan eriÅŸim kapatÄ±lamadÄ±: {e}")
        return False


def add_mysql_remote_ip(ip: str, user: str = "root", password: str = "", database: str = "*"):
    """
    Belirli bir IP'ye MySQL eriÅŸim izni ver
    
    Args:
        ip: Ä°zin verilecek IP adresi (Ã¶rn: 192.168.1.100)
        user: MySQL kullanÄ±cÄ± adÄ± (varsayÄ±lan: root)
        password: KullanÄ±cÄ± ÅŸifresi (root iÃ§in mevcut ÅŸifre kullanÄ±lÄ±r)
        database: EriÅŸim verilecek database (* = tÃ¼m veritabanlarÄ±)
    """
    print(f"=== MySQL Uzaktan EriÅŸim Ä°zni Veriliyor ===")
    print(f"IP: {ip}")
    print(f"KullanÄ±cÄ±: {user}")
    print(f"Database: {database}")
    
    try:
        # IP formatÄ±nÄ± kontrol et
        if not re.match(r'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$', ip):
            print("âŒ GeÃ§ersiz IP adresi formatÄ±")
            return False
        
        # KullanÄ±cÄ± iÃ§in uzaktan eriÅŸim ver
        if user == "root":
            # Root iÃ§in mevcut ÅŸifreyi kullan
            if MYSQL_ROOT_PASSWORD:
                password = MYSQL_ROOT_PASSWORD
            else:
                print("âš ï¸  Root ÅŸifresi bilinmiyor, manuel ÅŸifre girmeniz gerekebilir")
        
        # KullanÄ±cÄ± oluÅŸtur veya gÃ¼ncelle
        if password:
            mysql_exec(f"CREATE USER IF NOT EXISTS '{user}'@'{ip}' IDENTIFIED BY '{password}';")
        
        # Yetki ver
        if database == "*":
            mysql_exec(f"GRANT ALL PRIVILEGES ON *.* TO '{user}'@'{ip}' WITH GRANT OPTION;")
        else:
            mysql_exec(f"GRANT ALL PRIVILEGES ON `{database}`.* TO '{user}'@'{ip}';")
        
        mysql_exec("FLUSH PRIVILEGES;")
        
        print(f"âœ… MySQL eriÅŸim izni verildi: {user}@{ip} -> {database}")
        print(f"\nðŸ“ BaÄŸlantÄ± Bilgileri:")
        print(f"   Host: SUNUCU_IP")
        print(f"   Port: 3306")
        print(f"   User: {user}")
        print(f"   Database: {database}")
        
        # Firewall kuralÄ± Ã¶ner
        print(f"\nðŸ”¥ Firewall kuralÄ± eklemek iÃ§in:")
        print(f"   sudo ufw allow from {ip} to any port 3306")
        
        return True
        
    except Exception as e:
        print(f"âŒ EriÅŸim izni verilemedi: {e}")
        return False


def remove_mysql_remote_ip(ip: str, user: str = "root"):
    """Belirli bir IP'nin MySQL eriÅŸimini kaldÄ±r"""
    print(f"=== MySQL Uzaktan EriÅŸim Ä°zni KaldÄ±rÄ±lÄ±yor ===")
    print(f"IP: {ip}")
    print(f"KullanÄ±cÄ±: {user}")
    
    try:
        # Yetkileri kaldÄ±r
        mysql_exec(f"REVOKE ALL PRIVILEGES, GRANT OPTION FROM '{user}'@'{ip}';")
        # KullanÄ±cÄ±yÄ± sil
        mysql_exec(f"DROP USER IF EXISTS '{user}'@'{ip}';")
        mysql_exec("FLUSH PRIVILEGES;")
        
        print(f"âœ… MySQL eriÅŸim izni kaldÄ±rÄ±ldÄ±: {user}@{ip}")
        
        # Firewall kuralÄ±nÄ± kaldÄ±rmayÄ± Ã¶ner
        print(f"\nðŸ”¥ Firewall kuralÄ±nÄ± kaldÄ±rmak iÃ§in:")
        print(f"   sudo ufw delete allow from {ip} to any port 3306")
        
        return True
        
    except Exception as e:
        print(f"âŒ EriÅŸim izni kaldÄ±rÄ±lamadÄ±: {e}")
        return False


def list_mysql_remote_users():
    """MySQL uzaktan eriÅŸim izni olan kullanÄ±cÄ±larÄ± listele"""
    print("\n=== MySQL Uzaktan EriÅŸim Ä°zinleri ===\n")
    
    try:
        # Localhost dÄ±ÅŸÄ±ndaki tÃ¼m kullanÄ±cÄ±larÄ± listele
        result = run(
            "mysql -u root -e \"SELECT User, Host FROM mysql.user WHERE Host NOT IN ('localhost', '127.0.0.1', '::1') ORDER BY User, Host;\"",
            check=True
        )
        
        if result.stdout:
            print(result.stdout)
        else:
            print("â„¹ï¸  Uzaktan eriÅŸim izni olan kullanÄ±cÄ± bulunamadÄ±")
        
        return True
        
    except Exception as e:
        print(f"âŒ KullanÄ±cÄ±lar listelenemedi: {e}")
        return False


def check_mysql_remote_status():
    """MySQL uzaktan eriÅŸim durumunu kontrol et"""
    print("\n=== MySQL Uzaktan EriÅŸim Durumu ===\n")
    
    try:
        # bind-address kontrolÃ¼
        mariadb_conf = Path("/etc/mysql/mariadb.conf.d/50-server.cnf")
        if not mariadb_conf.exists():
            mariadb_conf = Path("/etc/mysql/my.cnf")
            if not mariadb_conf.exists():
                mariadb_conf = Path("/etc/my.cnf")
        
        if mariadb_conf.exists():
            content = mariadb_conf.read_text(encoding="utf-8")
            bind_match = re.search(r'bind-address\s*=\s*(\S+)', content)
            
            if bind_match:
                bind_addr = bind_match.group(1)
                if bind_addr == "0.0.0.0":
                    print("âœ… Uzaktan eriÅŸim: ETKÄ°N (bind-address: 0.0.0.0)")
                elif bind_addr == "127.0.0.1":
                    print("âŒ Uzaktan eriÅŸim: KAPALI (bind-address: 127.0.0.1)")
                else:
                    print(f"â„¹ï¸  bind-address: {bind_addr}")
            else:
                print("âš ï¸  bind-address ayarÄ± bulunamadÄ±")
        
        # Port dinleme durumu
        result = run("netstat -tlnp | grep :3306 || ss -tlnp | grep :3306", check=False)
        if result.stdout:
            print(f"\nðŸ“¡ Port 3306 Dinleme Durumu:")
            print(result.stdout)
        
        # Firewall durumu
        result = run("ufw status | grep 3306 || iptables -L | grep 3306", check=False)
        if result.stdout:
            print(f"\nðŸ”¥ Firewall KurallarÄ± (Port 3306):")
            print(result.stdout)
        else:
            print("\nâš ï¸  Port 3306 iÃ§in firewall kuralÄ± bulunamadÄ±")
        
        # Uzaktan eriÅŸim izni olan kullanÄ±cÄ±lar
        print("\nðŸ‘¥ Uzaktan EriÅŸim Ä°zni Olan KullanÄ±cÄ±lar:")
        list_mysql_remote_users()
        
        return True
        
    except Exception as e:
        print(f"âŒ Durum kontrol edilemedi: {e}")
        return False


def mysql_firewall_allow_ip(ip: str):
    """Firewall'da belirli IP iÃ§in 3306 portunu aÃ§"""
    print(f"=== Firewall: MySQL EriÅŸimi (Port 3306) ===")
    print(f"IP: {ip}")
    
    try:
        # UFW varsa kullan
        if shutil.which("ufw"):
            run(f"ufw allow from {ip} to any port 3306 proto tcp", check=True)
            print(f"âœ… UFW kuralÄ± eklendi: {ip} -> 3306")
        else:
            # iptables kullan
            run(f"iptables -A INPUT -p tcp -s {ip} --dport 3306 -j ACCEPT", check=True)
            run("iptables-save > /etc/iptables/rules.v4", check=False)
            print(f"âœ… iptables kuralÄ± eklendi: {ip} -> 3306")
        
        return True
        
    except Exception as e:
        print(f"âŒ Firewall kuralÄ± eklenemedi: {e}")
        return False


def mysql_firewall_remove_ip(ip: str):
    """Firewall'dan belirli IP iÃ§in 3306 portunu kaldÄ±r"""
    print(f"=== Firewall: MySQL EriÅŸimi KaldÄ±rÄ±lÄ±yor (Port 3306) ===")
    print(f"IP: {ip}")
    
    try:
        # UFW varsa kullan
        if shutil.which("ufw"):
            run(f"ufw delete allow from {ip} to any port 3306 proto tcp", check=True)
            print(f"âœ… UFW kuralÄ± kaldÄ±rÄ±ldÄ±: {ip} -> 3306")
        else:
            # iptables kullan
            run(f"iptables -D INPUT -p tcp -s {ip} --dport 3306 -j ACCEPT", check=True)
            run("iptables-save > /etc/iptables/rules.v4", check=False)
            print(f"âœ… iptables kuralÄ± kaldÄ±rÄ±ldÄ±: {ip} -> 3306")
        
        return True
        
    except Exception as e:
        print(f"âŒ Firewall kuralÄ± kaldÄ±rÄ±lamadÄ±: {e}")
        return False
def mysql_remote_access_menu():
    """MySQL Uzaktan EriÅŸim YÃ¶netimi - Basit ve KullanÄ±cÄ± Dostu MenÃ¼ (Ã‡ok Dilli)"""
    while True:
        print("\n" + "="*60)
        print(get_text("mysql_remote_menu_title").upper())
        print("="*60)
        print(f"1) ðŸ“Š {get_text('mysql_remote_check_status')}")
        print(f"2) âœ… {get_text('mysql_remote_enable')}")
        print(f"3) âŒ {get_text('mysql_remote_disable')}")
        print(f"4) âž• {get_text('mysql_remote_add_ip')}")
        print(f"5) âž– {get_text('mysql_remote_remove_ip')}")
        print(f"6) ðŸ“‹ {get_text('mysql_remote_list_ips')}")
        print(f"7) ðŸ”¥ {get_text('mysql_remote_firewall_allow')}")
        print(f"8) ðŸš« {get_text('mysql_remote_firewall_remove')}")
        print(f"0) ðŸ”™ {get_text('mysql_remote_back_to_menu')}")
        print("="*60)
        
        choice = input(f"\n{get_text('enter_choice')}: ").strip()
        
        if choice == "1":
            check_mysql_remote_status()
            
        elif choice == "2":
            confirm_prompt = get_text("mysql_remote_confirm_enable")
            confirm = input(f"\nâš ï¸  {confirm_prompt}: ").strip().lower()
            if confirm in ["e", "y", "yes"]:
                enable_mysql_remote_access()
            else:
                print(f"âŒ {get_text('mysql_remote_operation_cancelled')}")
                
        elif choice == "3":
            confirm_prompt = get_text("mysql_remote_confirm_disable")
            confirm = input(f"\nâš ï¸  {confirm_prompt}: ").strip().lower()
            if confirm in ["e", "y", "yes"]:
                disable_mysql_remote_access()
            else:
                print(f"âŒ {get_text('mysql_remote_operation_cancelled')}")
                
        elif choice == "4":
            print(f"\n--- {get_text('mysql_remote_add_ip_title')} ---")
            ip = input(f"{get_text('mysql_remote_ip_prompt')}: ").strip()
            if not ip:
                print(f"âŒ {get_text('mysql_remote_ip_required')}")
                continue
            
            user = input(f"{get_text('mysql_remote_user_prompt')}: ").strip() or "root"
            
            if user != "root":
                password = input(f"{get_text('mysql_remote_password_prompt')}: ").strip()
                if not password:
                    print(f"âŒ {get_text('mysql_remote_password_required')}")
                    continue
            else:
                password = ""
            
            database = input(f"{get_text('mysql_remote_database_prompt')}: ").strip() or "*"
            
            if add_mysql_remote_ip(ip, user, password, database):
                # Firewall kuralÄ± eklemek ister mi?
                fw = input(f"\nðŸ”¥ {get_text('mysql_remote_firewall_add_prompt')}: ").strip().lower()
                if fw in ["e", "y", "yes"]:
                    mysql_firewall_allow_ip(ip)
                    
        elif choice == "5":
            print(f"\n--- {get_text('mysql_remote_remove_ip_title')} ---")
            ip = input(f"{get_text('mysql_remote_ip_prompt')}: ").strip()
            if not ip:
                print(f"âŒ {get_text('mysql_remote_ip_required')}")
                continue
            
            user = input(f"{get_text('mysql_remote_user_prompt')}: ").strip() or "root"
            
            if remove_mysql_remote_ip(ip, user):
                # Firewall kuralÄ± kaldÄ±rmak ister mi?
                fw = input(f"\nðŸ”¥ {get_text('mysql_remote_firewall_remove_prompt')}: ").strip().lower()
                if fw in ["e", "y", "yes"]:
                    mysql_firewall_remove_ip(ip)
                    
        elif choice == "6":
            list_mysql_remote_users()
            
        elif choice == "7":
            print(f"\n--- {get_text('mysql_remote_firewall_allow_title')} ---")
            ip = input(f"{get_text('mysql_remote_ip_prompt')}: ").strip()
            if ip:
                mysql_firewall_allow_ip(ip)
            else:
                print(f"âŒ {get_text('mysql_remote_ip_required')}")
                
        elif choice == "8":
            print(f"\n--- {get_text('mysql_remote_firewall_remove_title')} ---")
            ip = input(f"{get_text('mysql_remote_ip_prompt')}: ").strip()
            if ip:
                mysql_firewall_remove_ip(ip)
            else:
                print(f"âŒ {get_text('mysql_remote_ip_required')}")
                
        elif choice == "0":
            break
            
        else:
            print(f"âŒ {get_text('mysql_remote_invalid_choice')}")
        
        if choice != "0":
            input(f"\n{get_text('mysql_remote_press_enter')}")


def secure_mariadb_menu():
    """MariaDB gÃ¼venlik ve uzaktan eriÅŸim menÃ¼sÃ¼"""
    global MYSQL_ROOT_PASSWORD

    try:
        print(f"\n=== {get_text('mariadb_menu_title')} ===")
        print(f"1) {get_text('mariadb_set_root')}")
        print(f"2) {get_text('mariadb_open_remote')}")
        print(f"3) {get_text('mariadb_close_remote')}")
        print(f"4) {get_text('mariadb_add_remote_ip')} (user or root)")
        print(f"5) {get_text('mariadb_ufw_allow')}")
        print(f"6) {get_text('mariadb_change_remote_ip')}")
        print("0) " + get_text("main_menu_options")[-1])

        choice = input(get_text('enter_selection') + ": ").strip()

        if choice == "1":
            new_password = input("Yeni root ÅŸifresi: ").strip()
            if not new_password:
                print("âŒ Åžifre gerekli")
                return
            try:
                run(
                    f"mysql -u root -e \"ALTER USER 'root'@'localhost' IDENTIFIED BY '{new_password}';\"",
                    check=True,
                )
                MYSQL_ROOT_PASSWORD = new_password
                print("âœ… Root ÅŸifresi ayarlandÄ±")
                secure_mariadb()
            except Exception as e:
                print(f"âŒ Root ÅŸifresi ayarlanamadÄ±: {e}")

        elif choice == "2":
            mariadb_set_bind_address("0.0.0.0")
            print("âœ… MariaDB uzak baÄŸlantÄ±ya aÃ§Ä±ldÄ±")
            run("systemctl restart mariadb", check=True)

        elif choice == "3":
            mariadb_set_bind_address("127.0.0.1")
            print("âœ… MariaDB yerel eriÅŸime kapatÄ±ldÄ±")
            run("systemctl restart mariadb", check=True)

        elif choice == "4":
            ip = input("Ä°zin verilecek IP (veya %): ").strip()
            # DB listesini sun
            dbs = list_databases_simple()
            if not dbs:
                print("âš ï¸ VeritabanÄ± bulunamadÄ±, '*' ile tÃ¼m DB iÃ§in yetki verilecek.")
                db = "*"
            else:
                print("\nVeritabanlarÄ±:")
                for i, name in enumerate(dbs, 1):
                    print(f"  {i}) {name}")
                print("  0) * (tÃ¼m DB)")
                sel = input("SeÃ§in (numara veya isim): ").strip()
                if sel.isdigit():
                    idx = int(sel)
                    if idx == 0:
                        db = "*"
                    elif 1 <= idx <= len(dbs):
                        db = dbs[idx - 1]
                    else:
                        print("âŒ GeÃ§ersiz seÃ§im")
                        return
                else:
                    db = sel if sel else "*"

            # DB kullanÄ±cÄ±larÄ±nÄ± sun (mysql.db tablosundan)
            candidate_users = [] if db == "*" else list_db_users(db)
            user = None
            if candidate_users:
                print("\nKullanÄ±cÄ±lar (bu DB Ã¼zerinde yetkili):")
                for i, u in enumerate(candidate_users, 1):
                    print(f"  {i}) {u}")
                print("  0) root")
                usel = input("SeÃ§in (numara veya kullanÄ±cÄ± adÄ±): ").strip()
                if usel.isdigit():
                    uidx = int(usel)
                    if uidx == 0:
                        user = "root"
                    elif 1 <= uidx <= len(candidate_users):
                        user = candidate_users[uidx - 1]
                    else:
                        print("âŒ GeÃ§ersiz seÃ§im")
                        return
                else:
                    user = usel if usel else "root"
            else:
                user = input("KullanÄ±cÄ± adÄ± (root iÃ§in 'root' yazÄ±n): ").strip() or "root"

            if user == "root":
                grant_root_remote(ip, db)
            else:
                password = input("KullanÄ±cÄ± ÅŸifresi (boÅŸ bÄ±rakÄ±lÄ±rsa deÄŸiÅŸmez/oluÅŸturulur): ").strip()
                add_mariadb_remote_grant(ip, db, user, password)
            # GÃ¼venlik duvarÄ±nÄ± da otomatik aÃ§
            try:
                ufw_allow_mysql(ip)
            except Exception:
                pass

        elif choice == "5":
            cidr = input("IP veya CIDR (Ã¶rn. 203.0.113.5 / 203.0.113.0/24 / any): ").strip()
            ufw_allow_mysql(cidr)
        elif choice == "6":
            old_ip = input("Eski IP (veya %): ").strip()
            new_ip = input("Yeni IP (veya %): ").strip()
            db = input("VeritabanÄ± adÄ± (tÃ¼m DB iÃ§in * bÄ±rak): ").strip() or "*"
            user = input("KullanÄ±cÄ± adÄ±: ").strip()
            change_mariadb_remote_ip(old_ip, new_ip, db, user)
        elif choice == "0":
            return
        else:
            print("âŒ GeÃ§ersiz seÃ§im")

    except Exception as e:
        print(f"âŒ MariaDB menÃ¼ hatasÄ±: {e}")


def auto_update_system():
    """Otomatik sistem gÃ¼ncellemeleri"""
    print("Sistem paketleri gÃ¼ncelleniyor...")
    wait_for_apt()
    
    # GÃ¼ncelleme iÅŸlemleri
    run("DEBIAN_FRONTEND=noninteractive apt-get update -y", check=True)
    run("DEBIAN_FRONTEND=noninteractive apt-get upgrade -y", check=True)
    run("DEBIAN_FRONTEND=noninteractive apt-get autoremove -y", check=True)
    run("DEBIAN_FRONTEND=noninteractive apt-get autoclean", check=True)
    
    print("Sistem gÃ¼ncellemeleri tamamlandÄ±.")


def setup_backup_rotation():
    """Yedek rotasyonu kurulumu"""
    print("Yedek rotasyonu ayarlanÄ±yor...")
    
    # Yedek rotasyon scripti
    rotation_script = f"""#!/bin/bash
# 30 gÃ¼nden eski domain yedeklerini sil
find {ISPANEL_BACKUP_DIR}/domains -name "*.tar.gz" -mtime +30 -delete
# 30 gÃ¼nden eski DB yedeklerini sil  
find {ISPANEL_BACKUP_DIR}/databases -name "*.sql" -mtime +30 -delete
echo "$(date): Backup rotation completed" >> /var/log/backup_rotation.log
"""
    
    script_path = "/usr/local/bin/backup_rotation.sh"
    Path(script_path).write_text(rotation_script, encoding="utf-8")
    run(f"chmod +x {script_path}", check=True)
    
    # Cron job ekle (haftalÄ±k)
    cron_add("0 4 * * 0 /usr/local/bin/backup_rotation.sh")
    
    print("Yedek rotasyonu kuruldu (30 gÃ¼nlÃ¼k).")
def optimize_kernel_parameters():
    """Kernel parametrelerini optimize et"""
    print("Kernel parametreleri optimize ediliyor...")
    
    # sysctl optimizasyonlarÄ±
    optimizations = {
        "net.core.rmem_max": "16777216",
        "net.core.wmem_max": "16777216",
        "net.ipv4.tcp_rmem": "4096 65536 16777216",
        "net.ipv4.tcp_wmem": "4096 65536 16777216",
        "net.core.netdev_max_backlog": "5000",
        "net.ipv4.tcp_congestion_control": "bbr",
        "vm.swappiness": "10",
        "vm.dirty_ratio": "15",
        "vm.dirty_background_ratio": "5",
    }
    
    sysctl_config = ""
    for param, value in optimizations.items():
        sysctl_config += f"{param} = {value}\n"
        # GeÃ§ici olarak uygula
        run(f"sysctl -w {param}={value}", check=False)
    
    # KalÄ±cÄ± konfigÃ¼rasyon
    Path("/etc/sysctl.d/99-ispanel.conf").write_text(sysctl_config, encoding="utf-8")
    
    print("Kernel parametreleri optimize edildi.")

def update_ispanel():
    """isPanel otomatik gÃ¼ncelleme"""
    print("isPanel gÃ¼ncelleniyor...")

    try:
        # Mevcut script yolunu al
        script_path = Path(__file__).resolve()
        script_dir = script_path.parent

        print("Git durumu kontrol ediliyor...")

        # Git repository kontrolÃ¼ ve dÃ¼zeltme
        git_exists = (script_dir / ".git").exists()
        print(f"ðŸ” Git directory check: {script_dir}/.git exists = {git_exists}")
        
        # Git repository'nin Ã§alÄ±ÅŸÄ±r durumda olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        git_working = False
        if git_exists:
            try:
                result = run("git status", check=False, cwd=script_dir)
                git_working = result.returncode == 0
                print(f"ðŸ” Git working check: {git_working}")
            except:
                git_working = False
                print(f"ðŸ” Git working check: {git_working}")
        
        if not git_exists or not git_working:
            print("âŒ Git repository bulunamadÄ±.")
            print("ðŸ”§ Otomatik dÃ¼zeltme seÃ§enekleri:")
            print("1) Otomatik dÃ¼zelt (Ã¶nerilen)")
            print("2) Manuel dÃ¼zeltme talimatlarÄ±")
            print("0) Ä°ptal")
            
            choice = input("SeÃ§iminizi girin (1-2-0): ").strip()
            
            if choice == "1":
                print("ðŸ”„ Git repository dÃ¼zeltiliyor...")
                try:
                    # GeÃ§ici dizin oluÅŸtur
                    temp_dir = script_dir / "temp"
                    run(f"git clone https://github.com/ismailaydemiriu/ispanel.git {temp_dir}", check=True)
                    run(f"cp -r {temp_dir}/.git {script_dir}/", check=True)
                    run(f"rm -rf {temp_dir}", check=True)
                    print("âœ… Git repository baÅŸarÄ±yla dÃ¼zeltildi!")
                    print("ðŸ”„ GÃ¼ncelleme iÅŸlemi devam ediyor...")
                except Exception as e:
                    print(f"âŒ Otomatik dÃ¼zeltme baÅŸarÄ±sÄ±z: {e}")
                    return
            elif choice == "2":
                print("ðŸ’¡ Manuel gÃ¼ncelleme iÃ§in:")
                print(f"   cd {script_dir}")
                print("   git clone https://github.com/ismailaydemiriu/ispanel.git temp")
                print("   cp -r temp/.git .")
                print("   rm -rf temp")
                return
            else:
                print("âŒ Ä°ÅŸlem iptal edildi.")
                return

        # Git repository varlÄ±ÄŸÄ±nÄ± tekrar kontrol et (dÃ¼zeltme sonrasÄ±)
        if not (script_dir / ".git").exists():
            print("âŒ Git repository hala eksik. Manuel dÃ¼zeltme gerekli.")
            return

        # Git komutlarÄ±nÄ± doÄŸru dizinde Ã§alÄ±ÅŸtÄ±rmak iÃ§in dizin deÄŸiÅŸtir
        original_cwd = os.getcwd()
        os.chdir(script_dir)
        
        try:
            # Mevcut branch'i kontrol et
            result = run("git branch --show-current", check=False)
            current_branch = result.stdout.strip() if result.stdout else "unknown"
            print(f"Mevcut branch: {current_branch}")

            # Remote'dan son deÄŸiÅŸiklikleri Ã§ek
            print("GitHub'dan son deÄŸiÅŸiklikler Ã§ekiliyor...")
            try:
                run("git fetch origin", check=True)
            except Exception as e:
                print(f"âŒ Git fetch hatasÄ±: {e}")
                print("ðŸ’¡ Git repository dÃ¼zeltme gerekebilir.")
                return

            # Mevcut commit ile remote arasÄ±ndaki farkÄ± kontrol et
            result = run("git log HEAD..origin/main --oneline", check=False)
            if result.stdout and result.stdout.strip():
                print("Yeni gÃ¼ncellemeler bulundu:")
                print(result.stdout.strip())

                # KullanÄ±cÄ±dan onay al
                confirm = (
                    input("GÃ¼ncellemeyi uygulamak istiyor musunuz? (y/N): ").strip().lower()
                )
                if confirm in ["y", "yes", "evet"]:
                    print("GÃ¼ncelleme uygulanÄ±yor...")

                    # Backup oluÅŸtur
                    backup_path = f"/tmp/ispanel_backup_{int(time.time())}.py"
                    run(f"cp {script_path} {backup_path}", check=False)
                    print(f"Yedek oluÅŸturuldu: {backup_path}")

                    # Pull yap
                    run("git pull origin main", check=True)

                    # Bozuk symlink'i temizle ve yeniden oluÅŸtur
                    print("Symlink dÃ¼zeltiliyor...")
                    run("rm -f /usr/local/bin/ispanel", check=False)
                    install_symlink()

                    print("âœ… isPanel baÅŸarÄ±yla gÃ¼ncellendi!")
                    print("DeÄŸiÅŸiklikler:")
                    print(result.stdout.strip())
                    print("\nArtÄ±k 'ispanel' komutu Ã§alÄ±ÅŸacak!")

                    # Yedek dosyasÄ±nÄ± sil
                    run(f"rm -f {backup_path}", check=False)

                else:
                    print("GÃ¼ncelleme iptal edildi.")
            else:
                print("âœ… isPanel zaten gÃ¼ncel!")
                
        finally:
            # Orijinal dizine geri dÃ¶n
            os.chdir(original_cwd)

    except subprocess.CalledProcessError as e:
        print(f"GÃ¼ncelleme hatasÄ±: {e}")
        print("Manuel gÃ¼ncelleme gerekebilir.")
    except Exception as e:
        print(f"Beklenmeyen hata: {e}")


# ---------- SÄ°STEM KURTARMA VE Ä°ZLEME ----------

def system_health_check():
    """Sistem saÄŸlÄ±k kontrolÃ¼"""
    print("ðŸ” Sistem saÄŸlÄ±k kontrolÃ¼ yapÄ±lÄ±yor...")
    
    issues = []
    
    # OpenLiteSpeed kontrolÃ¼
    try:
        result = run("systemctl is-active lshttpd", check=False)
        if result.returncode != 0:
            issues.append("âŒ OpenLiteSpeed servisi Ã§alÄ±ÅŸmÄ±yor")
        else:
            print("âœ… OpenLiteSpeed servisi aktif")
    except:
        issues.append("âŒ OpenLiteSpeed servisi kontrol edilemedi")
    
    # MariaDB kontrolÃ¼
    try:
        result = run("systemctl is-active mariadb", check=False)
        if result.returncode != 0:
            issues.append("âŒ MariaDB servisi Ã§alÄ±ÅŸmÄ±yor")
        else:
            print("âœ… MariaDB servisi aktif")
    except:
        issues.append("âŒ MariaDB servisi kontrol edilemedi")
    
    # Disk alanÄ± kontrolÃ¼
    try:
        result = run("df -h /", check=True)
        if result.stdout:
            lines = result.stdout.strip().split('\n')
            if len(lines) > 1:
                usage_str = lines[1].split()[4].replace('%', '')
                if usage_str.isdigit():
                    usage = int(usage_str)
                    if usage > 90:
                        issues.append(f"âš ï¸ Disk alanÄ± %{usage} dolu - kritik seviye")
                    elif usage > 80:
                        issues.append(f"âš ï¸ Disk alanÄ± %{usage} dolu - dikkat")
                    else:
                        print(f"âœ… Disk alanÄ±: %{usage} kullanÄ±lmÄ±ÅŸ")
                else:
                    print(f"âœ… Disk alanÄ±: {usage_str} kullanÄ±lmÄ±ÅŸ")
            else:
                print("âœ… Disk bilgisi alÄ±ndÄ±")
        else:
            print("âš ï¸ Disk bilgisi alÄ±namadÄ±")
            issues.append("âŒ Disk alanÄ± kontrol edilemedi")
    except Exception as e:
        print(f"âš ï¸ Disk alanÄ± kontrol hatasÄ±: {e}")
        issues.append("âŒ Disk alanÄ± kontrol edilemedi")
    
    # RAM kullanÄ±mÄ± kontrolÃ¼
    try:
        result = run("free -m", check=True)
        if result.stdout:
            lines = result.stdout.strip().split('\n')
            if len(lines) > 1:
                mem_info = lines[1].split()
                if len(mem_info) >= 3:
                    total = int(mem_info[1])
                    used = int(mem_info[2])
                    usage_percent = (used / total) * 100
                    if usage_percent > 90:
                        issues.append(f"âš ï¸ RAM kullanÄ±mÄ± %{usage_percent:.1f} - kritik seviye")
                    else:
                        print(f"âœ… RAM kullanÄ±mÄ±: %{usage_percent:.1f}")
                else:
                    print("âœ… RAM bilgisi alÄ±ndÄ±")
            else:
                print("âœ… RAM bilgisi alÄ±ndÄ±")
        else:
            print("âš ï¸ RAM bilgisi alÄ±namadÄ±")
            issues.append("âŒ RAM kullanÄ±mÄ± kontrol edilemedi")
    except Exception as e:
        print(f"âš ï¸ RAM kontrol hatasÄ±: {e}")
        issues.append("âŒ RAM kullanÄ±mÄ± kontrol edilemedi")
    
    # KonfigÃ¼rasyon dosyalarÄ± kontrolÃ¼
    config_files = [
        "/usr/local/lsws/conf/httpd_config.conf",
        "/etc/mysql/mariadb.conf.d/50-server.cnf"
    ]
    
    # PHP konfigÃ¼rasyon dosyalarÄ±nÄ± kontrol et (sadece kurulu olanlarÄ±)
    php_versions = ["8.2", "8.3"]
    for version in php_versions:
        php_ini = f"/etc/php/{version}/fpm/php.ini"
        if Path(php_ini).exists():
            config_files.append(php_ini)
        else:
            # PHP kurulu deÄŸilse, alternatif yollarÄ± kontrol et
            alt_paths = [
                f"/usr/local/lsws/lsphp{version.replace('.', '')}/etc/php.ini",
                f"/etc/php/{version}/cli/php.ini"
            ]
            found = False
            for alt_path in alt_paths:
                if Path(alt_path).exists():
                    config_files.append(alt_path)
                    found = True
                    break
            if not found:
                print(f"â„¹ï¸ PHP {version} konfigÃ¼rasyonu bulunamadÄ± (kurulu olmayabilir)")
    
    for config_file in config_files:
        if Path(config_file).exists():
            print(f"âœ… KonfigÃ¼rasyon dosyasÄ± mevcut: {config_file}")
        else:
            issues.append(f"âŒ KonfigÃ¼rasyon dosyasÄ± eksik: {config_file}")
    
    if issues:
        print("\nðŸš¨ Tespit edilen sorunlar:")
        for issue in issues:
            print(f"  {issue}")
        return False
    else:
        print("\nâœ… Sistem saÄŸlÄ±klÄ± - tÃ¼m kontroller baÅŸarÄ±lÄ±!")
        return True


def emergency_backup():
    """Acil durum yedekleme"""
    print("ðŸš¨ Acil durum yedekleme baÅŸlatÄ±lÄ±yor...")
    
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup_dir = Path(f"/tmp/emergency_backup_{timestamp}")
    backup_dir.mkdir(exist_ok=True)
    
    try:
        # OpenLiteSpeed konfigÃ¼rasyonu
        ols_config = Path("/usr/local/lsws/conf/httpd_config.conf")
        if ols_config.exists():
            run(f"cp -r {ols_config.parent} {backup_dir}/openlitespeed_config", check=True)
            print("âœ… OpenLiteSpeed konfigÃ¼rasyonu yedeklendi")
        
        # MariaDB veritabanlarÄ± - MySQL root ÅŸifresi ile
        print("ðŸ—„ï¸ MariaDB veritabanlarÄ± yedekleniyor...")
        try:
            if MYSQL_ROOT_PASSWORD:
                run(f"mysqldump --all-databases --single-transaction --routines --triggers --password={MYSQL_ROOT_PASSWORD} > {backup_dir}/all_databases.sql", check=True)
            else:
                run(f"mysqldump --all-databases --single-transaction --routines --triggers > {backup_dir}/all_databases.sql", check=True)
            print("âœ… TÃ¼m veritabanlarÄ± yedeklendi")
        except Exception as e:
            print(f"âš ï¸ VeritabanÄ± yedekleme baÅŸarÄ±sÄ±z: {e}")
        
        # Domain dosyalarÄ± ve web iÃ§erikleri
        print("ðŸŒ Domain dosyalarÄ± yedekleniyor...")
        if VHOSTS_DIR.exists():
            run(f"cp -r {VHOSTS_DIR} {backup_dir}/domains", check=True)
            print("âœ… Domain konfigÃ¼rasyonlarÄ± yedeklendi")
        
        # Web iÃ§erikleri (domain klasÃ¶rleri)
        web_dirs = ["/var/www", "/usr/local/lsws/Example/html"]
        for web_dir in web_dirs:
            if Path(web_dir).exists():
                run(f"cp -r {web_dir} {backup_dir}/web_content_{Path(web_dir).name}", check=True)
                print(f"âœ… Web iÃ§eriÄŸi yedeklendi: {web_dir}")
        
        # Home dizini kullanÄ±cÄ± dosyalarÄ±
        print("ðŸ‘¤ KullanÄ±cÄ± dosyalarÄ± yedekleniyor...")
        if Path("/home").exists():
            run(f"cp -r /home {backup_dir}/home_backup", check=True)
            print("âœ… Home dizini kullanÄ±cÄ± dosyalarÄ± yedeklendi")
        
        # Domain bazÄ±nda yedekleme
        print("ðŸŒ Domain bazÄ±nda yedekleme yapÄ±lÄ±yor...")
        domain_backup_dir = backup_dir / "domain_backups"
        domain_backup_dir.mkdir(exist_ok=True)
        
        # VHOSTS dizinindeki domain'leri tara
        if VHOSTS_DIR.exists():
            for domain_dir in VHOSTS_DIR.iterdir():
                if domain_dir.is_dir():
                    domain_name = domain_dir.name
                    print(f"  ðŸ“ Domain yedekleniyor: {domain_name}")
                    
                    # Domain konfigÃ¼rasyonu
                    run(f"cp -r {domain_dir} {domain_backup_dir}/{domain_name}_config", check=True)
                    
                    # Domain web iÃ§eriÄŸi (farklÄ± olasÄ± konumlar)
                    possible_web_paths = [
                        f"/var/www/{domain_name}",
                        f"/home/{domain_name}",
                        f"/home/{domain_name}/public_html",
                        f"/home/{domain_name}/www",
                        f"/usr/local/lsws/Example/html/{domain_name}",
                        f"/var/www/html/{domain_name}"
                    ]
                    
                    for web_path in possible_web_paths:
                        if Path(web_path).exists():
                            run(f"cp -r {web_path} {domain_backup_dir}/{domain_name}_web", check=True)
                            print(f"    âœ… Web iÃ§eriÄŸi bulundu: {web_path}")
                            break
                    
                    # Domain SSL sertifikalarÄ±
                    ssl_paths = [
                        f"/usr/local/lsws/conf/cert/{domain_name}",
                        f"/etc/letsencrypt/live/{domain_name}",
                        f"/etc/letsencrypt/archive/{domain_name}"
                    ]
                    
                    for ssl_path in ssl_paths:
                        if Path(ssl_path).exists():
                            run(f"cp -r {ssl_path} {domain_backup_dir}/{domain_name}_ssl", check=True)
                            print(f"    âœ… SSL sertifikasÄ± bulundu: {ssl_path}")
                    
                    # Domain veritabanlarÄ± (domain adÄ± ile eÅŸleÅŸen)
                    try:
                        if MYSQL_ROOT_PASSWORD:
                            run(f"mysqldump --password={MYSQL_ROOT_PASSWORD} --databases {domain_name} > {domain_backup_dir}/{domain_name}_database.sql", check=True)
                        else:
                            run(f"mysqldump --databases {domain_name} > {domain_backup_dir}/{domain_name}_database.sql", check=True)
                        print(f"    âœ… Domain veritabanÄ± yedeklendi: {domain_name}")
                    except:
                        print(f"    âš ï¸ Domain veritabanÄ± bulunamadÄ±: {domain_name}")
                    
                    print(f"  âœ… Domain yedekleme tamamlandÄ±: {domain_name}")
            
            print(f"âœ… Domain bazÄ±nda yedekleme tamamlandÄ±: {len(list(VHOSTS_DIR.iterdir()))} domain")
        
        # OpenLiteSpeed loglarÄ±
        ols_logs = Path("/usr/local/lsws/logs")
        if ols_logs.exists():
            run(f"cp -r {ols_logs} {backup_dir}/openlitespeed_logs", check=True)
            print("âœ… OpenLiteSpeed loglarÄ± yedeklendi")
        
        # MariaDB loglarÄ±
        mysql_logs = Path("/var/log/mysql")
        if mysql_logs.exists():
            run(f"cp -r {mysql_logs} {backup_dir}/mysql_logs", check=True)
            print("âœ… MariaDB loglarÄ± yedeklendi")
        
        # PHP konfigÃ¼rasyonlarÄ± (OpenLiteSpeed PHP)
        php_configs = ["/usr/local/lsws/lsphp82", "/usr/local/lsws/lsphp83"]
        for php_config in php_configs:
            if Path(php_config).exists():
                run(f"cp -r {php_config} {backup_dir}/", check=True)
                print(f"âœ… PHP konfigÃ¼rasyonu yedeklendi: {php_config}")
        
        # SSL sertifikalarÄ±
        ssl_dirs = ["/usr/local/lsws/conf/cert", "/etc/letsencrypt"]
        for ssl_dir in ssl_dirs:
            if Path(ssl_dir).exists():
                run(f"cp -r {ssl_dir} {backup_dir}/ssl_{Path(ssl_dir).name}", check=True)
                print(f"âœ… SSL sertifikalarÄ± yedeklendi: {ssl_dir}")
        
        # Sistem bilgileri
        print("ðŸ“‹ Sistem bilgileri kaydediliyor...")
        with open(backup_dir / "system_info.txt", "w") as f:
            f.write(f"Yedekleme tarihi: {datetime.now()}\n")
            f.write(f"Sistem: {run('uname -a', check=True).stdout.strip()}\n")
            f.write(f"Disk kullanÄ±mÄ±:\n{run('df -h', check=True).stdout}\n")
            f.write(f"RAM kullanÄ±mÄ±:\n{run('free -h', check=True).stdout}\n")
            f.write(f"Servis durumlarÄ±:\n")
            f.write(f"OpenLiteSpeed: {run('systemctl is-active lshttpd', check=False).stdout.strip()}\n")
            f.write(f"MariaDB: {run('systemctl is-active mariadb', check=False).stdout.strip()}\n")
        
        # Yedekleme Ã¶zeti
        print("ðŸ“Š Yedekleme Ã¶zeti oluÅŸturuluyor...")
        with open(backup_dir / "backup_summary.txt", "w") as f:
            f.write(f"=== ACÄ°L YEDEKLEME Ã–ZETÄ° ===\n")
            f.write(f"Tarih: {datetime.now()}\n")
            f.write(f"Yedek dizini: {backup_dir}\n\n")
            f.write(f"Yedeklenen bileÅŸenler:\n")
            f.write(f"âœ… OpenLiteSpeed konfigÃ¼rasyonu\n")
            f.write(f"âœ… MariaDB veritabanlarÄ± (all_databases.sql)\n")
            f.write(f"âœ… Domain konfigÃ¼rasyonlarÄ±\n")
            f.write(f"âœ… Web iÃ§erikleri\n")
            f.write(f"âœ… Home dizini kullanÄ±cÄ± dosyalarÄ±\n")
            f.write(f"âœ… Domain bazÄ±nda yedekleme (her domain iÃ§in ayrÄ±)\n")
            f.write(f"âœ… OpenLiteSpeed loglarÄ±\n")
            f.write(f"âœ… MariaDB loglarÄ±\n")
            f.write(f"âœ… PHP konfigÃ¼rasyonlarÄ±\n")
            f.write(f"âœ… SSL sertifikalarÄ±\n")
            f.write(f"âœ… Sistem bilgileri\n\n")
            f.write(f"Domain bazÄ±nda yedeklenen veriler:\n")
            f.write(f"  - Domain konfigÃ¼rasyonu\n")
            f.write(f"  - Domain web iÃ§eriÄŸi\n")
            f.write(f"  - Domain SSL sertifikalarÄ±\n")
            f.write(f"  - Domain veritabanlarÄ±\n\n")
            f.write(f"Geri yÃ¼kleme iÃ§in: ispanel -> Acil Durum Kurtarma -> Yedekten geri yÃ¼kle\n")
        
        print(f"\nâœ… Acil yedekleme tamamlandÄ±: {backup_dir}")
        print(f"ðŸ’¾ Yedek boyutu: {run(f'du -sh {backup_dir}', check=True).stdout.strip()}")
        print(f"ðŸ“‹ Yedekleme Ã¶zeti: {backup_dir}/backup_summary.txt")
        
        return backup_dir
        
    except Exception as e:
        print(f"âŒ Acil yedekleme hatasÄ±: {e}")
        return None


def emergency_recovery():
    """Acil durum kurtarma"""
    print("ðŸš¨ Acil durum kurtarma menÃ¼sÃ¼")
    print("=" * 50)
    print("1) Sistem saÄŸlÄ±k kontrolÃ¼")
    print("2) Acil yedekleme oluÅŸtur")
    print("3) OpenLiteSpeed servisini yeniden baÅŸlat")
    print("4) MariaDB servisini yeniden baÅŸlat")
    print("5) TÃ¼m servisleri yeniden baÅŸlat")
    print("6) KonfigÃ¼rasyon dosyalarÄ±nÄ± onar")
    print("7) VeritabanÄ± onarÄ±mÄ±")
    print("8) Sistem temizliÄŸi")
    print("9) Yedekten geri yÃ¼kle")
    print("0) Ana menÃ¼ye dÃ¶n")
    
    choice = input("\nSeÃ§iminizi girin: ").strip()
    
    if choice == "1":
        system_health_check()
    elif choice == "2":
        emergency_backup()
    elif choice == "3":
        print("ðŸ”„ OpenLiteSpeed yeniden baÅŸlatÄ±lÄ±yor...")
        run("systemctl restart lshttpd", check=True)
        print("âœ… OpenLiteSpeed yeniden baÅŸlatÄ±ldÄ±")
    elif choice == "4":
        print("ðŸ”„ MariaDB yeniden baÅŸlatÄ±lÄ±yor...")
        run("systemctl restart mariadb", check=True)
        print("âœ… MariaDB yeniden baÅŸlatÄ±ldÄ±")
    elif choice == "5":
        print("ðŸ”„ TÃ¼m servisler yeniden baÅŸlatÄ±lÄ±yor...")
        run("systemctl restart lshttpd mariadb", check=True)
        print("âœ… TÃ¼m servisler yeniden baÅŸlatÄ±ldÄ±")
    elif choice == "6":
        repair_configurations()
    elif choice == "7":
        repair_databases()
    elif choice == "8":
        system_cleanup()
    elif choice == "9":
        restore_from_backup()
    elif choice == "0":
        return
    else:
        print("GeÃ§ersiz seÃ§im")
    
    input("\nDevam etmek iÃ§in Enter'a basÄ±n...")


def repair_configurations():
    """KonfigÃ¼rasyon dosyalarÄ±nÄ± onar"""
    print("ðŸ”§ KonfigÃ¼rasyon dosyalarÄ± onarÄ±lÄ±yor...")
    
    try:
        # OpenLiteSpeed konfigÃ¼rasyonu onarÄ±mÄ±
        ols_conf = Path("/usr/local/lsws/conf/httpd_config.conf")
        if not ols_conf.exists():
            print("âš ï¸ OpenLiteSpeed konfigÃ¼rasyonu eksik, yeniden oluÅŸturuluyor...")
            # Temel konfigÃ¼rasyon oluÅŸtur
            basic_config = """# OpenLiteSpeed Basic Configuration
serverName localhost
user nobody
group nogroup
chrootPath /usr/local/lsws/
enableChroot 0
priority 0
autoLoadHtaccess 1

listener HTTP {
    address *:80
    secure 0
    map * *
}

listener HTTPS {
    address *:443
    secure 1
    keyFile /usr/local/lsws/conf/cert/server.key
    certFile /usr/local/lsws/conf/cert/server.crt
    map * *
}

virtualHost Default {
    vhRoot /usr/local/lsws/Example/html/
    configFile /usr/local/lsws/conf/vhosts/Example/vhconf.conf
    allowSymbolLink 1
    enableScript 1
    restrained 1
    setUIDMode 0
    chrootPath /usr/local/lsws/Example/
    enableChroot 0
}
"""
            ols_conf.write_text(basic_config, encoding="utf-8")
            print("âœ… OpenLiteSpeed temel konfigÃ¼rasyonu oluÅŸturuldu")
        
        # MariaDB konfigÃ¼rasyonu kontrolÃ¼
        mysql_conf = Path("/etc/mysql/mariadb.conf.d/50-server.cnf")
        if not mysql_conf.exists():
            print("âš ï¸ MariaDB konfigÃ¼rasyonu eksik, varsayÄ±lan ayarlar uygulanÄ±yor...")
            run("systemctl stop mariadb", check=False)
            run("rm -rf /var/lib/mysql", check=False)
            run("mysql_install_db --user=mysql --basedir=/usr --datadir=/var/lib/mysql", check=True)
            run("systemctl start mariadb", check=True)
            print("âœ… MariaDB konfigÃ¼rasyonu onarÄ±ldÄ±")
        
        # PHP konfigÃ¼rasyonlarÄ±
        php_versions = ["8.2", "8.3"]
        for version in php_versions:
            php_ini = Path(f"/etc/php/{version}/fpm/php.ini")
            if not php_ini.exists():
                print(f"âš ï¸ PHP {version} konfigÃ¼rasyonu eksik, varsayÄ±lan ayarlar uygulanÄ±yor...")
                run(f"apt-get install -y php{version}-fpm", check=True)
                print(f"âœ… PHP {version} konfigÃ¼rasyonu onarÄ±ldÄ±")
        
        print("âœ… TÃ¼m konfigÃ¼rasyonlar onarÄ±ldÄ±")
        
    except Exception as e:
        print(f"âŒ KonfigÃ¼rasyon onarÄ±m hatasÄ±: {e}")


def repair_databases():
    """VeritabanÄ± onarÄ±mÄ±"""
    print("ðŸ”§ VeritabanÄ± onarÄ±mÄ± baÅŸlatÄ±lÄ±yor...")
    
    try:
        # MariaDB servisini baÅŸlat
        run("systemctl start mariadb", check=True)
        print("âœ… MariaDB servisi baÅŸlatÄ±ldÄ±")
        
        # VeritabanÄ± onarÄ±mÄ±
        print("ðŸ”„ VeritabanlarÄ± onarÄ±lÄ±yor...")
        run("mysqlcheck --all-databases --auto-repair --optimize", check=True)
        print("âœ… VeritabanlarÄ± onarÄ±ldÄ±")
        
        # KullanÄ±cÄ± izinlerini kontrol et
        print("ðŸ”„ KullanÄ±cÄ± izinleri kontrol ediliyor...")
        run("mysql -e 'FLUSH PRIVILEGES;'", check=True)
        print("âœ… KullanÄ±cÄ± izinleri gÃ¼ncellendi")
        
    except Exception as e:
        print(f"âŒ VeritabanÄ± onarÄ±m hatasÄ±: {e}")


def system_cleanup():
    """Sistem temizliÄŸi"""
    print("ðŸ§¹ Sistem temizliÄŸi baÅŸlatÄ±lÄ±yor...")
    
    try:
        # GeÃ§ici dosyalarÄ± temizle
        run("rm -rf /tmp/*", check=False)
        print("âœ… GeÃ§ici dosyalar temizlendi")
        
        # Log dosyalarÄ±nÄ± temizle (eski olanlarÄ±)
        run("find /var/log -name '*.log' -mtime +7 -delete", check=False)
        print("âœ… Eski log dosyalarÄ± temizlendi")
        
        # APT cache temizliÄŸi
        run("apt-get clean", check=True)
        print("âœ… APT cache temizlendi")
        
        # Disk alanÄ± kontrolÃ¼
        result = run("df -h /", check=True)
        print(f"ðŸ’¾ Disk kullanÄ±mÄ±:\n{result.stdout}")
        
    except Exception as e:
        print(f"âŒ Sistem temizlik hatasÄ±: {e}")


def restore_from_backup():
    """Yedekten geri yÃ¼kleme"""
    print("ðŸ“¦ Yedekten geri yÃ¼kleme menÃ¼sÃ¼")
    
    # Mevcut yedekleri listele
    backup_dirs = []
    for item in Path("/tmp").iterdir():
        if item.is_dir() and item.name.startswith("emergency_backup_"):
            backup_dirs.append(item)
    
    if not backup_dirs:
        print("âŒ Acil yedek bulunamadÄ±")
        return
    
    print("\nMevcut yedekler:")
    for i, backup_dir in enumerate(backup_dirs, 1):
        print(f"{i}) {backup_dir.name}")
    
    choice = input("\nGeri yÃ¼klenecek yedek numarasÄ±nÄ± girin (0=Ä°ptal): ").strip()
    
    if choice == "0":
        return
    
    try:
        idx = int(choice) - 1
        if 0 <= idx < len(backup_dirs):
            backup_dir = backup_dirs[idx]
            print(f"ðŸ”„ {backup_dir.name} geri yÃ¼kleniyor...")
            
            # Yedekleme Ã¶zetini gÃ¶ster
            summary_file = backup_dir / "backup_summary.txt"
            if summary_file.exists():
                print("\nðŸ“‹ Yedekleme Ã¶zeti:")
                with open(summary_file, 'r') as f:
                    print(f.read())
            
            # OpenLiteSpeed konfigÃ¼rasyonu geri yÃ¼kle
            ols_backup = backup_dir / "openlitespeed_config"
            if ols_backup.exists():
                run(f"cp -r {ols_backup}/* /usr/local/lsws/conf/", check=True)
                print("âœ… OpenLiteSpeed konfigÃ¼rasyonu geri yÃ¼klendi")
            
            # VeritabanlarÄ± geri yÃ¼kle
            db_backup = backup_dir / "all_databases.sql"
            if db_backup.exists():
                if MYSQL_ROOT_PASSWORD:
                    run(f"mysql --password={MYSQL_ROOT_PASSWORD} < {db_backup}", check=True)
                else:
                    run(f"mysql < {db_backup}", check=True)
                print("âœ… VeritabanlarÄ± geri yÃ¼klendi")
            
            # Domain dosyalarÄ± geri yÃ¼kle
            domains_backup = backup_dir / "domains"
            if domains_backup.exists():
                run(f"cp -r {domains_backup}/* {VHOSTS_DIR}/", check=True)
                print("âœ… Domain konfigÃ¼rasyonlarÄ± geri yÃ¼klendi")
            
            # Web iÃ§erikleri geri yÃ¼kle
            web_content_dirs = ["web_content_www", "web_content_html"]
            for web_dir in web_content_dirs:
                web_backup = backup_dir / web_dir
                if web_backup.exists():
                    if "www" in web_dir:
                        run(f"cp -r {web_backup}/* /var/www/", check=True)
                        print("âœ… Web iÃ§eriÄŸi geri yÃ¼klendi: /var/www")
                    elif "html" in web_dir:
                        run(f"cp -r {web_backup}/* /usr/local/lsws/Example/html/", check=True)
                        print("âœ… Web iÃ§eriÄŸi geri yÃ¼klendi: /usr/local/lsws/Example/html")
            
            # Home dizini kullanÄ±cÄ± dosyalarÄ± geri yÃ¼kle
            home_backup = backup_dir / "home_backup"
            if home_backup.exists():
                run(f"cp -r {home_backup}/* /home/", check=True)
                print("âœ… Home dizini kullanÄ±cÄ± dosyalarÄ± geri yÃ¼klendi")
            
            # Domain bazÄ±nda geri yÃ¼kleme
            domain_backup_dir = backup_dir / "domain_backups"
            if domain_backup_dir.exists():
                print("ðŸŒ Domain bazÄ±nda geri yÃ¼kleme yapÄ±lÄ±yor...")
                for domain_backup in domain_backup_dir.iterdir():
                    if domain_backup.is_dir():
                        domain_name = domain_backup.name.replace("_config", "").replace("_web", "").replace("_ssl", "").replace("_database", "")
                        
                        # Domain konfigÃ¼rasyonu geri yÃ¼kle
                        if domain_backup.name.endswith("_config"):
                            run(f"cp -r {domain_backup}/* {VHOSTS_DIR}/{domain_name}/", check=True)
                            print(f"  âœ… Domain konfigÃ¼rasyonu geri yÃ¼klendi: {domain_name}")
                        
                        # Domain web iÃ§eriÄŸi geri yÃ¼kle
                        elif domain_backup.name.endswith("_web"):
                            # FarklÄ± olasÄ± konumlarÄ± dene
                            possible_web_paths = [
                                f"/var/www/{domain_name}",
                                f"/home/{domain_name}",
                                f"/home/{domain_name}/public_html",
                                f"/home/{domain_name}/www",
                                f"/usr/local/lsws/Example/html/{domain_name}",
                                f"/var/www/html/{domain_name}"
                            ]
                            
                            for web_path in possible_web_paths:
                                if Path(web_path).parent.exists():
                                    run(f"cp -r {domain_backup}/* {web_path}/", check=True)
                                    print(f"  âœ… Domain web iÃ§eriÄŸi geri yÃ¼klendi: {domain_name} -> {web_path}")
                                    break
                        
                        # Domain SSL sertifikalarÄ± geri yÃ¼kle
                        elif domain_backup.name.endswith("_ssl"):
                            ssl_paths = [
                                f"/usr/local/lsws/conf/cert/{domain_name}",
                                f"/etc/letsencrypt/live/{domain_name}",
                                f"/etc/letsencrypt/archive/{domain_name}"
                            ]
                            
                            for ssl_path in ssl_paths:
                                if Path(ssl_path).parent.exists():
                                    run(f"cp -r {domain_backup}/* {ssl_path}/", check=True)
                                    print(f"  âœ… Domain SSL sertifikasÄ± geri yÃ¼klendi: {domain_name} -> {ssl_path}")
                                    break
                        
                        # Domain veritabanÄ± geri yÃ¼kle
                        elif domain_backup.name.endswith("_database"):
                            db_file = domain_backup / f"{domain_name}_database.sql"
                            if db_file.exists():
                                try:
                                    if MYSQL_ROOT_PASSWORD:
                                        run(f"mysql --password={MYSQL_ROOT_PASSWORD} < {db_file}", check=True)
                                    else:
                                        run(f"mysql < {db_file}", check=True)
                                    print(f"  âœ… Domain veritabanÄ± geri yÃ¼klendi: {domain_name}")
                                except:
                                    print(f"  âš ï¸ Domain veritabanÄ± geri yÃ¼klenemedi: {domain_name}")
                
                print("âœ… Domain bazÄ±nda geri yÃ¼kleme tamamlandÄ±")
            
            # SSL sertifikalarÄ± geri yÃ¼kle
            ssl_dirs = ["ssl_cert", "ssl_letsencrypt"]
            for ssl_dir in ssl_dirs:
                ssl_backup = backup_dir / ssl_dir
                if ssl_backup.exists():
                    if "cert" in ssl_dir:
                        run(f"cp -r {ssl_backup}/* /usr/local/lsws/conf/cert/", check=True)
                        print("âœ… SSL sertifikalarÄ± geri yÃ¼klendi: /usr/local/lsws/conf/cert")
                    elif "letsencrypt" in ssl_dir:
                        run(f"cp -r {ssl_backup}/* /etc/letsencrypt/", check=True)
                        print("âœ… Let's Encrypt sertifikalarÄ± geri yÃ¼klendi: /etc/letsencrypt")
            
            # PHP konfigÃ¼rasyonlarÄ± geri yÃ¼kle
            php_dirs = ["lsphp82", "lsphp83"]
            for php_dir in php_dirs:
                php_backup = backup_dir / php_dir
                if php_backup.exists():
                    run(f"cp -r {php_backup}/* /usr/local/lsws/{php_dir}/", check=True)
                    print(f"âœ… PHP konfigÃ¼rasyonu geri yÃ¼klendi: {php_dir}")
            
            # Servisleri yeniden baÅŸlat
            print("ðŸ”„ Servisler yeniden baÅŸlatÄ±lÄ±yor...")
            run("systemctl restart lshttpd mariadb", check=True)
            print("âœ… Servisler yeniden baÅŸlatÄ±ldÄ±")
            
            # Dosya izinlerini dÃ¼zelt
            print("ðŸ”§ Dosya izinleri dÃ¼zeltiliyor...")
            run("chown -R lsadm:lsadm /usr/local/lsws/", check=True)
            run("chown -R mysql:mysql /var/lib/mysql/", check=True)
            print("âœ… Dosya izinleri dÃ¼zeltildi")
            
            print(f"\nâœ… Geri yÃ¼kleme tamamlandÄ±: {backup_dir.name}")
            print("ðŸ’¡ Sisteminizi test etmek iÃ§in web sitelerinizi kontrol edin.")
        else:
            print("âŒ GeÃ§ersiz seÃ§im")
    
    except Exception as e:
        print(f"âŒ Geri yÃ¼kleme hatasÄ±: {e}")


def auto_backup_system():
    """Otomatik yedekleme sistemi"""
    print("ðŸ¤– Otomatik yedekleme sistemi kuruluyor...")
    
    try:
        # Cron job oluÅŸtur
        cron_job = "0 2 * * * /usr/local/bin/ispanel --auto-backup >/dev/null 2>&1"
        
        # Mevcut cron jobs'Ä± kontrol et
        result = run("crontab -l", check=False)
        if result.returncode == 0 and "ispanel --auto-backup" not in result.stdout:
            # Yeni cron job ekle
            current_cron = result.stdout if result.stdout else ""
            new_cron = current_cron + "\n" + cron_job + "\n"
            run(f"echo '{new_cron}' | crontab -", check=True)
            print("âœ… Otomatik yedekleme cron job'Ä± eklendi")
        else:
            print("â„¹ï¸ Otomatik yedekleme zaten aktif")
        
        # Yedekleme dizini oluÅŸtur
        backup_dir = Path("/var/backups/ispanel")
        backup_dir.mkdir(parents=True, exist_ok=True)
        print(f"âœ… Yedekleme dizini oluÅŸturuldu: {backup_dir}")
        
        print("\nðŸ“‹ Otomatik yedekleme ayarlarÄ±:")
        print("â€¢ Yedekleme zamanÄ±: Her gÃ¼n saat 02:00")
        print("â€¢ Yedekleme dizini: /var/backups/ispanel")
        print("â€¢ Saklama sÃ¼resi: 30 gÃ¼n")
        
    except Exception as e:
        print(f"âŒ Otomatik yedekleme kurulum hatasÄ±: {e}")


def system_monitoring():
    """Sistem izleme"""
    print("ðŸ“Š Sistem izleme baÅŸlatÄ±lÄ±yor...")
    
    while True:
        print("\n" + "="*50)
        print("ðŸ“Š SÄ°STEM Ä°ZLEME PANELÄ°")
        print("="*50)
        print("1) AnlÄ±k sistem durumu")
        print("2) Servis durumlarÄ±")
        print("3) Disk kullanÄ±mÄ±")
        print("4) RAM kullanÄ±mÄ±")
        print("5) AÄŸ baÄŸlantÄ±larÄ±")
        print("6) Log dosyalarÄ±")
        print("7) SÃ¼rekli izleme (5 saniye)")
        print("0) Ana menÃ¼ye dÃ¶n")
        
        choice = input("\nSeÃ§iminizi girin: ").strip()
        
        if choice == "1":
            system_health_check()
        elif choice == "2":
            show_service_status()
        elif choice == "3":
            show_disk_usage()
        elif choice == "4":
            show_memory_usage()
        elif choice == "5":
            show_network_connections()
        elif choice == "6":
            show_log_files()
        elif choice == "7":
            continuous_monitoring()
        elif choice == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")
        
        if choice != "7":
            input("\nDevam etmek iÃ§in Enter'a basÄ±n...")


def show_service_status():
    """Servis durumlarÄ±nÄ± gÃ¶ster"""
    print("ðŸ” Servis durumlarÄ± kontrol ediliyor...")
    
    services = ["lshttpd", "mariadb"]
    
    for service in services:
        try:
            result = run(f"systemctl is-active {service}", check=False)
            status = "âœ… Aktif" if result.returncode == 0 else "âŒ Pasif"
            print(f"{service}: {status}")
        except:
            print(f"{service}: â“ Bilinmiyor")
    
    # OpenLiteSpeed PHP durumunu kontrol et
    print("\nðŸ” OpenLiteSpeed PHP durumu:")
    try:
        result = run("ls -la /usr/local/lsws/lsphp*", check=False)
        if result.stdout:
            print("âœ… OpenLiteSpeed PHP sÃ¼rÃ¼mleri:")
            for line in result.stdout.strip().split('\n'):
                if 'lsphp' in line:
                    print(f"  {line}")
        else:
            print("âš ï¸ OpenLiteSpeed PHP sÃ¼rÃ¼mleri bulunamadÄ±")
    except:
        print("â“ OpenLiteSpeed PHP durumu kontrol edilemedi")


def show_disk_usage():
    """Disk kullanÄ±mÄ±nÄ± gÃ¶ster"""
    print("ðŸ’¾ Disk kullanÄ±mÄ±:")
    run("df -h", check=True)


def show_memory_usage():
    """RAM kullanÄ±mÄ±nÄ± gÃ¶ster"""
    print("ðŸ§  RAM kullanÄ±mÄ±:")
    run("free -h", check=True)


def show_network_connections():
    """AÄŸ baÄŸlantÄ±larÄ±nÄ± gÃ¶ster"""
    print("ðŸŒ AÄŸ baÄŸlantÄ±larÄ±:")
    run("netstat -tulpn | grep -E ':(80|443|3306)'", check=True)


def show_log_files():
    """Log dosyalarÄ±nÄ± gÃ¶ster"""
    print("ðŸ“‹ Son log kayÄ±tlarÄ±:")
    print("\nOpenLiteSpeed loglarÄ±:")
    run("tail -10 /usr/local/lsws/logs/error.log", check=False)
    print("\nMariaDB loglarÄ±:")
    run("tail -10 /var/log/mysql/error.log", check=False)


def continuous_monitoring():
    """SÃ¼rekli izleme"""
    print("ðŸ”„ SÃ¼rekli izleme baÅŸlatÄ±ldÄ± (Ctrl+C ile Ã§Ä±kÄ±ÅŸ)")
    
    try:
        while True:
            print("\n" + "="*50)
            print(f"ðŸ“Š {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print("="*50)
            
            # Sistem durumu
            system_health_check()
            
            # 5 saniye bekle
            time.sleep(5)
            
    except KeyboardInterrupt:
        print("\nðŸ›‘ Ä°zleme durduruldu")

def system_management_menu():
    """Sistem yÃ¶netimi menÃ¼sÃ¼"""
    while True:
        print("\n--- Sistem YÃ¶netimi ---")
        print("1) Sistem bilgileri")
        print("2) Servis durumlarÄ±")
        print("3) Disk kullanÄ±mÄ±")
        print("4) RAM kullanÄ±mÄ±")
        print("5) AÄŸ baÄŸlantÄ±larÄ±")
        print("6) Log dosyalarÄ±")
        print("7) Sistem temizliÄŸi")
        print("8) Otomatik yedekleme kurulumu")
        print("9) .htaccess Watcher Durumu")
        print("0) Ana menÃ¼ye dÃ¶n")
        
        choice = input("\nSeÃ§iminizi girin: ").strip()
        
        if choice == "1":
            show_system_info()
        elif choice == "2":
            show_service_status()
        elif choice == "3":
            show_disk_usage()
        elif choice == "4":
            show_memory_usage()
        elif choice == "5":
            show_network_connections()
        elif choice == "6":
            show_log_files()
        elif choice == "7":
            system_cleanup()
        elif choice == "8":
            auto_backup_system()
        elif choice == "9":
            check_htaccess_watcher_status()
        elif choice == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")
        
        if choice != "0":
            input("\nDevam etmek iÃ§in Enter'a basÄ±n...")


def show_system_info():
    """Sistem bilgilerini gÃ¶ster"""
    print("ðŸ’» Sistem Bilgileri:")
    print(f"Sistem: {run('uname -a', check=True).stdout.strip()}")
    print(f"Ã‡alÄ±ÅŸma sÃ¼resi: {run('uptime', check=True).stdout.strip()}")
    print(f"YÃ¼kleme: {run('cat /proc/loadavg', check=True).stdout.strip()}")
    print(f"Disk kullanÄ±mÄ±:\n{run('df -h', check=True).stdout}")
    print(f"RAM kullanÄ±mÄ±:\n{run('free -h', check=True).stdout}")


def ols_php_menu():
    """OpenLiteSpeed PHP yÃ¶netimi menÃ¼sÃ¼"""
    print("\n--- OpenLiteSpeed PHP YÃ¶netimi ---")
    print("1) PHP sÃ¼rÃ¼mlerini listele")
    print("2) PHP sÃ¼rÃ¼mÃ¼ deÄŸiÅŸtir")
    print("3) PHP modÃ¼llerini listele")
    print("4) PHP konfigÃ¼rasyonunu dÃ¼zenle")
    print("0) Ana menÃ¼ye dÃ¶n")
    
    choice = input("\nSeÃ§iminizi girin: ").strip()
    
    if choice == "1":
        list_php_versions()
    elif choice == "2":
        change_php_version()
    elif choice == "3":
        list_php_modules()
    elif choice == "4":
        edit_php_config()
    elif choice == "0":
        return
    else:
        print("GeÃ§ersiz seÃ§im")


def list_php_versions():
    """PHP sÃ¼rÃ¼mlerini listele"""
    print("ðŸ“‹ Mevcut PHP sÃ¼rÃ¼mleri:")
    run("ls -la /usr/local/lsws/lsphp*", check=True)


def change_php_version():
    """PHP sÃ¼rÃ¼mÃ¼ deÄŸiÅŸtir"""
    print("ðŸ”„ PHP sÃ¼rÃ¼mÃ¼ deÄŸiÅŸtirme")
    print("1) PHP 8.2")
    print("2) PHP 8.3")
    
    choice = input("SeÃ§iminizi girin: ").strip()
    
    if choice == "1":
        run("ln -sf /usr/local/lsws/lsphp82/bin/lsphp /usr/local/lsws/fcgi-bin/lsphp", check=True)
        print("âœ… PHP 8.2 aktif edildi")
    elif choice == "2":
        run("ln -sf /usr/local/lsws/lsphp83/bin/lsphp /usr/local/lsws/fcgi-bin/lsphp", check=True)
        print("âœ… PHP 8.3 aktif edildi")
    else:
        print("GeÃ§ersiz seÃ§im")


def list_php_modules():
    """PHP modÃ¼llerini listele"""
    print("ðŸ“‹ PHP modÃ¼lleri:")
    run("php -m", check=True)


def edit_php_config():
    """PHP konfigÃ¼rasyonunu dÃ¼zenle"""
    print("ðŸ“ PHP konfigÃ¼rasyonu dÃ¼zenleme")
    print("1) PHP 8.2 konfigÃ¼rasyonu")
    print("2) PHP 8.3 konfigÃ¼rasyonu")
    
    choice = input("SeÃ§iminizi girin: ").strip()
    
    if choice == "1":
        run("nano /etc/php/8.2/fpm/php.ini", check=True)
    elif choice == "2":
        run("nano /etc/php/8.3/fpm/php.ini", check=True)
    else:
        print("GeÃ§ersiz seÃ§im")


def cache_menu():
    """Cache yÃ¶netimi menÃ¼sÃ¼"""
    print("\n--- Cache YÃ¶netimi ---")
    print("1) OpenLiteSpeed cache temizle")
    print("2) PHP OPcache temizle")
    print("3) TÃ¼m cache'leri temizle")
    print("4) Cache durumunu kontrol et")
    print("5) Domain iÃ§in OLS Cache aÃ§/kapat")
    print("0) Ana menÃ¼ye dÃ¶n")
    
    choice = input("\nSeÃ§iminizi girin: ").strip()
    
    if choice == "1":
        clear_ols_cache()
    elif choice == "2":
        clear_php_cache()
    elif choice == "3":
        clear_all_cache()
    elif choice == "4":
        check_cache_status()
    elif choice == "5":
        toggle_domain_cache_menu()
    elif choice == "0":
        return
    else:
        print("GeÃ§ersiz seÃ§im")


def clear_ols_cache():
    """OpenLiteSpeed cache temizle"""
    print("ðŸ§¹ OpenLiteSpeed cache temizleniyor...")
    run("rm -rf /usr/local/lsws/cachedata/*", check=True)
    run("systemctl reload lshttpd", check=True)
    print("âœ… OpenLiteSpeed cache temizlendi")


def clear_php_cache():
    """PHP cache temizle"""
    print("ðŸ§¹ PHP cache temizleniyor...")
    # OpenLiteSpeed PHP cache temizleme
    run("rm -rf /usr/local/lsws/cachedata/*", check=False)
    run("systemctl reload lshttpd", check=True)
    print("âœ… OpenLiteSpeed PHP cache temizlendi")


def clear_all_cache():
    """TÃ¼m cache'leri temizle"""
    print("ðŸ§¹ TÃ¼m cache'ler temizleniyor...")
    clear_ols_cache()
    clear_php_cache()
    print("âœ… TÃ¼m cache'ler temizlendi")


def check_cache_status():
    """Cache durumunu kontrol et"""
    print("ðŸ“Š Cache durumu:")
    print("OpenLiteSpeed cache dizini:")
    run("ls -la /usr/local/lsws/cachedata/", check=True)
    print("\nPHP OPcache durumu:")
    run("php -r 'echo phpinfo();' | grep -i opcache", check=True)


def repair_menu():
    """OnarÄ±m menÃ¼sÃ¼"""
    print("\n--- Sistem OnarÄ±mÄ± ---")
    print("1) KonfigÃ¼rasyon dosyalarÄ±nÄ± onar")
    print("2) VeritabanÄ± onarÄ±mÄ±")
    print("3) Servisleri yeniden baÅŸlat")
    print("4) Dosya izinlerini dÃ¼zelt")
    print("5) Symlink'leri dÃ¼zelt")
    print("0) Ana menÃ¼ye dÃ¶n")
    
    choice = input("\nSeÃ§iminizi girin: ").strip()
    
    if choice == "1":
        repair_configurations()
    elif choice == "2":
        repair_databases()
    elif choice == "3":
        restart_services()
    elif choice == "4":
        fix_permissions()
    elif choice == "5":
        fix_symlinks()
    elif choice == "0":
        return
    else:
        print("GeÃ§ersiz seÃ§im")


def restart_services():
    """Servisleri yeniden baÅŸlat"""
    print("ðŸ”„ Servisler yeniden baÅŸlatÄ±lÄ±yor...")
    run("systemctl restart lshttpd mariadb", check=True)
    print("âœ… TÃ¼m servisler yeniden baÅŸlatÄ±ldÄ±")


def fix_permissions():
    """Dosya izinlerini dÃ¼zelt"""
    print("ðŸ”§ Dosya izinleri dÃ¼zeltiliyor...")
    run("chown -R lsadm:lsadm /usr/local/lsws/", check=True)
    run("chmod -R 755 /usr/local/lsws/", check=True)
    run("chown -R mysql:mysql /var/lib/mysql/", check=True)
    print("âœ… Dosya izinleri dÃ¼zeltildi")


def fix_symlinks():
    """Symlink'leri dÃ¼zelt"""
    print("ðŸ”§ Symlink'ler dÃ¼zeltiliyor...")
    run("rm -f /usr/local/bin/ispanel", check=False)
    install_symlink()
    print("âœ… Symlink'ler dÃ¼zeltildi")


def main():
    # KonfigÃ¼rasyonu yÃ¼kle
    load_config()
    
    parser = argparse.ArgumentParser(description="SSH tabanlÄ± mini panel (Ubuntu 22+)")
    sub = parser.add_subparsers(dest="cmd")

    p_install = sub.add_parser("install", help="OpenLiteSpeed, PHP 8.2 ve MariaDB kur")
    p_install.set_defaults(func=cmd_install)

    p_install_symlink = sub.add_parser("install-symlink", help="isPanel komutunu kur")

    def _install_symlink(args):
        install_symlink()

    p_install_symlink.set_defaults(func=_install_symlink)

    p_dadd = sub.add_parser("domain-add", help="Domain ekle")
    p_dadd.add_argument("domain")

    def _dadd(args):
        require_root()
        domain_add(args.domain)

    p_dadd.set_defaults(func=_dadd)

    p_drm = sub.add_parser("domain-rm", help="Domain sil")
    p_drm.add_argument("domain")

    def _drm(args):
        require_root()
        domain_remove(args.domain)

    p_drm.set_defaults(func=_drm)

    p_dbcreate = sub.add_parser(
        "db-create", help="MariaDB veritabanÄ± ve kullanÄ±cÄ± oluÅŸtur"
    )
    p_dbcreate.add_argument("db")
    p_dbcreate.add_argument("user")
    p_dbcreate.add_argument("password")

    def _dbcreate(args):
        require_root()
        db_create(args.db, args.user, args.password)

    p_dbcreate.set_defaults(func=_dbcreate)

    p_dbdelete = sub.add_parser("db-delete", help="MariaDB veritabanÄ± ve kullanÄ±cÄ± sil")
    p_dbdelete.add_argument("db")
    p_dbdelete.add_argument("user")

    def _dbdelete(args):
        require_root()
        db_delete(args.db, args.user)

    p_dbdelete.set_defaults(func=_dbdelete)

    # EtkileÅŸimli menÃ¼
    p_menu = sub.add_parser("menu", help="Ä°nteraktif menÃ¼yÃ¼ baÅŸlat")

    def _menu(args):
        require_root()
        select_language()
        interactive_menu()

    p_menu.set_defaults(func=_menu)

    args = parser.parse_args()
    if not hasattr(args, "func"):
        # VarsayÄ±lan olarak menÃ¼yÃ¼ aÃ§
        if os.geteuid() == 0:
            # Dil seÃ§imi yap
            select_language()
            interactive_menu()
            return
        else:
            parser.print_help()
            sys.exit(1)
    args.func(args)


if __name__ == "__main__":
    main()
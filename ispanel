#!/usr/bin/env python3
import argparse
import os
import re
import shutil
import subprocess
import sys
import time
from pathlib import Path


def run(cmd: str, check: bool = True) -> subprocess.CompletedProcess:
    return subprocess.run(cmd, shell=True, check=check, text=True)


def require_root():
    if os.geteuid() != 0:
        print("Bu komutlarÄ± root olarak Ã§alÄ±ÅŸtÄ±rÄ±n (sudo kullanÄ±n).", file=sys.stderr)
        sys.exit(1)


def wait_for_apt(max_retries: int = 30, delay: int = 10):
    retries = 0
    while retries < max_retries:
        cp = subprocess.run(
            "ps aux | grep -E '(apt|apt-get)\\s' | grep -v grep | grep -v _apt",
            shell=True,
            text=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
        )
        if not cp.stdout.strip():
            return
        retries += 1
        print(f"apt kullanÄ±mda, {retries}/{max_retries} bekleniyor...", flush=True)
        time.sleep(delay)
    print("HATA: apt kilitli gÃ¶rÃ¼nÃ¼yor. LÃ¼tfen diÄŸer apt iÅŸlemlerini kapatÄ±n.", file=sys.stderr)
    sys.exit(1)


def ensure_cmd(cmd: str, pkg: str):
    if shutil.which(cmd):
        return
    wait_for_apt()
    run(f"DEBIAN_FRONTEND=noninteractive apt-get update -y")
    run(f"DEBIAN_FRONTEND=noninteractive apt-get install -y {pkg}")
    if not shutil.which(cmd):
        print(f"Gerekli komut bulunamadÄ±: {cmd} (paket: {pkg})", file=sys.stderr)
        sys.exit(1)


def check_disk_space(min_gb: int = 1):
    df = shutil.disk_usage("/")
    available_gb = df.free // (1024 * 1024 * 1024)
    print(f"BoÅŸ disk alanÄ±: {available_gb} GB")
    if available_gb < min_gb:
        print("En az 1GB boÅŸ alan gerekli.", file=sys.stderr)
        sys.exit(1)


def install_openlitespeed_and_php(lsphp_version: str = "83"):
    print(f"OpenLiteSpeed ve PHP {lsphp_version[0]}.{lsphp_version[1]} kuruluyor...")
    wait_for_apt()
    run("DEBIAN_FRONTEND=noninteractive apt-get update -y")
    ensure_cmd("curl", "curl")
    ensure_cmd("wget", "wget")

    # Litespeed repo
    run("wget -O - https://repo.litespeed.sh | bash", check=True)

    # Paketler
    run("DEBIAN_FRONTEND=noninteractive apt-get -y install openlitespeed", check=True)
    # TÃ¼m lsphp paketlerini (81/82/83) kur
    run("DEBIAN_FRONTEND=noninteractive apt-get -y install lsphp81* lsphp82* lsphp83*", check=True)

    # Hizmetleri baÅŸlat/enable
    # openlitespeed service name is usually 'lsws'
    try:
        run("systemctl enable lsws", check=False)
        run("systemctl restart lsws", check=True)
    except subprocess.CalledProcessError:
        run("/usr/local/lsws/bin/lswsctrl restart", check=True)


def install_mariadb():
    print("MariaDB kuruluyor...")
    wait_for_apt()
    run("DEBIAN_FRONTEND=noninteractive apt-get update -y")
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y mariadb-server", check=True)
    run("systemctl enable mariadb", check=False)
    run("systemctl restart mariadb", check=True)


def install_symlink():
    target = Path("/usr/local/bin/ispanel")
    me = Path(__file__).resolve()

    try:
        if target.exists() or target.is_symlink():
            target.unlink()
    except IsADirectoryError:
        raise RuntimeError(f"{target} bir dizin, symlink oluÅŸturulamadÄ±")

    try:
        os.symlink(str(me), str(target))
        print(f"Symlink oluÅŸturuldu: {target} -> {me}")
        return
    except OSError as exc:
        print(f"Symlink oluÅŸturulamadÄ± ({exc}), Python wrapper oluÅŸturulacak...")

    wrapper = (
        "#!/usr/bin/env python3\n"
        "import os\n"
        "import sys\n"
        f"os.execv(sys.executable, [sys.executable, '{me}'] + sys.argv[1:])\n"
    )
    target.write_text(wrapper, encoding="utf-8")
    os.chmod(target, 0o755)
    print(f"Python wrapper oluÅŸturuldu: {target}")


def cmd_install(args: argparse.Namespace):
    require_root()
    check_disk_space(1)

    # OS kontrolÃ¼
    with open("/etc/os-release", "r", encoding="utf-8") as f:
        osr = f.read()
    if "Ubuntu" not in osr:
        print("Bu kurulum Ubuntu 22+ iÃ§in tasarlanmÄ±ÅŸtÄ±r.", file=sys.stderr)
    
    print("=== ispanel Kurulum BaÅŸlÄ±yor ===")
    
    # Temel kurulum
    install_openlitespeed_and_php(DEFAULT_LSPHP_VERSION)
    install_mariadb()
    
    # GÃ¼venlik ve performans ayarlarÄ±
    print("\n=== GÃ¼venlik ve Performans AyarlarÄ± ===")
    manage_firewall()
    install_ssl_support()
    secure_mariadb()
    optimize_openlitespeed()
    
    # PHP OPcache konfigÃ¼rasyonu
    configure_php_opcache()
    
    # Yedek dizinleri oluÅŸtur
    Path("/home/backup/domains").mkdir(parents=True, exist_ok=True)
    Path("/home/backup/databases").mkdir(parents=True, exist_ok=True)
    
    # Symlink oluÅŸtur
    install_symlink()
    
    print("\n=== Kurulum TamamlandÄ± ===")
    print(f"âœ… OpenLiteSpeed + PHP {DEFAULT_LSPHP_VERSION[0]}.{DEFAULT_LSPHP_VERSION[1]} + MariaDB kuruldu")
    print("âœ… Firewall ayarlarÄ± yapÄ±ldÄ±")
    print("âœ… SSL/HTTPS desteÄŸi eklendi")
    print("âœ… MariaDB gÃ¼venlik ayarlarÄ± yapÄ±ldÄ±")
    print("âœ… OpenLiteSpeed performans optimizasyonu yapÄ±ldÄ±")
    print("âœ… Yedek sistemi hazÄ±r")
    print("\nKullanÄ±m: sudo ispanel")


# ---------- OpenLiteSpeed domain yÃ¶netimi ----------

LSWS_CONF_DIR = Path("/usr/local/lsws/conf")
VHOSTS_DIR = LSWS_CONF_DIR / "vhosts"
HTTPD_CONF = LSWS_CONF_DIR / "httpd_config.conf"
DOCROOT_BASE = Path("/home")
DEFAULT_LSPHP_VERSION = "83"  # VarsayÄ±lan lsphp sÃ¼rÃ¼mÃ¼ (menu kurulum seÃ§imine gÃ¶re gÃ¼ncellenir)


def reload_lsws():
    try:
        run("systemctl reload lsws", check=True)
    except subprocess.CalledProcessError:
        run("/usr/local/lsws/bin/lswsctrl restart", check=True)


def ensure_http_listener_mapping(domain: str):
    if not HTTPD_CONF.exists():
        print(f"BulunamadÄ±: {HTTPD_CONF}", file=sys.stderr)
        sys.exit(1)
    content = HTTPD_CONF.read_text(encoding="utf-8")

    map_block = f"map                     {domain}:80 {domain}"
    listener_pattern = r"listener\s+Default\\s*\{[\s\S]*?\}"
    m = re.search(listener_pattern, content)
    if not m:
        # Eksikse, Default HTTP listener'Ä± oluÅŸtur
        default_listener = (
            "\nlistener Default {\n"
            "    address                 *:80\n"
            "    secure                  0\n"
            f"    {map_block}\n"
            "}\n"
        )
        content = content.rstrip() + "\n" + default_listener
        HTTPD_CONF.write_text(content, encoding="utf-8")
        return
    block = m.group(0)
    if map_block in block:
        return
    new_block = block.rstrip("}\n") + f"\n    {map_block}\n}}"
    new_content = content.replace(block, new_block)
    HTTPD_CONF.write_text(new_content, encoding="utf-8")


def ensure_https_listener_mapping(domain: str):
    """HTTPS listener mapping ekle"""
    if not HTTPD_CONF.exists():
        return
    content = HTTPD_CONF.read_text(encoding="utf-8")

    # HTTPS listener kontrolÃ¼
    https_listener_pattern = r"listener\s+SSL\\s*\{[\s\S]*?\}"
    if not re.search(https_listener_pattern, content):
        # HTTPS listener oluÅŸtur
        ssl_cert = f"/etc/letsencrypt/live/{domain}/fullchain.pem"
        ssl_key = f"/etc/letsencrypt/live/{domain}/privkey.pem"
        
        https_listener = f"""
listener SSL {{
    address                 *:443
    secure                  1
    keyFile                 {ssl_key}
    certFile                {ssl_cert}
    certChain               1
    sslProtocol             24
    ciphers                 EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
    enableECDHE             1
    renegProtection         1
    sslSessionCache         1
    sslSessionTickets       1
    enableSpdy              15
    enableQuic              1
    map                     {domain}:443 {domain}
}}
"""
        # Listener'Ä± ekle
        new_content = content + https_listener
        HTTPD_CONF.write_text(new_content, encoding="utf-8")
    else:
        # Mevcut HTTPS listener'a domain ekle
        map_block = f"map                     {domain}:443 {domain}"
        m = re.search(https_listener_pattern, content)
        if not m:
            return
        block = m.group(0)
        if map_block in block:
            return
        new_block = block.rstrip("}\n") + f"\n    {map_block}\n}}"
        new_content = content.replace(block, new_block)
        HTTPD_CONF.write_text(new_content, encoding="utf-8")


def write_vhost_conf(domain: str, docroot: Path):
    vdir = VHOSTS_DIR / domain
    vdir.mkdir(parents=True, exist_ok=True)
    vconf = vdir / "vhost.conf"

    vh_root = docroot.parent

    # Gerekli dizinleri oluÅŸtur
    log_dir = vh_root / "logs"
    log_dir.mkdir(parents=True, exist_ok=True)
    (log_dir / "access.log").touch(exist_ok=True)
    (log_dir / "error.log").touch(exist_ok=True)

    cgi_dir = vh_root / "cgi-bin"
    cgi_dir.mkdir(parents=True, exist_ok=True)

    protected_dir = docroot / "protected"
    protected_dir.mkdir(parents=True, exist_ok=True)

    awstats_dir = vh_root / "awstats"
    awstats_dir.mkdir(parents=True, exist_ok=True)
    
    conf = f"""docRoot $VH_ROOT/public_html/
enableGzip 1

context / {{
  allowBrowse 1
  location $DOC_ROOT/
  rewrite  {{
    RewriteFile .htaccess
  }}
}}

context /docs/{{
  allowBrowse 1
  location $SERVER_ROOT/docs/
}}

context /protected/{{
  required user test
  authName Protected
  allowBrowse 1
  location protected/
  realm SampleProtectedArea

  accessControl {{
    deny 
    allow *
  }}
}}

context /blocked/{{
  allowBrowse 0
}}

context /cgi-bin/{{
  allowBrowse 1
  location $VH_ROOT/cgi-bin/
  type cgi
}}

expires {{
  enableExpires 1
}}

index {{
  autoIndexURI /_autoindex/default.php
  indexFiles index.html, index.php
  autoIndex 0
  useServer 0
}}

errorPage 404{{
  url /error404.html
}}

errorlog $VH_ROOT/logs/error.log{{
  logLevel DEBUG
  rollingSize 10M
  useServer 1
}}

accessLog $VH_ROOT/logs/access.log{{
  compressArchive 0
  logReferer 1
  keepDays 30
  rollingSize 10M
  logUserAgent 1
  useServer 0
}}

awstats {{
  updateInterval 86400
  workingDir $VH_ROOT/awstats
  updateOffset 0
  siteDomain {domain}
  siteAliases 127.0.0.1 localhost
  updateMode 0
  awstatsURI /awstats/
}}

rewrite {{
  enable 0
  logLevel 0
}}

hotlinkCtrl {{
  suffixes gif, jpeg, jpg, png, css, js
  allowedHosts
  allowDirectAccess 1
  enableHotlinkCtrl 0
  onlySelf 1
}}

accessControl {{
  deny
  allow *
}}

realm SampleProtectedArea {{
  userDB {{
    cacheTimeout 60
    maxCacheSize 200
    location conf/vhosts/$VH_NAME/htpasswd
  }}

  groupDB {{
    cacheTimeout 60
    maxCacheSize 200
    location conf/vhosts/$VH_NAME/htgroup
  }}
}}

general {{
  enableContextAC 0
}}

scriptHandler {{
    add                    lsapi:lsphp{DEFAULT_LSPHP_VERSION} php
}}

phpIniOverride  {{
}}
""".strip()
    vconf.write_text(conf, encoding="utf-8")
    
    # Dizin izinlerini ayarla
    run(f"chown -R lsadm:nogroup {vdir}", check=True)
    run(f"chmod -R 755 {vdir}", check=True)
    run(f"chown -R lsadm:nogroup {vh_root}", check=False)
    run(f"chmod -R 755 {vh_root}", check=False)


def ensure_virtual_host_reference(domain: str):
    """httpd_config.conf iÃ§ine virtualHost referansÄ± ekle."""
    if not HTTPD_CONF.exists():
        print(f"BulunamadÄ±: {HTTPD_CONF}", file=sys.stderr)
        sys.exit(1)
    content = HTTPD_CONF.read_text(encoding="utf-8")
    
    # Virtual Host Root'u da ekle
    docroot = DOCROOT_BASE / domain
    vhost_ref = (
        f"virtualHost {domain} {{\n"
        f"    vhRoot                  {docroot}\n"
        f"    configFile              conf/vhosts/{domain}/vhost.conf\n"
        f"    allowSymbolLink         1\n"
        f"    enableScript            1\n"
        f"    restrained              1\n"
        f"}}\n"
    )
    # Zaten var mÄ± kontrol et (virtualHost domain satÄ±rÄ± baz alÄ±nÄ±r)
    if re.search(rf"virtualHost\s+{re.escape(domain)}\b", content):
        return
    content = content.rstrip() + "\n\n" + vhost_ref
    HTTPD_CONF.write_text(content, encoding="utf-8")


def ensure_docroot(domain: str) -> Path:
    docroot = DOCROOT_BASE / domain / "public_html"
    docroot.mkdir(parents=True, exist_ok=True)
    index_file = docroot / "index.php"
    if not index_file.exists():
        # GÃ¼zel tasarÄ±mlÄ± default index.php oluÅŸtur
        default_content = '''<?php
// isPanel tarafÄ±ndan yÃ¶netilmektedir
// https://ispanel.com
?>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $_SERVER['HTTP_HOST']; ?> - isPanel ile YÃ¶netiliyor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .container {
            text-align: center;
            max-width: 600px;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .logo {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 1rem;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .domain {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #f0f0f0;
        }
        
        .status {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            border-radius: 10px;
            padding: 1rem;
            margin: 1.5rem 0;
        }
        
        .status h3 {
            color: #4caf50;
            margin-bottom: 0.5rem;
        }
        
        .info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .info h4 {
            color: #2196f3;
            margin-bottom: 0.5rem;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .feature {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .feature h4 {
            color: #ffd700;
            margin-bottom: 0.5rem;
        }
        
        .footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .footer a {
            color: #4ecdc4;
            text-decoration: none;
            font-weight: bold;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .php-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">isPanel</div>
        <div class="domain"><?php echo $_SERVER['HTTP_HOST']; ?></div>
        
        <div class="status">
            <h3>âœ… Site Aktif</h3>
            <p>Bu domain isPanel tarafÄ±ndan yÃ¶netilmektedir</p>
        </div>
        
        <div class="info">
            <h4>ðŸš€ isPanel Ã–zellikleri</h4>
            <p>OpenLiteSpeed + PHP 8.3 + MariaDB ile gÃ¼Ã§lÃ¼ web hosting</p>
        </div>
        
        <div class="features">
            <div class="feature">
                <h4>âš¡ HÄ±zlÄ±</h4>
                <p>OpenLiteSpeed ile optimize edilmiÅŸ performans</p>
            </div>
            <div class="feature">
                <h4>ðŸ”’ GÃ¼venli</h4>
                <p>SSL sertifikasÄ± ve gÃ¼venlik ayarlarÄ±</p>
            </div>
            <div class="feature">
                <h4>ðŸ“¦ Kolay</h4>
                <p>Tek komutla domain ve veritabanÄ± yÃ¶netimi</p>
            </div>
        </div>
        
        <div class="php-info">
            <strong>PHP Bilgileri:</strong><br>
            PHP SÃ¼rÃ¼mÃ¼: <?php echo PHP_VERSION; ?><br>
            Sunucu: <?php echo $_SERVER['SERVER_SOFTWARE'] ?? 'OpenLiteSpeed'; ?><br>
            Tarih: <?php echo date('d.m.Y H:i:s'); ?>
        </div>
        
        <div class="footer">
            <p>Daha fazla bilgi iÃ§in: <a href="https://ispanel.com" target="_blank">ispanel.com</a></p>
            <p>GitHub: <a href="https://github.com/ismailaydemiriu/ispanel" target="_blank">GitHub Repository</a></p>
        </div>
    </div>
</body>
</html>'''
        index_file.write_text(default_content, encoding="utf-8")
    run(f"chown -R lsadm:nogroup {DOCROOT_BASE / domain}", check=False)
    return docroot


def domain_add(domain: str):
    if not re.match(r"^[A-Za-z0-9.-]+$", domain):
        print("GeÃ§ersiz domain.", file=sys.stderr)
        sys.exit(1)
    if not LSWS_CONF_DIR.exists():
        print("OpenLiteSpeed kurulu deÄŸil gibi gÃ¶rÃ¼nÃ¼yor.", file=sys.stderr)
        sys.exit(1)
    
    docroot = ensure_docroot(domain)
    write_vhost_conf(domain, docroot)
    ensure_virtual_host_reference(domain)
    ensure_http_listener_mapping(domain)
    
    # SSL sertifikasÄ± oluÅŸtur (Let's Encrypt)
    if shutil.which("certbot"):
        try:
            print(f"SSL sertifikasÄ± oluÅŸturuluyor: {domain}")
            run(f"certbot certonly --standalone -d {domain} --non-interactive --agree-tos --email admin@{domain}", check=False)
            
            # SSL konfigÃ¼rasyonunu OpenLiteSpeed'e ekle
            ssl_cert = f"/etc/letsencrypt/live/{domain}/fullchain.pem"
            ssl_key = f"/etc/letsencrypt/live/{domain}/privkey.pem"
            
            if Path(ssl_cert).exists() and Path(ssl_key).exists():
                # HTTPS listener ekle
                ensure_https_listener_mapping(domain)
                print(f"SSL sertifikasÄ± baÅŸarÄ±yla oluÅŸturuldu: {domain}")
        except:
            print(f"SSL sertifikasÄ± oluÅŸturulamadÄ±: {domain}")
    
    reload_lsws()
    print(f"Domain eklendi: {domain} -> {docroot}")
    print(f"HTTP: http://{domain}")
    print(f"HTTPS: https://{domain} (SSL varsa)")


def set_domain_php_version(domain: str, version: str):
    """Domain iÃ§in PHP sÃ¼rÃ¼mÃ¼nÃ¼ (lsphp81/82/83) ayarla"""
    vconf = VHOSTS_DIR / domain / "vhost.conf"
    if not vconf.exists():
        print("Vhost config bulunamadÄ±.", file=sys.stderr)
        return
    content = vconf.read_text(encoding="utf-8")
    content = re.sub(r"add\s+lsapi:lsphp\d+\s+php", f"add                   lsapi:lsphp{version} php", content)
    vconf.write_text(content, encoding="utf-8")
    reload_lsws()
    print(f"{domain} iÃ§in PHP lsphp{version} olarak ayarlandÄ±.")


def toggle_http3_brotli(enable: bool):
    """HTTP/3 (QUIC) ve Brotli sÄ±kÄ±ÅŸtÄ±rmayÄ± aÃ§/kapat"""
    if not HTTPD_CONF.exists():
        print("httpd_config.conf bulunamadÄ±.", file=sys.stderr)
        return
    content = HTTPD_CONF.read_text(encoding="utf-8")
    # HTTP/3 QUIC ayarÄ± listener SSL iÃ§inde enableQuic 1/0
    content = re.sub(r"enableQuic\s+\d", f"enableQuic              {'1' if enable else '0'}", content)
    HTTPD_CONF.write_text(content, encoding="utf-8")

    # Brotli: global conf'a ek basit bayrak (OLS'te mod_brotli yoksa gzip kullanÄ±labilir; burada Ã¶rnek bayrak koyuyoruz)
    brotli_marker = "# ispanel_brotli_enabled"
    if enable:
        if brotli_marker not in content:
            with open(HTTPD_CONF, "a", encoding="utf-8") as f:
                f.write(f"\n{brotli_marker}\n# Brotli etkin: statik iÃ§erik iÃ§in harici reverse proxy veya mod eklentisi gerekebilir.\n")
    else:
        newc = Path(HTTPD_CONF).read_text(encoding="utf-8").replace(brotli_marker + "\n", "")
        Path(HTTPD_CONF).write_text(newc, encoding="utf-8")
    reload_lsws()
    print(f"HTTP/3 {'aÃ§Ä±ldÄ±' if enable else 'kapandÄ±'}; Brotli {'iÅŸaretlendi' if enable else 'devre dÄ±ÅŸÄ±'}.")


def ols_php_menu():
    while True:
        print("\n--- OLS/PHP AyarlarÄ± ---")
        print("1) Domain iÃ§in PHP sÃ¼rÃ¼mÃ¼ ayarla (lsphp81/82/83)")
        print("2) HTTP/3 + Brotli aÃ§")
        print("3) HTTP/3 + Brotli kapat")
        print("0) Geri")
        sub = input("SeÃ§im: ").strip()
        if sub == '1':
            domain = input("Domain: ").strip()
            version = input("SÃ¼rÃ¼m (81/82/83): ").strip()
            if version not in {"81","82","83"}:
                print("GeÃ§ersiz sÃ¼rÃ¼m")
            else:
                set_domain_php_version(domain, version)
        elif sub == '2':
            toggle_http3_brotli(True)
        elif sub == '3':
            toggle_http3_brotli(False)
        elif sub == '0':
            break
        else:
            print("GeÃ§ersiz seÃ§im")


def domain_remove(domain: str):
    vdir = VHOSTS_DIR / domain
    if vdir.exists():
        shutil.rmtree(vdir)

    if HTTPD_CONF.exists():
        content = HTTPD_CONF.read_text(encoding="utf-8")
        # HTTP listener'dan domain mapping'i sil
        content = re.sub(rf"\n\s*map\s+{re.escape(domain)}:80\s+{re.escape(domain)}\s*", "\n", content)
        # HTTPS listener'dan domain mapping'i sil
        content = re.sub(rf"\n\s*map\s+{re.escape(domain)}:443\s+{re.escape(domain)}\s*", "\n", content)
        # virtualHost referansÄ±nÄ± sil
        lines = content.split('\n')
        new_lines = []
        skip_until_brace = False
        for line in lines:
            if f"virtualHost {domain}" in line:
                skip_until_brace = True
                continue
            if skip_until_brace and line.strip() == '}':
                skip_until_brace = False
                continue
            if not skip_until_brace:
                new_lines.append(line)
        content = '\n'.join(new_lines)
        HTTPD_CONF.write_text(content, encoding="utf-8")
    reload_lsws()
    print(f"Domain silindi: {domain}")


# ---------- MariaDB yÃ¶netimi ----------

def mysql_exec(sql: str):
    run(f"mysql -uroot -e \"{sql}\"", check=True)


def db_create(db: str, user: str, password: str):
    if not re.match(r"^[A-Za-z0-9_]+$", db):
        print("GeÃ§ersiz veritabanÄ± adÄ±.", file=sys.stderr)
        sys.exit(1)
    if not re.match(r"^[A-Za-z0-9_]+$", user):
        print("GeÃ§ersiz kullanÄ±cÄ± adÄ±.", file=sys.stderr)
        sys.exit(1)
    sql = (
        f"CREATE DATABASE IF NOT EXISTS `{db}` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; "
        f"CREATE USER IF NOT EXISTS '{user}'@'%' IDENTIFIED BY '{password}'; "
        f"GRANT ALL PRIVILEGES ON `{db}`.* TO '{user}'@'%'; FLUSH PRIVILEGES;"
    )
    mysql_exec(sql)
    print(f"DB oluÅŸturuldu: {db}, kullanÄ±cÄ±: {user}")


def db_delete(db: str, user: str):
    sql = (
        f"DROP DATABASE IF EXISTS `{db}`; "
        f"DROP USER IF EXISTS '{user}'@'%'; FLUSH PRIVILEGES;"
    )
    mysql_exec(sql)
    print(f"DB silindi: {db}, kullanÄ±cÄ±: {user}")


def db_user_create(user: str, password: str, host: str = "%"):
    if not re.match(r"^[A-Za-z0-9_]+$", user):
        print("GeÃ§ersiz kullanÄ±cÄ± adÄ±.", file=sys.stderr)
        sys.exit(1)
    sql = (
        f"CREATE USER IF NOT EXISTS '{user}'@'{host}' IDENTIFIED BY '{password}'; "
        f"FLUSH PRIVILEGES;"
    )
    mysql_exec(sql)
    print(f"KullanÄ±cÄ± oluÅŸturuldu: {user}@{host}")


def reset_mysql_root_password():
    print("MySQL root ÅŸifresi sÄ±fÄ±rlanÄ±yor...")
    new_password = input("Yeni root ÅŸifresi: ").strip()
    if not new_password:
        print("Åžifre boÅŸ olamaz!")
        return
    
    # MySQL servisini durdur
    run("systemctl stop mariadb", check=False)
    
    # GÃ¼venli modda MySQL baÅŸlat
    run("mysqld_safe --skip-grant-tables --skip-networking &", check=False)
    time.sleep(3)
    
    # Root ÅŸifresini sÄ±fÄ±rla
    sql = f"ALTER USER 'root'@'localhost' IDENTIFIED BY '{new_password}';"
    run(f"mysql -u root -e \"{sql}\"", check=True)
    
    # MySQL'i normal modda yeniden baÅŸlat
    run("pkill mysqld", check=False)
    time.sleep(2)
    run("systemctl start mariadb", check=True)
    
    print("MySQL root ÅŸifresi baÅŸarÄ±yla sÄ±fÄ±rlandÄ±!")


def reset_openlitespeed_admin_password():
    print("OpenLiteSpeed admin ÅŸifresi sÄ±fÄ±rlanÄ±yor...")
    new_password = input("Yeni admin ÅŸifresi: ").strip()
    if not new_password:
        print("Åžifre boÅŸ olamaz!")
        return
    
    if len(new_password) < 6:
        print("Åžifre en az 6 karakter olmalÄ±!")
        return
    
    # OpenLiteSpeed admin ÅŸifresini sÄ±fÄ±rla
    admin_script = "/usr/local/lsws/admin/misc/admpass.sh"
    if not Path(admin_script).exists():
        print("OpenLiteSpeed admin scripti bulunamadÄ±!", file=sys.stderr)
        return
    
    try:
        # Non-interactive ÅŸifre ayarlama
        print("Admin ÅŸifresi ayarlanÄ±yor...")
        
        # Åžifreyi dosyaya yaz ve script'e yÃ¶nlendir
        import tempfile
        with tempfile.NamedTemporaryFile(mode='w', delete=False) as f:
            f.write(f"{new_password}\n{new_password}\n")
            temp_file = f.name
        
        # Script'i non-interactive Ã§alÄ±ÅŸtÄ±r
        run(f"cat {temp_file} | {admin_script}", check=True)
        
        # GeÃ§ici dosyayÄ± sil
        Path(temp_file).unlink()
        
        print("âœ… OpenLiteSpeed admin ÅŸifresi baÅŸarÄ±yla sÄ±fÄ±rlandÄ±!")
        print(f"Admin panel: https://SERVER_IP:7080")
        print(f"KullanÄ±cÄ±: admin")
        print(f"Åžifre: {new_password}")
        
    except subprocess.CalledProcessError as e:
        print(f"Åžifre sÄ±fÄ±rlama hatasÄ±: {e}")
        print("Manuel olarak ÅŸu komutu Ã§alÄ±ÅŸtÄ±rabilirsiniz:")
        print(f"sudo {admin_script}")
    except Exception as e:
        print(f"Beklenmeyen hata: {e}")


def check_port(port):
    """Port kullanÄ±mÄ±nÄ± kontrol et"""
    try:
        result = run(f"netstat -tuln | grep ':{port} '", check=False)
        return bool(result.stdout.strip())
    except:
        return False


def manage_firewall():
    """Firewall yÃ¶netimi"""
    print("Firewall yÃ¶netimi...")
    
    # UFW kontrolÃ¼
    if shutil.which("ufw"):
        print("UFW firewall yÃ¶netiliyor...")
        ports = [20, 21, 22, 80, 443, 7080, 8088]
        for port in ports:
            run(f"ufw allow {port}/tcp", check=False)
        run("ufw --force enable", check=False)
    else:
        print("UFW bulunamadÄ±, iptables kullanÄ±lÄ±yor...")
        # iptables kurallarÄ±
        run("iptables -I INPUT -p tcp --dport 20 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 21 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 22 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 80 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 443 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 7080 -j ACCEPT", check=False)
        run("iptables -I INPUT -p tcp --dport 8088 -j ACCEPT", check=False)


def install_ssl_support():
    """SSL/HTTPS desteÄŸi kurulumu"""
    print("SSL/HTTPS desteÄŸi kuruluyor...")
    wait_for_apt()
    
    # Certbot kurulumu
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y certbot", check=True)
    
    # OpenLiteSpeed iÃ§in SSL konfigÃ¼rasyonu
    ssl_dir = Path("/usr/local/lsws/conf/cert")
    ssl_dir.mkdir(exist_ok=True)
    
    print("SSL desteÄŸi kuruldu. Let's Encrypt sertifikalarÄ± domain ekleme sÄ±rasÄ±nda otomatik oluÅŸturulacak.")


def secure_mariadb():
    """MariaDB gÃ¼venlik ayarlarÄ±"""
    print("MariaDB gÃ¼venlik ayarlarÄ± yapÄ±lÄ±yor...")
    
    # mysql_secure_installation benzeri iÅŸlemler
    sql_commands = [
        "DELETE FROM mysql.user WHERE User='';",
        "DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1');",
        "DROP DATABASE IF EXISTS test;",
        "DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';",
        "FLUSH PRIVILEGES;"
    ]
    
    for sql in sql_commands:
        try:
            mysql_exec(sql)
        except:
            pass  # BazÄ± komutlar zaten uygulanmÄ±ÅŸ olabilir
    
    print("MariaDB gÃ¼venlik ayarlarÄ± tamamlandÄ±.")


def optimize_openlitespeed():
    """OpenLiteSpeed performans optimizasyonu"""
    print("OpenLiteSpeed performans optimizasyonu yapÄ±lÄ±yor...")
    
    # KonfigÃ¼rasyon dosyasÄ± optimizasyonlarÄ±
    config_file = Path("/usr/local/lsws/conf/httpd_config.conf")
    if config_file.exists():
        content = config_file.read_text(encoding="utf-8")
        
        # Performans ayarlarÄ±
        optimizations = [
            ("maxConnections", "1000"),
            ("maxSSLConnections", "1000"),
            ("connTimeout", "300"),
            ("keepAliveTimeout", "15"),
            ("maxKeepAliveReq", "1000")
        ]
        
        for setting, value in optimizations:
            if f"{setting} {value}" not in content:
                # KonfigÃ¼rasyona optimizasyon ekle
                pass
    
    print("OpenLiteSpeed performans optimizasyonu tamamlandÄ±.")


def repair_mariadb():
    """MariaDB onarÄ±m iÅŸlemleri"""
    print("MariaDB onarÄ±m iÅŸlemleri yapÄ±lÄ±yor...")
    
    # MySQL servisini durdur
    run("systemctl stop mariadb", check=False)
    
    # Repair iÅŸlemleri
    try:
        # MySQL'i gÃ¼venli modda baÅŸlat
        run("mysqld_safe --skip-grant-tables --skip-networking &", check=False)
        time.sleep(3)
        
        # Repair komutlarÄ±
        repair_commands = [
            "REPAIR TABLE mysql.user;",
            "REPAIR TABLE mysql.db;",
            "REPAIR TABLE mysql.tables_priv;",
            "REPAIR TABLE mysql.columns_priv;",
            "FLUSH PRIVILEGES;"
        ]
        
        for cmd in repair_commands:
            try:
                run(f"mysql -u root -e \"{cmd}\"", check=True)
            except:
                pass
        
        # MySQL'i normal modda yeniden baÅŸlat
        run("pkill mysqld", check=False)
        time.sleep(2)
        run("systemctl start mariadb", check=True)
        
        print("MariaDB onarÄ±m iÅŸlemleri tamamlandÄ±.")
    except Exception as e:
        print(f"MariaDB onarÄ±m hatasÄ±: {e}")
        run("systemctl start mariadb", check=False)


def repair_openlitespeed():
    """OpenLiteSpeed onarÄ±m iÅŸlemleri"""
    print("OpenLiteSpeed onarÄ±m iÅŸlemleri yapÄ±lÄ±yor...")
    
    try:
        # KonfigÃ¼rasyon dosyalarÄ±nÄ± kontrol et
        config_files = [
            "/usr/local/lsws/conf/httpd_config.conf",
            "/usr/local/lsws/conf/vhosts"
        ]
        
        for config_file in config_files:
            if Path(config_file).exists():
                # Dosya izinlerini dÃ¼zelt
                run(f"chown -R lsadm:lsadm {config_file}", check=False)
                run(f"chmod -R 755 {config_file}", check=False)
        
        # OpenLiteSpeed'i yeniden baÅŸlat
        run("systemctl restart lsws", check=False)
        
        # Alternatif restart
        try:
            run("/usr/local/lsws/bin/lswsctrl restart", check=True)
        except:
            pass
            
        print("OpenLiteSpeed onarÄ±m iÅŸlemleri tamamlandÄ±.")
    except Exception as e:
        print(f"OpenLiteSpeed onarÄ±m hatasÄ±: {e}")


def install_redis():
    """Redis kurulumu"""
    print("Redis kuruluyor...")
    wait_for_apt()
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y redis-server", check=True)
    run("systemctl enable redis-server", check=False)
    run("systemctl start redis-server", check=True)
    print("Redis kuruldu ve baÅŸlatÄ±ldÄ±.")


def install_memcached():
    """Memcached kurulumu"""
    print("Memcached kuruluyor...")
    wait_for_apt()
    run("DEBIAN_FRONTEND=noninteractive apt-get install -y memcached", check=True)
    run("systemctl enable memcached", check=False)
    run("systemctl start memcached", check=True)
    print("Memcached kuruldu ve baÅŸlatÄ±ldÄ±.")


def configure_php_opcache():
    """PHP OPcache konfigÃ¼rasyonu"""
    print("PHP OPcache konfigÃ¼rasyonu yapÄ±lÄ±yor...")
    
    # OPcache ayarlarÄ±
    opcache_config = """
[opcache]
opcache.enable=1
opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=4000
opcache.revalidate_freq=2
opcache.fast_shutdown=1
opcache.enable_cli=1
"""
    
    # PHP ini dosyasÄ±na ekle
    candidates = [
        "/usr/local/lsws/lsphp81/etc/php/8.1/litespeed/php.ini",
        "/usr/local/lsws/lsphp82/etc/php/8.2/litespeed/php.ini",
        "/usr/local/lsws/lsphp83/etc/php/8.3/litespeed/php.ini",
    ]
    wrote = False
    for php_ini_path in candidates:
        if Path(php_ini_path).exists():
            with open(php_ini_path, "a", encoding="utf-8") as f:
                f.write(opcache_config)
            wrote = True
    if wrote:
        print("OPcache konfigÃ¼rasyonu eklendi (mevcut sÃ¼rÃ¼mler).")
    else:
        print("PHP ini dosyasÄ± bulunamadÄ±, OPcache manuel olarak yapÄ±landÄ±rÄ±lmalÄ±.")


def backup_domain(domain):
    """Domain yedeÄŸi alma"""
    backup_dir = Path("/home/backup/domains")
    backup_dir.mkdir(parents=True, exist_ok=True)
    
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    backup_file = backup_dir / f"{domain}_{timestamp}.tar.gz"
    
    docroot = DOCROOT_BASE / domain
    if docroot.exists():
        run(f"tar -czf {backup_file} -C {docroot.parent} {domain}", check=True)
        print(f"Domain yedeÄŸi alÄ±ndÄ±: {backup_file}")
        return str(backup_file)
    else:
        print(f"Domain docroot bulunamadÄ±: {docroot}")
        return None


def backup_database(db_name):
    """VeritabanÄ± yedeÄŸi alma"""
    backup_dir = Path("/home/backup/databases")
    backup_dir.mkdir(parents=True, exist_ok=True)
    
    timestamp = time.strftime("%Y%m%d_%H%M%S")
    backup_file = backup_dir / f"{db_name}_{timestamp}.sql"
    
    run(f"mysqldump -uroot {db_name} > {backup_file}", check=True)
    print(f"VeritabanÄ± yedeÄŸi alÄ±ndÄ±: {backup_file}")
    return str(backup_file)


def restore_domain(backup_file):
    """Domain yedeÄŸi geri yÃ¼kleme"""
    if not Path(backup_file).exists():
        print(f"Yedek dosyasÄ± bulunamadÄ±: {backup_file}")
        return False
    
    run(f"tar -xzf {backup_file} -C {DOCROOT_BASE.parent}", check=True)
    print(f"Domain yedeÄŸi geri yÃ¼klendi: {backup_file}")
    return True


def restore_database(backup_file, db_name):
    """VeritabanÄ± yedeÄŸi geri yÃ¼kleme"""
    if not Path(backup_file).exists():
        print(f"Yedek dosyasÄ± bulunamadÄ±: {backup_file}")
        return False
    
    # VeritabanÄ±nÄ± oluÅŸtur
    mysql_exec(f"CREATE DATABASE IF NOT EXISTS {db_name}")
    
    # YedeÄŸi geri yÃ¼kle
    run(f"mysql -uroot {db_name} < {backup_file}", check=True)
    print(f"VeritabanÄ± yedeÄŸi geri yÃ¼klendi: {backup_file}")
    return True


def fix_virtual_host_root(domain: str):
    """Mevcut domain'in Virtual Host Root'unu dÃ¼zelt"""
    if not HTTPD_CONF.exists():
        print(f"BulunamadÄ±: {HTTPD_CONF}", file=sys.stderr)
        return False
    
    content = HTTPD_CONF.read_text(encoding="utf-8")
    docroot = DOCROOT_BASE / domain
    
    # Mevcut virtualHost bloÄŸunu bul ve gÃ¼ncelle
    pattern = rf"virtualHost\s+{re.escape(domain)}\s*\{{[^}}]*\}}"
    match = re.search(pattern, content, re.DOTALL)
    
    if match:
        old_block = match.group(0)
        new_block = f"""virtualHost {domain} {{
    vhRoot                  {docroot}
    configFile              conf/vhosts/{domain}/vhost.conf
    allowSymbolLink         1
    enableScript            1
    restrained              1
}}"""
        content = content.replace(old_block, new_block)
        HTTPD_CONF.write_text(content, encoding="utf-8")
        print(f"âœ… {domain} Virtual Host Root dÃ¼zeltildi: {docroot}")
        return True
    else:
        print(f"âŒ {domain} virtualHost bloÄŸu bulunamadÄ±")
        return False


def fix_vhost_config(domain: str):
    """Mevcut domain'in vhost konfigÃ¼rasyonunu standart yapÄ±ya gÃ¼ncelle"""
    vdir = VHOSTS_DIR / domain
    if not vdir.exists():
        print(f"âŒ {domain} vhost dizini bulunamadÄ±")
        return False
    
    vconf = vdir / "vhost.conf"
    if not vconf.exists():
        print(f"âŒ {domain} vhost.conf bulunamadÄ±")
        return False
    
    # Yeni standart konfigÃ¼rasyonu oluÅŸtur
    docroot = DOCROOT_BASE / domain / "public_html"
    vh_root = docroot.parent

    # Gerekli dizinleri oluÅŸtur
    log_dir = vh_root / "logs"
    log_dir.mkdir(parents=True, exist_ok=True)
    (log_dir / "access.log").touch(exist_ok=True)
    (log_dir / "error.log").touch(exist_ok=True)

    cgi_dir = vh_root / "cgi-bin"
    cgi_dir.mkdir(parents=True, exist_ok=True)

    protected_dir = docroot / "protected"
    protected_dir.mkdir(parents=True, exist_ok=True)

    awstats_dir = vh_root / "awstats"
    awstats_dir.mkdir(parents=True, exist_ok=True)
    
    conf = f"""docRoot $VH_ROOT/public_html/
enableGzip 1

context / {{
  allowBrowse 1
  location $DOC_ROOT/
  rewrite  {{
    RewriteFile .htaccess
  }}
}}

context /docs/{{
  allowBrowse 1
  location $SERVER_ROOT/docs/
}}

context /protected/{{
  required user test
  authName Protected
  allowBrowse 1
  location protected/
  realm SampleProtectedArea

  accessControl {{
    deny 
    allow *
  }}
}}

context /blocked/{{
  allowBrowse 0
}}

context /cgi-bin/{{
  allowBrowse 1
  location $VH_ROOT/cgi-bin/
  type cgi
}}

expires {{
  enableExpires 1
}}

index {{
  autoIndexURI /_autoindex/default.php
  indexFiles index.html, index.php
  autoIndex 0
  useServer 0
}}

errorPage 404{{
  url /error404.html
}}

errorlog $VH_ROOT/logs/error.log{{
  logLevel DEBUG
  rollingSize 10M
  useServer 1
}}

accessLog $VH_ROOT/logs/access.log{{
  compressArchive 0
  logReferer 1
  keepDays 30
  rollingSize 10M
  logUserAgent 1
  useServer 0
}}

awstats {{
  updateInterval 86400
  workingDir $VH_ROOT/awstats
  updateOffset 0
  siteDomain {domain}
  siteAliases 127.0.0.1 localhost
  updateMode 0
  awstatsURI /awstats/
}}

rewrite {{
  enable 0
  logLevel 0
}}

hotlinkCtrl {{
  suffixes gif, jpeg, jpg, png, css, js
  allowedHosts
  allowDirectAccess 1
  enableHotlinkCtrl 0
  onlySelf 1
}}

accessControl {{
  deny
  allow *
}}

realm SampleProtectedArea {{
  userDB {{
    cacheTimeout 60
    maxCacheSize 200
    location conf/vhosts/$VH_NAME/htpasswd
  }}

  groupDB {{
    cacheTimeout 60
    maxCacheSize 200
    location conf/vhosts/$VH_NAME/htgroup
  }}
}}

general {{
  enableContextAC 0
}}

scriptHandler {{
    add                    lsapi:lsphp{DEFAULT_LSPHP_VERSION} php
}}

phpIniOverride  {{
}}
""".strip()
    
    vconf.write_text(conf, encoding="utf-8")
    
    # Dizin izinlerini ayarla
    run(f"chown -R lsadm:nogroup {vdir}", check=True)
    run(f"chmod -R 755 {vdir}", check=True)
    run(f"chown -R lsadm:nogroup {vh_root}", check=False)
    run(f"chmod -R 755 {vh_root}", check=False)
    
    print(f"âœ… {domain} vhost konfigÃ¼rasyonu standart yapÄ±ya gÃ¼ncellendi")
    return True


def list_domains():
    """Aktif domainleri listele"""
    print("\n=== Aktif Domainler ===")
    
    if not VHOSTS_DIR.exists():
        print("Vhost dizini bulunamadÄ±.")
        return
    
    domains = []
    for domain_dir in VHOSTS_DIR.iterdir():
        if domain_dir.is_dir() and domain_dir.name != "Example":
            domain = domain_dir.name
            docroot = DOCROOT_BASE / domain / "public_html"
            vhost_conf = domain_dir / "vhost.conf"
            
            # Domain bilgilerini topla
            info = {
                "domain": domain,
                "docroot": str(docroot),
                "exists": docroot.exists(),
                "vhost_exists": vhost_conf.exists()
            }
            domains.append(info)
    
    if not domains:
        print("HiÃ§ domain bulunamadÄ±.")
        return
    
    print(f"{'Domain':<20} {'Docroot':<30} {'Durum':<10}")
    print("-" * 60)
    
    for info in domains:
        status = "âœ… Aktif" if info["exists"] and info["vhost_exists"] else "âŒ Hata"
        print(f"{info['domain']:<20} {info['docroot']:<30} {status:<10}")
        
        # Virtual Host Root kontrolÃ¼
        if info["vhost_exists"]:
            print(f"  ðŸ”§ Virtual Host Root dÃ¼zeltmek iÃ§in: python3 ispanel fix-vhost {info['domain']}")


def list_databases():
    """VeritabanlarÄ±nÄ± listele"""
    print("\n=== VeritabanlarÄ± ===")
    
    try:
        # VeritabanlarÄ±nÄ± listele
        result = run("mysql -uroot -e 'SHOW DATABASES;'", check=False)
        if result.returncode != 0:
            print("MariaDB baÄŸlantÄ± hatasÄ±. Servis Ã§alÄ±ÅŸÄ±yor mu kontrol edin.")
            return
        
        databases = []
        for line in result.stdout.strip().split('\n'):
            line = line.strip()
            if line and line not in ['Database', 'information_schema', 'performance_schema', 'mysql', 'sys']:
                databases.append(line)
        
        if not databases:
            print("HiÃ§ veritabanÄ± bulunamadÄ±.")
            return
        
        print(f"{'VeritabanÄ±':<20} {'Boyut':<15} {'Tarih':<20}")
        print("-" * 55)
        
        for db in databases:
            # VeritabanÄ± boyutunu al
            size_result = run(f"mysql -uroot -e 'SELECT ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS \"DB Size in MB\" FROM information_schema.tables WHERE table_schema=\"{db}\";'", check=False)
            size = size_result.stdout.strip().split('\n')[-1] if size_result.returncode == 0 else "N/A"
            
            # Son deÄŸiÅŸiklik tarihi
            date_result = run(f"mysql -uroot -e 'SELECT MAX(update_time) FROM information_schema.tables WHERE table_schema=\"{db}\";'", check=False)
            date = date_result.stdout.strip().split('\n')[-1] if date_result.returncode == 0 else "N/A"
            
            print(f"{db:<20} {size:<15} {date:<20}")
            
    except Exception as e:
        print(f"VeritabanÄ± listesi alÄ±namadÄ±: {e}")


def list_backups():
    """Yedekleri listele"""
    domain_backups = list(Path("/home/backup/domains").glob("*.tar.gz"))
    db_backups = list(Path("/home/backup/databases").glob("*.sql"))
    
    print("\n=== Domain Yedekleri ===")
    for backup in domain_backups:
        print(f"- {backup.name}")
    
    print("\n=== VeritabanÄ± Yedekleri ===")
    for backup in db_backups:
        print(f"- {backup.name}")


def install_cron():
    ensure_cmd("crontab", "cron")


def cron_add(line: str):
    install_cron()
    # mevcut crontab al
    cp = subprocess.run("crontab -l", shell=True, text=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    current = cp.stdout if cp.returncode == 0 else ""
    if line in current:
        print("Cron zaten mevcut")
        return
    new = current + ("\n" if current and not current.endswith("\n") else "") + line + "\n"
    p = subprocess.run("crontab -", shell=True, input=new, text=True)
    if p.returncode == 0:
        print("Cron eklendi")
    else:
        print("Cron eklenemedi", file=sys.stderr)


def cron_backup_menu():
    while True:
        print("\n--- Cron Backup AyarlarÄ± ---")
        print("1) GÃ¼nlÃ¼k DB yedeÄŸi kur (02:30)")
        print("2) GÃ¼nlÃ¼k Dosya yedeÄŸi kur (03:00)")
        print("3) Cron listele")
        print("0) Geri")
        sub = input("SeÃ§im: ").strip()
        if sub == "1":
            db = input("Yedeklenecek DB adÄ±: ").strip()
            backup_dir = "/home/backup/databases"
            line = f"30 2 * * * mysqldump -uroot {db} > {backup_dir}/{db}_$(date +\\%Y\\%m\\%d).sql"
            cron_add(line)
        elif sub == "2":
            domain = input("Yedeklenecek domain: ").strip()
            backup_dir = "/home/backup/domains"
            line = f"0 3 * * * tar -czf {backup_dir}/{domain}_$(date +\\%Y\\%m\\%d).tar.gz -C {DOCROOT_BASE} {domain}"
            cron_add(line)
        elif sub == "3":
            subprocess.run("crontab -l | cat", shell=True)
        elif sub == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")


def interactive_menu():
    while True:
        print("\n=== ispanel (Ubuntu 22+) ===")
        print("1) Kurulum (OpenLiteSpeed + PHP 8.2 + MariaDB)")
        print("2) Kurulum (OpenLiteSpeed + PHP 8.3 + MariaDB)")
        print("3) Domain ekle")
        print("4) Domain Listesi")
        print("5) Domain sil")
        print("6) DB Listesi")
        print("7) Virtual Host Root dÃ¼zelt")
        print("8) Vhost KonfigÃ¼rasyon dÃ¼zelt")
        print("9) DB oluÅŸtur")
        print("10) DB sil")
        print("11) MySQL root ÅŸifre sÄ±fÄ±rla")
        print("12) OpenLiteSpeed admin ÅŸifre sÄ±fÄ±rla")
        print("13) Port kontrolÃ¼ ve Firewall yÃ¶netimi")
        print("14) SSL/HTTPS desteÄŸi kur")
        print("15) MariaDB gÃ¼venlik ayarlarÄ±")
        print("16) OpenLiteSpeed performans optimizasyonu")
        print("17) Dosya yedekleme menÃ¼sÃ¼")
        print("18) VeritabanÄ± yedekleme menÃ¼sÃ¼")
        print("19) Yedekleri listele")
        print("20) Cron backup ayarlarÄ±")
        print("21) OnarÄ±m araÃ§larÄ±")
        print("22) Cache sistemleri (Redis/Memcached)")
        print("23) Sistem yÃ¶netimi")
        print("24) OLS/PHP ayarlarÄ±")
        print("25) isPanel gÃ¼ncelle")
        print("0) Ã‡Ä±kÄ±ÅŸ")
        choice = input("SeÃ§im: ").strip()
        if choice == "1":
            DEFAULT_LSPHP_VERSION = "82"
            cmd_install(argparse.Namespace())
        elif choice == "2":
            DEFAULT_LSPHP_VERSION = "83"
            cmd_install(argparse.Namespace())
        elif choice == "3":
            domain = input("Domain: ").strip()
            domain_add(domain)
        elif choice == "4":
            list_domains()
        elif choice == "5":
            domain = input("Domain: ").strip()
            domain_remove(domain)
        elif choice == "6":
            list_databases()
        elif choice == "7":
            domain = input("Domain: ").strip()
            fix_virtual_host_root(domain)
        elif choice == "8":
            domain = input("Domain: ").strip()
            fix_vhost_config(domain)
        elif choice == "9":
            db = input("DB adÄ±: ").strip()
            user = input("KullanÄ±cÄ±: ").strip()
            password = input("Parola: ").strip()
            db_create(db, user, password)
        elif choice == "10":
            db = input("DB adÄ±: ").strip()
            user = input("KullanÄ±cÄ±: ").strip()
            db_delete(db, user)
        elif choice == "11":
            reset_mysql_root_password()
        elif choice == "12":
            reset_openlitespeed_admin_password()
        elif choice == "13":
            manage_firewall()
        elif choice == "14":
            install_ssl_support()
        elif choice == "15":
            secure_mariadb()
        elif choice == "16":
            while True:
                print("\n--- Dosya Yedekleme ---")
                print("1) Domain yedeÄŸi al")
                print("2) Domain yedeÄŸi geri yÃ¼kle")
                print("3) Docroot taban klasÃ¶rÃ¼nÃ¼ gÃ¶ster")
                print("0) Geri")
                sub = input("SeÃ§im: ").strip()
                if sub == "1":
                    domain = input("Domain: ").strip()
                    backup_domain(domain)
                elif sub == "2":
                    backup_file = input("Yedek dosyasÄ± yolu: ").strip()
                    restore_domain(backup_file)
                elif sub == "3":
                    print(f"Docroot base: {DOCROOT_BASE}")
                elif sub == "0":
                    break
                else:
                    print("GeÃ§ersiz seÃ§im")
        elif choice == "17":
            while True:
                print("\n--- VeritabanÄ± Yedekleme ---")
                print("1) DB yedeÄŸi al")
                print("2) DB yedeÄŸi geri yÃ¼kle")
                print("3) DB kullanÄ±cÄ±sÄ± oluÅŸtur")
                print("0) Geri")
                sub = input("SeÃ§im: ").strip()
                if sub == "1":
                    db = input("DB adÄ±: ").strip()
                    backup_database(db)
                elif sub == "2":
                    backup_file = input("Yedek dosyasÄ± yolu: ").strip()
                    db_name = input("Hedef DB adÄ±: ").strip()
                    restore_database(backup_file, db_name)
                elif sub == "3":
                    user = input("KullanÄ±cÄ± adÄ±: ").strip()
                    password = input("Parola: ").strip()
                    host = input("Host (varsayÄ±lan %): ").strip() or "%"
                    db_user_create(user, password, host)
                elif sub == "0":
                    break
                else:
                    print("GeÃ§ersiz seÃ§im")
        elif choice == "18":
            list_backups()
        elif choice == "19":
            cron_backup_menu()
        elif choice == "20":
            repair_menu()
        elif choice == "21":
            cache_menu()
        elif choice == "22":
            system_management_menu()
        elif choice == "23":
            ols_php_menu()
        elif choice == "24":
            update_ispanel()
        elif choice == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")


def repair_menu():
    """OnarÄ±m araÃ§larÄ± menÃ¼sÃ¼"""
    while True:
        print("\n--- OnarÄ±m AraÃ§larÄ± ---")
        print("1) MariaDB onar")
        print("2) OpenLiteSpeed onar")
        print("3) PHP OPcache konfigÃ¼rasyonu")
        print("0) Geri")
        sub = input("SeÃ§im: ").strip()
        if sub == "1":
            repair_mariadb()
        elif sub == "2":
            repair_openlitespeed()
        elif sub == "3":
            configure_php_opcache()
        elif sub == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")


def cache_menu():
    """Cache sistemleri menÃ¼sÃ¼"""
    while True:
        print("\n--- Cache Sistemleri ---")
        print("1) Redis kur")
        print("2) Memcached kur")
        print("3) Redis durumu")
        print("4) Memcached durumu")
        print("0) Geri")
        sub = input("SeÃ§im: ").strip()
        if sub == "1":
            install_redis()
        elif sub == "2":
            install_memcached()
        elif sub == "3":
            run("systemctl status redis-server", check=False)
        elif sub == "4":
            run("systemctl status memcached", check=False)
        elif sub == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")


def auto_update_system():
    """Otomatik sistem gÃ¼ncellemeleri"""
    print("Sistem paketleri gÃ¼ncelleniyor...")
    wait_for_apt()
    
    # GÃ¼ncelleme iÅŸlemleri
    run("DEBIAN_FRONTEND=noninteractive apt-get update -y", check=True)
    run("DEBIAN_FRONTEND=noninteractive apt-get upgrade -y", check=True)
    run("DEBIAN_FRONTEND=noninteractive apt-get autoremove -y", check=True)
    run("DEBIAN_FRONTEND=noninteractive apt-get autoclean", check=True)
    
    print("Sistem gÃ¼ncellemeleri tamamlandÄ±.")


def setup_backup_rotation():
    """Yedek rotasyonu kurulumu"""
    print("Yedek rotasyonu ayarlanÄ±yor...")
    
    # Yedek rotasyon scripti
    rotation_script = """#!/bin/bash
# 30 gÃ¼nden eski domain yedeklerini sil
find /home/backup/domains -name "*.tar.gz" -mtime +30 -delete
# 30 gÃ¼nden eski DB yedeklerini sil  
find /home/backup/databases -name "*.sql" -mtime +30 -delete
echo "$(date): Backup rotation completed" >> /var/log/backup_rotation.log
"""
    
    script_path = "/usr/local/bin/backup_rotation.sh"
    Path(script_path).write_text(rotation_script, encoding="utf-8")
    run(f"chmod +x {script_path}", check=True)
    
    # Cron job ekle (haftalÄ±k)
    cron_add("0 4 * * 0 /usr/local/bin/backup_rotation.sh")
    
    print("Yedek rotasyonu kuruldu (30 gÃ¼nlÃ¼k).")


def setup_log_rotation():
    """Log rotasyonu kurulumu"""
    print("Log rotasyonu ayarlanÄ±yor...")
    
    # Logrotate konfigÃ¼rasyonu
    logrotate_config = """
/var/log/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 root root
}

/usr/local/lsws/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 644 lsadm lsadm
}
"""
    
    config_path = "/etc/logrotate.d/ispanel"
    Path(config_path).write_text(logrotate_config, encoding="utf-8")
    
    print("Log rotasyonu kuruldu.")


def optimize_kernel_parameters():
    """Kernel parametrelerini optimize et"""
    print("Kernel parametreleri optimize ediliyor...")
    
    # sysctl optimizasyonlarÄ±
    optimizations = {
        "net.core.rmem_max": "16777216",
        "net.core.wmem_max": "16777216",
        "net.ipv4.tcp_rmem": "4096 65536 16777216",
        "net.ipv4.tcp_wmem": "4096 65536 16777216",
        "net.core.netdev_max_backlog": "5000",
        "net.ipv4.tcp_congestion_control": "bbr",
        "vm.swappiness": "10",
        "vm.dirty_ratio": "15",
        "vm.dirty_background_ratio": "5"
    }
    
    sysctl_config = ""
    for param, value in optimizations.items():
        sysctl_config += f"{param} = {value}\n"
        # GeÃ§ici olarak uygula
        run(f"sysctl -w {param}={value}", check=False)
    
    # KalÄ±cÄ± konfigÃ¼rasyon
    Path("/etc/sysctl.d/99-ispanel.conf").write_text(sysctl_config, encoding="utf-8")
    
    print("Kernel parametreleri optimize edildi.")


def update_ispanel():
    """isPanel otomatik gÃ¼ncelleme"""
    print("isPanel gÃ¼ncelleniyor...")
    
    try:
        # Mevcut script yolunu al
        script_path = Path(__file__).resolve()
        script_dir = script_path.parent
        
        print("Git durumu kontrol ediliyor...")
        
        # Git repository kontrolÃ¼
        if not (script_dir / ".git").exists():
            print("Git repository bulunamadÄ±. Manuel gÃ¼ncelleme gerekli.")
            return
        
        # Mevcut branch'i kontrol et
        result = run("git branch --show-current", check=False)
        current_branch = result.stdout.strip()
        print(f"Mevcut branch: {current_branch}")
        
        # Remote'dan son deÄŸiÅŸiklikleri Ã§ek
        print("GitHub'dan son deÄŸiÅŸiklikler Ã§ekiliyor...")
        run("git fetch origin", check=True)
        
        # Mevcut commit ile remote arasÄ±ndaki farkÄ± kontrol et
        result = run("git log HEAD..origin/main --oneline", check=False)
        if result.stdout.strip():
            print("Yeni gÃ¼ncellemeler bulundu:")
            print(result.stdout.strip())
            
            # KullanÄ±cÄ±dan onay al
            confirm = input("GÃ¼ncellemeyi uygulamak istiyor musunuz? (y/N): ").strip().lower()
            if confirm in ['y', 'yes', 'evet']:
                print("GÃ¼ncelleme uygulanÄ±yor...")
                
                # Backup oluÅŸtur
                backup_path = f"/tmp/ispanel_backup_{int(time.time())}.py"
                run(f"cp {script_path} {backup_path}", check=False)
                print(f"Yedek oluÅŸturuldu: {backup_path}")
                
                # Pull yap
                run("git pull origin main", check=True)
                
                # Bozuk symlink'i temizle ve yeniden oluÅŸtur
                print("Symlink dÃ¼zeltiliyor...")
                run("rm -f /usr/local/bin/ispanel", check=False)
                install_symlink()
                
                print("âœ… isPanel baÅŸarÄ±yla gÃ¼ncellendi!")
                print("DeÄŸiÅŸiklikler:")
                print(result.stdout.strip())
                print("\nArtÄ±k 'ispanel' komutu Ã§alÄ±ÅŸacak!")
                
                # Yedek dosyasÄ±nÄ± sil
                run(f"rm -f {backup_path}", check=False)
                
            else:
                print("GÃ¼ncelleme iptal edildi.")
        else:
            print("âœ… isPanel zaten gÃ¼ncel!")
            
    except subprocess.CalledProcessError as e:
        print(f"GÃ¼ncelleme hatasÄ±: {e}")
        print("Manuel gÃ¼ncelleme gerekebilir.")
    except Exception as e:
        print(f"Beklenmeyen hata: {e}")


def system_management_menu():
    """Sistem yÃ¶netimi menÃ¼sÃ¼"""
    while True:
        print("\n--- Sistem YÃ¶netimi ---")
        print("1) Sistem paketlerini gÃ¼ncelle")
        print("2) Yedek rotasyonu kur")
        print("3) Log rotasyonu kur")
        print("4) Kernel parametrelerini optimize et")
        print("5) Sistem durumu")
        print("6) Disk kullanÄ±mÄ±")
        print("7) ispanel komutunu onar (/usr/local/bin/ispanel)")
        print("0) Geri")
        sub = input("SeÃ§im: ").strip()
        if sub == "1":
            auto_update_system()
        elif sub == "2":
            setup_backup_rotation()
        elif sub == "3":
            setup_log_rotation()
        elif sub == "4":
            optimize_kernel_parameters()
        elif sub == "5":
            run("systemctl status lsws mariadb redis-server memcached", check=False)
        elif sub == "6":
            run("df -h", check=False)
        elif sub == "7":
            install_symlink()
        elif sub == "0":
            break
        else:
            print("GeÃ§ersiz seÃ§im")


def main():
    parser = argparse.ArgumentParser(description="SSH tabanlÄ± mini panel (Ubuntu 22+)")
    sub = parser.add_subparsers(dest="cmd")

    p_install = sub.add_parser("install", help="OpenLiteSpeed, PHP 8.2 ve MariaDB kur")
    p_install.set_defaults(func=cmd_install)

    p_dadd = sub.add_parser("domain-add", help="Domain ekle")
    p_dadd.add_argument("domain")
    def _dadd(args):
        require_root()
        domain_add(args.domain)
    p_dadd.set_defaults(func=_dadd)

    p_drm = sub.add_parser("domain-rm", help="Domain sil")
    p_drm.add_argument("domain")
    def _drm(args):
        require_root()
        domain_remove(args.domain)
    p_drm.set_defaults(func=_drm)

    p_dbcreate = sub.add_parser("db-create", help="MariaDB veritabanÄ± ve kullanÄ±cÄ± oluÅŸtur")
    p_dbcreate.add_argument("db")
    p_dbcreate.add_argument("user")
    p_dbcreate.add_argument("password")
    def _dbcreate(args):
        require_root()
        db_create(args.db, args.user, args.password)
    p_dbcreate.set_defaults(func=_dbcreate)

    p_dbdelete = sub.add_parser("db-delete", help="MariaDB veritabanÄ± ve kullanÄ±cÄ± sil")
    p_dbdelete.add_argument("db")
    p_dbdelete.add_argument("user")
    def _dbdelete(args):
        require_root()
        db_delete(args.db, args.user)
    p_dbdelete.set_defaults(func=_dbdelete)

    # EtkileÅŸimli menÃ¼
    p_menu = sub.add_parser("menu", help="Ä°nteraktif menÃ¼yÃ¼ baÅŸlat")
    def _menu(args):
        require_root()
        interactive_menu()
    p_menu.set_defaults(func=_menu)

    args = parser.parse_args()
    if not hasattr(args, "func"):
        # VarsayÄ±lan olarak menÃ¼yÃ¼ aÃ§
        if os.geteuid() == 0:
            interactive_menu()
            return
        else:
            parser.print_help()
            sys.exit(1)
    args.func(args)


if __name__ == "__main__":
    main()


